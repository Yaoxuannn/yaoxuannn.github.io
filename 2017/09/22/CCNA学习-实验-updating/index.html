<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="在学习完CCNA前都一直更新, 这份文档的创建时间是17-09-15, 每次更新都将会直接更新文档时间以用于置顶. 另外,这篇文档主要用来记录一些CCNA相关的思科IOS的操作和命令. ( 毕竟我不是学网工的,所以里面的一些看法可能不是很准确 ). 实验的主要参考资料:  CCNA学习指南(7th), 以及乾颐堂CCNA3.0的视频.">
<meta property="og:type" content="article">
<meta property="og:title" content="CCNA学习&amp;实验-[完结]">
<meta property="og:url" content="https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/index.html">
<meta property="og:site_name" content="Yaoxuannn&#39;s Blog">
<meta property="og:description" content="在学习完CCNA前都一直更新, 这份文档的创建时间是17-09-15, 每次更新都将会直接更新文档时间以用于置顶. 另外,这篇文档主要用来记录一些CCNA相关的思科IOS的操作和命令. ( 毕竟我不是学网工的,所以里面的一些看法可能不是很准确 ). 实验的主要参考资料:  CCNA学习指南(7th), 以及乾颐堂CCNA3.0的视频.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/ping1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/mac2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/subnet2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/subnet2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/route2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/route4.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/route6.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/route6.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan3.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5_1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5_2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp3.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/channel1.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vtp2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/hcrp.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan6_new.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/svi.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp4.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp3.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp%E4%B8%AD%E7%BB%A7.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/bgp2.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/odpf.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/rip.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/ppp.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/chap1.png">
<meta property="article:published_time" content="2017-09-23T02:47:04.000Z">
<meta property="article:modified_time" content="2020-11-30T01:27:02.000Z">
<meta property="article:author" content="Yaoxuan Wei">
<meta property="article:tag" content="CCNA">
<meta property="article:tag" content="Cisco IOS">
<meta property="article:tag" content="Network">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/ping1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CCNA学习&amp;实验-[完结]</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-09NWQ40K0B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-09NWQ40K0B');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2017/09/23/%E5%A5%97%E6%8E%A5%E5%AD%97%E5%9F%BA%E7%A1%80/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2017/09/13/OpenSSH%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&text=CCNA学习&amp;实验-[完结]"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&is_video=false&description=CCNA学习&amp;实验-[完结]"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CCNA学习&amp;实验-[完结]&body=Check out this article: https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&name=CCNA学习&amp;实验-[完结]&description=&lt;p&gt;在学习完CCNA前都一直更新, 这份文档的创建时间是17-09-15, 每次更新都将会直接更新文档时间以用于置顶. 另外,这篇文档主要用来记录一些CCNA相关的思科IOS的操作和命令. ( 毕竟我不是学网工的,所以里面的一些看法可能不是很准确 ). 实验的主要参考资料:  CCNA学习指南(7th), 以及乾颐堂CCNA3.0的视频.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&t=CCNA学习&amp;实验-[完结]"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">大实验环境介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E8%BF%9B%E5%85%A5IOS"><span class="toc-number">2.</span> <span class="toc-text">初次进入IOS.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%B6%E5%8C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">时间和时区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E7%9A%84Ping"><span class="toc-number">2.2.</span> <span class="toc-text">第一次的Ping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%BC%86"><span class="toc-number">2.3.</span> <span class="toc-text">配置远程管理虚拟线缆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E5%AE%9E%E9%AA%8C%E5%89%8D%E7%9A%84%E4%BF%9D%E5%AD%98"><span class="toc-number">2.4.</span> <span class="toc-text">结束实验前的保存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.5.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91"><span class="toc-number">3.</span> <span class="toc-text">局域网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%92%8C%E4%B8%BB%E6%9C%BA%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">路由和主机远程管理交换机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E7%BD%91%E4%B8%8E%E7%AE%80%E5%8D%95%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">4.</span> <span class="toc-text">子网与简单静态路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARP%E5%AE%9E%E9%AA%8C"><span class="toc-number">5.</span> <span class="toc-text">ARP实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1-amp-%E6%B5%AE%E5%8A%A8%E8%B7%AF%E7%94%B1"><span class="toc-number">6.</span> <span class="toc-text">静态路由&amp;浮动路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-number">7.</span> <span class="toc-text">路由规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN%E6%8A%80%E6%9C%AF"><span class="toc-number">8.</span> <span class="toc-text">VLAN技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%80%94%E4%BC%91%E6%81%AF"><span class="toc-number">9.</span> <span class="toc-text">中途休息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN-self"><span class="toc-number">10.</span> <span class="toc-text">VLAN-self</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#STP%E7%94%9F%E6%88%90%E6%A0%91"><span class="toc-number">11.</span> <span class="toc-text">STP生成树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%A0%91%E7%9A%84%E8%B0%83%E6%95%B4%E5%92%8C%E5%AE%9E%E6%96%BD"><span class="toc-number">12.</span> <span class="toc-text">生成树的调整和实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E9%80%9A%E9%81%93%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-number">13.</span> <span class="toc-text">以太通道的建立</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VTP%E5%8D%8F%E8%AE%AE-VLAN%E4%B8%AD%E7%BB%A7%E5%8D%8F%E8%AE%AE"><span class="toc-number">14.</span> <span class="toc-text">VTP协议-VLAN中继协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HCRP%E5%B0%8F%E5%AE%9E%E9%AA%8C"><span class="toc-number">15.</span> <span class="toc-text">HCRP小实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN%E9%97%B4%E8%B7%AF%E7%94%B1"><span class="toc-number">16.</span> <span class="toc-text">VLAN间路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SVI%E4%BA%A4%E6%8D%A2%E8%99%9A%E6%8B%9F%E6%8E%A5%E5%8F%A3"><span class="toc-number">17.</span> <span class="toc-text">SVI交换虚拟接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DHCP%E5%AE%9E%E7%8E%B0"><span class="toc-number">18.</span> <span class="toc-text">DHCP实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BGP"><span class="toc-number">19.</span> <span class="toc-text">BGP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OSPF"><span class="toc-number">20.</span> <span class="toc-text">OSPF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RIP"><span class="toc-number">21.</span> <span class="toc-text">RIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAP%E8%AE%A4%E8%AF%81"><span class="toc-number">22.</span> <span class="toc-text">PAP认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CHAP"><span class="toc-number">23.</span> <span class="toc-text">CHAP</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CCNA学习&amp;实验-[完结]
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Yaoxuan Wei</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-09-23T02:47:04.000Z" class="dt-published" itemprop="datePublished">2017-09-22</time>
        
        (Updated: <time datetime="2020-11-30T01:27:02.000Z" class="dt-updated" itemprop="dateModified">2020-11-29</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CCNA/" rel="tag">CCNA</a>, <a class="p-category" href="/tags/Cisco-IOS/" rel="tag">Cisco IOS</a>, <a class="p-category" href="/tags/Network/" rel="tag">Network</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>在学习完CCNA前都一直更新, 这份文档的创建时间是17-09-15, 每次更新都将会直接更新文档时间以用于置顶. 另外,这篇文档主要用来记录一些CCNA相关的思科IOS的操作和命令. ( 毕竟我不是学网工的,所以里面的一些看法可能不是很准确 ). 实验的主要参考资料:  CCNA学习指南(7th), 以及乾颐堂CCNA3.0的视频.</p>
<span id="more"></span>

<h2 id="大实验环境介绍"><a href="#大实验环境介绍" class="headerlink" title="大实验环境介绍"></a>大实验环境介绍</h2><p>啊, 提到这个实验环境我真的快要疯掉了. 首先先说昨天晚上我一个人在实验室瞎JB搞了几个小时, 终于把GNS3搞好了 ( 你们这个不行啊, 难道就不能配一个一体化的环境?? ) 接着又因为那个蠢CiscoIOU的license搞得焦头烂额. 为什么这个许可文件不能跟着GNS3一起打包啊, 混蛋. 所以又在GayHub上面找到了一个使用Python写的生成器. 最后才解决了这个问题.</p>
<p><strong>来自未来的补充: 不知道当时的我怎么这么憨…这东西一点也不麻烦啊…</strong></p>
<p>接着终于配置好了. 你们这个也太吃CPU和内存了吧. 我只是放了三台设备, 连拓扑都没, 光开个机虚拟机的CPU就已经飙到100了, 学习体验极差 (&#x2F;滑稽)  — [虽然如此,不过本人最后还是使用的GNS3…不折腾了]</p>
<h2 id="初次进入IOS"><a href="#初次进入IOS" class="headerlink" title="初次进入IOS."></a>初次进入IOS.</h2><p>IOS好像都是使用telnet进行的远程连接, 不明白为啥我每次进去都已经是特权模式了, 所谓特权模式其实就有点像sudo的感觉, 命令提示符是井字号**#** 而一般的模式是右尖号**&gt;**. 进入和退出特权模式的指令是<code>enable</code>和<code>disable</code>. 接着先来进行时间和时区的修改吧.</p>
<h3 id="时间和时区"><a href="#时间和时区" class="headerlink" title="时间和时区"></a>时间和时区</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch&gt;</span><br><span class="line">Branch&gt;<span class="built_in">enable</span></span><br><span class="line">Password:</span><br><span class="line">Branch<span class="comment">#show clock</span></span><br><span class="line">16:00:51.683 UTC Fri Nov 21 1997</span><br></pre></td></tr></table></figure>

<p>时间完全不对啊, 我们<strong>先来进行时区的修改</strong>, 因为即使你把时间调整正确了, 但是时区不对那当你进行时区调整的时候时间就又发生变化了.</p>
<p>首先我们进入配置终端的模式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#configure terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#clock timezone BJS +8</span></span><br><span class="line">Nov 21 16:03:33.660: %SYS-6-CLOCKUPDATE: System clock has been updated from 16:03:33 UTC Fri Nov 21 1997 to 00:03:33 BJS Sat Nov 22 1997, configured from console by console.</span><br><span class="line">Branch(config)<span class="comment">#end</span></span><br><span class="line">Nov 21 16:03:57.150: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#show clock</span></span><br><span class="line">00:04:03.333 BJS Sat Nov 22 1997</span><br></pre></td></tr></table></figure>

<p>OK, 接下来来进行时间的调整吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#clock set 13:28:00 15 Sep 2017</span></span><br><span class="line">Sep 15 05:28:00.000: %SYS-6-CLOCKUPDATE: System clock has been updated from 00:04:52 BJS Sat Nov 22 1997 to 13:28:00 BJS Fri Sep 15 2017, configured from console by console.</span><br><span class="line">Branch<span class="comment">#show clock</span></span><br><span class="line">13:28:06.507 BJS Fri Sep 15 2017</span><br></pre></td></tr></table></figure>

<p>这样就完成了时区的调整.</p>
<h3 id="第一次的Ping"><a href="#第一次的Ping" class="headerlink" title="第一次的Ping"></a>第一次的Ping</h3><p>实验拓扑: (两台三层路由, 都通过Ethernet0&#x2F;1接口进行连接)</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/ping1.png" alt="ping1"></p>
<p>要做的事情很简单, 打开接口, 设置IP, Ping!</p>
<p>首先打开HQ的终端:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#configure terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#interface e0/1</span></span><br><span class="line">HQ(config-if)<span class="comment">#no shutdown</span></span><br><span class="line">*Sep 15 05:39:15.873: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 15 05:39:16.877: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip address 192.168.1.2 255.255.255.0</span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br><span class="line">*Sep 15 05:39:32.875: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于这里的end, 和exit是有区别的, 其中exit可以理解成是返回上级, 而end则是直接退出config菜单.</p>
</blockquote>
<p>接着进入Branch的终端, 执行一样的命令但是将IP设置成192.168.1.1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Branch(config-if)<span class="comment">#ip address 192.168.1.1 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<p>这样就行了, 开始Ping吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.2</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>HQ这边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#ping 192.168.1.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 4/5/6 ms</span><br></pre></td></tr></table></figure>

<p>其中 <strong>!</strong> 表示通, 而 <strong>.</strong> 表示不通.</p>
<p>这里补充一个<strong>更改主机名</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#configure terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#hostname HQ</span></span><br><span class="line">HQ(config)<span class="comment">#hostname Test</span></span><br><span class="line">Test(config)<span class="comment">#hostname HQ</span></span><br><span class="line">HQ(config)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>另外<strong>设立密码</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#configure terminal</span></span><br><span class="line">HQ(config)<span class="comment">#enable password justin</span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">*Sep 15 09:42:58.855: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#disable</span></span><br><span class="line">HQ&gt;<span class="built_in">enable</span></span><br><span class="line">Password: <span class="comment"># 输错</span></span><br><span class="line">Password: <span class="comment"># 输错again</span></span><br><span class="line">Password:</span><br><span class="line">HQ<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>设置加密密码</strong>:</p>
<p>在较旧的机器上, 这个选项可能不会起作用, password是指明文密码, 而加密的密码是secret, 设置方法如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#enable password justin</span></span><br><span class="line">HQ(config)<span class="comment">#enable secret justin</span></span><br><span class="line">The <span class="built_in">enable</span> secret you have chosen is the same as your <span class="built_in">enable</span> password.</span><br><span class="line">This is not recommended.  Re-enter the <span class="built_in">enable</span> secret.</span><br><span class="line"></span><br><span class="line">HQ(config)<span class="comment">#enable secret bieber</span></span><br><span class="line">HQ(config)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="配置远程管理虚拟线缆"><a href="#配置远程管理虚拟线缆" class="headerlink" title="配置远程管理虚拟线缆"></a>配置远程管理虚拟线缆</h3><p>我们在Branch端进行设置, 接着通过HQ端进行连接 (他们已经是能够Ping通的了)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#configure terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#line vty 4</span></span><br><span class="line">Branch(config-line)<span class="comment">#password justin</span></span><br><span class="line">Branch(config-line)<span class="comment">#transport input all</span></span><br><span class="line">Branch(config-line)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">Sep 15 10:28:11.083: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>接着转到HQ端:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#telnet 192.168.1.1</span></span><br><span class="line">Trying 192.168.1.1 ... Open</span><br><span class="line"></span><br><span class="line">User Access Verification</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Branch&gt;</span><br><span class="line">Branch&gt;show tcp brief</span><br><span class="line">TCB       Local Address               Foreign Address             (state)</span><br><span class="line">F5D0FE10  192.168.1.1.23             192.168.1.2.50223           ESTAB</span><br></pre></td></tr></table></figure>

<h3 id="结束实验前的保存"><a href="#结束实验前的保存" class="headerlink" title="结束实验前的保存"></a>结束实验前的保存</h3><p>正常情况下, 我们正在运行的配置是保存在RAM中的, 所以为了在下一次的时候仍然保留现在运行的配置就是要进行保存, 那么, 保存到哪里呢? 也就是非易失性存储器(NVRAM).  </p>
<p>可以使用<code>show XX-config</code>来查看各个配置的情况.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show running-config</span></span><br><span class="line">HQ<span class="comment">#show startup-config</span></span><br></pre></td></tr></table></figure>

<p>如果先要进行保存, 可以直接进行<code>write</code>操作, 或者使用<code>copy</code>将<code>running-config</code>拷贝到<code>startup-config</code>. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show clock</span></span><br><span class="line">*18:38:16.862 BJS Fri Sep 15 2017</span><br><span class="line">HQ<span class="comment">#configure terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 15 10:38:36.749: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#show running-config</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 1991 bytes</span><br><span class="line">!</span><br><span class="line">! Last configuration change at 18:38:36 BJS Fri Sep 15 2017</span><br><span class="line">!</span><br><span class="line">HQ<span class="comment">#show startup-config</span></span><br><span class="line">Using 1991 out of 32768 bytes</span><br><span class="line">!</span><br><span class="line">! Last configuration change at 18:37:44 BJS Fri Sep 15 2017</span><br><span class="line">!</span><br><span class="line">HQ<span class="comment">#write</span></span><br><span class="line">Building configuration...</span><br><span class="line">[OK]</span><br><span class="line">HQ<span class="comment">#show startup-config</span></span><br><span class="line">Using 1991 out of 32768 bytes</span><br><span class="line">!</span><br><span class="line">! Last configuration change at 18:38:36 BJS Fri Sep 15 2017</span><br><span class="line">!</span><br></pre></td></tr></table></figure>

<p>实验时间是18:38, 我们强制写入running-config, 查看时间18:38没问题 ,但是这个时候我们的startup-config就过时了(18:37).执行写入命令, 查看startup-confiig时间, 已被更新.</p>
<p>事实上, 我们也可以使用<code>copy</code>来进行有方向的拷贝.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#copy running-config startup-config</span></span><br></pre></td></tr></table></figure>

<p>如果要擦除所有的配置文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#write erase</span></span><br><span class="line">Erasing the nvram filesystem will remove all configuration files! Continue? [confirm]</span><br><span class="line">[OK]</span><br><span class="line">Erase of nvram: complete</span><br><span class="line">*Sep 15 10:52:17.132: %SYS-7-NV_BLOCK_INIT: Initialized the geometry of nvram</span><br><span class="line">HQ<span class="comment">#show startup-config</span></span><br><span class="line">startup-config is not present</span><br></pre></td></tr></table></figure>

<p>接着重启设备的命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#reload</span></span><br><span class="line">Proceed with reload? [confirm]</span><br><span class="line"></span><br><span class="line">*Sep 15 10:53:59.786: %SYS-5-RELOAD: Reload requested by console. Reload Reason: Reload Command.</span><br><span class="line">unix_reload()</span><br></pre></td></tr></table></figure>

<p>如果这个时候你没有进行保存:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#reload</span></span><br><span class="line"></span><br><span class="line">System configuration has been modified. Save? [<span class="built_in">yes</span>/no]:</span><br></pre></td></tr></table></figure>

<p>这个问题的其实就是问你是否进行保存. 看自己了吧.</p>
<blockquote>
<p>IOS的中断测试很奇怪, 是<code>CTRL+SHIFT+6</code> 而<code>CTRL+C</code>是指退出到特权模式. </p>
</blockquote>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><strong>设置旗标</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#config terminal</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#banner motd X This is my HQ router! X # 第一种方法</span></span><br><span class="line">HQ(config)<span class="comment">#banner motd X # 第二种方法</span></span><br><span class="line">Enter TEXT message.  End with the character <span class="string">&#x27;X&#x27;</span>.</span><br><span class="line">This is my HQ router!</span><br><span class="line">X</span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 02:22:51.397: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#logout</span></span><br><span class="line"><span class="comment"># 当再次建立连接的时候:</span></span><br><span class="line">HQ con0 is now available</span><br><span class="line"></span><br><span class="line">Press RETURN to get started.</span><br><span class="line"></span><br><span class="line">This is my HQ router!</span><br><span class="line"></span><br><span class="line">HQ<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<p><strong>历史</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show history</span></span><br><span class="line">  ping 192.168.1.1</span><br><span class="line">  ping 192.168.1.2</span><br><span class="line">  ping 192.168.1.3</span><br><span class="line">  show <span class="built_in">history</span></span><br><span class="line">HQ<span class="comment">#terminal history size 100</span></span><br></pre></td></tr></table></figure>

<p><strong>终端长度</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#terminal length ?</span></span><br><span class="line">  &lt;0-512&gt;  Number of lines on screen (0 <span class="keyword">for</span> no pausing)</span><br></pre></td></tr></table></figure>

<p><strong>管道</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show history | include show # 包含show的</span></span><br><span class="line">  show <span class="built_in">history</span></span><br><span class="line">  show <span class="built_in">history</span></span><br><span class="line">  show <span class="built_in">history</span></span><br><span class="line">  show <span class="built_in">history</span> | include show</span><br><span class="line">HQ<span class="comment">#show history | section conf # 显示所有和conf有关的</span></span><br><span class="line">  configure</span><br><span class="line">  configure</span><br><span class="line">  configure terminal</span><br><span class="line">  configure ter</span><br><span class="line">  show <span class="built_in">history</span> | section conf</span><br></pre></td></tr></table></figure>

<p><strong>密码加密</strong></p>
<p>什么意思? 我们刚刚不是使用了secret吗? 请看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show run</span></span><br><span class="line">...(omitted)</span><br><span class="line"><span class="built_in">enable</span> secret 5 $1$l86G<span class="variable">$JudkPOGyI5PrPlv0</span>/3zeI1</span><br><span class="line"><span class="built_in">enable</span> password justin</span><br><span class="line">...(omitted)</span><br><span class="line">line vty 0</span><br><span class="line"> password justin</span><br><span class="line"> login </span><br></pre></td></tr></table></figure>

<p>除了我们设置的secret是加了密的, 其他都是明文, 这太危险了 其实只需要一条命令就能解决这种现象:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#service password-encryption </span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#show run</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">enable</span> secret 5 $1$l86G<span class="variable">$JudkPOGyI5PrPlv0</span>/3zeI1</span><br><span class="line"><span class="built_in">enable</span> password 7 0501131C354540</span><br><span class="line">...</span><br><span class="line">line vty 0</span><br><span class="line"> password 7 0705345F5A0017</span><br><span class="line"> login</span><br></pre></td></tr></table></figure>

<h2 id="局域网"><a href="#局域网" class="headerlink" title="局域网"></a>局域网</h2><p>查看MAC表: (仅用于交换机[或者说二层设备, 并且这个MAC表是只有二层设备才具有的.])</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Switch<span class="comment">#show mac address-table</span></span><br><span class="line">          Mac Address Table</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line">Vlan    Mac Address       Type        Ports</span><br><span class="line">----    -----------       --------    -----</span><br></pre></td></tr></table></figure>

<p>那么MAC地址表是怎么形成的呢? 默认情况下是通过自动学习(dynamic, 当交换机转发或泛洪以太网帧的时候从源字段提取MAC地址和接口的关联), 另外还有静态的方式.</p>
<h3 id="路由和主机远程管理交换机"><a href="#路由和主机远程管理交换机" class="headerlink" title="路由和主机远程管理交换机"></a>路由和主机远程管理交换机</h3><p>实验拓扑: </p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/mac2.png" alt="拓扑"></p>
<p>说明: 这个实验中PC1和Branch其实是同一个设备(但这并不影响我们进行实验, 因为他们都属于数据终端设备, 而交换机属于数据通信设备), 但是PC1我们关闭了路由功能, 而Branch是开启了路由的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PC1(config)<span class="comment">#no ip routing</span></span><br><span class="line">PC1(config)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>另外, 我们打开交换机的路由转发:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#ip routing </span></span><br></pre></td></tr></table></figure>

<p>下面开始进行环境设置: </p>
<p>路由器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf terminal </span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#interface e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#no shu</span></span><br><span class="line">*Sep 16 07:50:30.459: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 16 07:50:31.468: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#ip address 10.1.10.254 255.255.255.0</span></span><br><span class="line">Branch(config-if)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 16 07:50:55.772: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>主机:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">PC1(config)<span class="comment">#interface e0/1 </span></span><br><span class="line">PC1(config-if)<span class="comment">#no shu </span></span><br><span class="line">*Sep 16 07:51:38.765: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 16 07:51:39.774: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">PC1(config-if)<span class="comment">#ip address 10.1.10.100 255.255.255.0</span></span><br><span class="line">PC1(config-if)<span class="comment">#exi</span></span><br><span class="line">PC1(config)<span class="comment">#ip default-gateway 10.1.10.254</span></span><br></pre></td></tr></table></figure>

<p>交换机:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先我们查看一下MAC地址表, 后面的小彩蛋会用到</span></span><br><span class="line">SW1<span class="comment">#show mac address-table </span></span><br><span class="line">          Mac Address Table</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line">Vlan    Mac Address       Type        Ports</span><br><span class="line">----    -----------       --------    -----</span><br><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#interface vlan 1</span></span><br><span class="line">SW1(config-if)<span class="comment">#no shut</span></span><br><span class="line">SW1(config-if)<span class="comment">#ip address </span></span><br><span class="line">*Sep 16 07:57:12.448: %LINK-3-UPDOWN: Interface Vlan1, changed state to up</span><br><span class="line">*Sep 16 07:57:13.450: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan1, changed state to up</span><br><span class="line">SW1(config-if)<span class="comment">#ip address 10.1.10.99 255.255.255.0</span></span><br><span class="line">SW1(config-if)<span class="comment">#exi</span></span><br><span class="line">SW1(config)<span class="comment">#ip default-gateway 10.1.10.254</span></span><br><span class="line">SW1(config)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 16 07:57:50.319: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>Ping测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#ping 10.1.10.254</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.254, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 5/5/6 ms</span><br><span class="line">SW1<span class="comment">#ping 10.1.10.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 2/4/5 ms</span><br></pre></td></tr></table></figure>

<p>成功, 接下来进行远程telnet:</p>
<p>主机:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#telnet 10.1.10.99</span></span><br><span class="line">Trying 10.1.10.99 ... Open</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Password required, but none <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">[Connection to 10.1.10.99 closed by foreign host]</span><br></pre></td></tr></table></figure>

<p>出现了问题. 原来是虚拟线缆的密码没有设置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#line vty 0 4</span></span><br><span class="line">SW1(config-line)<span class="comment">#password justin</span></span><br><span class="line">SW1(config-line)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 16 08:04:17.977: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>再次尝试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#telnet 10.1.10.99</span></span><br><span class="line">Trying 10.1.10.99 ... Open</span><br><span class="line"></span><br><span class="line">User Access Verification</span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line">SW1&gt;</span><br></pre></td></tr></table></figure>

<p>使用路由器也能够进行远程管理. 实验结束.</p>
<p>小彩蛋:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#show mac address-table </span></span><br><span class="line">          Mac Address Table</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line">Vlan    Mac Address       Type        Ports</span><br><span class="line">----    -----------       --------    -----</span><br><span class="line">   1    aabb.cc00.0100    DYNAMIC     Et0/0</span><br><span class="line">   1    aabb.cc00.0410    DYNAMIC     Et0/1</span><br><span class="line">Total Mac Addresses <span class="keyword">for</span> this criterion: 2</span><br></pre></td></tr></table></figure>

<p>这个路由表就是在我们进行Ping测试的时候学习到的.</p>
<p>另外当你远程进入到了设备进行管理的时候, 你可能会发现设置时远端设备没有日志输出, 但是真正被操作的那台会有显示. 这一点也不好, 因为日志可以为我们提供大量有用的信息, 怎么开启呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>另外一边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*Sep 17 03:58:42.057: %SYS-5-CONFIG_I: Configured from console by vty0 (10.1.10.254)</span><br></pre></td></tr></table></figure>

<p>现在我们开启:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#terminal monitor </span></span><br><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 17 03:59:31.949: %SYS-5-CONFIG_I: Configured from console by vty0 (10.1.10.254)</span><br></pre></td></tr></table></figure>

<h2 id="子网与简单静态路由"><a href="#子网与简单静态路由" class="headerlink" title="子网与简单静态路由"></a>子网与简单静态路由</h2><p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/subnet2.png" alt="subnet2"></p>
<p>和上面一样, 还是先进行IP地址和接口的配置:</p>
<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inte e0/1</span></span><br><span class="line">HQ(config-if)<span class="comment">#no shut</span></span><br><span class="line">*Sep 17 03:17:47.514: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 17 03:17:48.519: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip address 192.168.1.1 255.255.255.0 </span></span><br><span class="line">HQ(config-if)<span class="comment">#exi</span></span><br><span class="line">HQ(config)<span class="comment">#inter e0/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#no shut </span></span><br><span class="line">*Sep 17 03:18:13.821: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 17 03:18:14.827: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip address 10.1.10.23 255.255.255.240 </span></span><br><span class="line">HQ(config-if)<span class="comment">#end                </span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 03:19:13.905: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#inter e0/1</span></span><br><span class="line">Branch(config-if)<span class="comment">#no shut</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip address 192.1</span></span><br><span class="line">*Sep 17 03:20:51.347: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 17 03:20:52.349: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#ip address 192.168.1.2 255.255.255.252</span></span><br><span class="line">Branch(config-if)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#inter e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip address 172.16.1.100 255.255.255.248</span></span><br><span class="line">Branch(config-if)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 03:22:30.740: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>在进行ping测试之前, 先来观察一下双方的路由表:</p>
<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show ip rou</span></span><br><span class="line">...(omitted)</span><br><span class="line">      10.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        10.1.10.16/28 is directly connected, Ethernet0/0</span><br><span class="line">L        10.1.10.23/32 is directly connected, Ethernet0/0</span><br><span class="line">      192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.1.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.1.1/32 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#show ip rou</span></span><br><span class="line">...(omitted)</span><br><span class="line">      172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        172.16.1.96/29 is directly connected, Ethernet0/0</span><br><span class="line">L        172.16.1.100/32 is directly connected, Ethernet0/0</span><br><span class="line">      192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.1.0/30 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.1.2/32 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>那么, 问题来了, 两台路由器现在可以直接进行通信吗?</p>
<p>我们来测试一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#ping 192.168.1.2 source e0/1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">Packet sent with a <span class="built_in">source</span> address of 192.168.1.1 </span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/5 m</span><br></pre></td></tr></table></figure>

<p>另外一边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.1 source e0/1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">Packet sent with a <span class="built_in">source</span> address of 192.168.1.2 </span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/5 ms</span><br></pre></td></tr></table></figure>

<p>尽管他们的子网掩码不同仍然没有问题, 但是双方的e0&#x2F;0(这才是我们所需要的)不能够进行通信, 为了能够使他们通信, 我们可以考虑进行手动增加一条静态路由:</p>
<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#ip route 172.16.1.96 255.255.255.248 e0/1 </span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 03:33:43.157: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#ping 172.16.1.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 6/6/6 ms</span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip route 10.1.10.16 255.255.255.240 e0/1</span></span><br><span class="line">Branch(config)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 03:36:40.131: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#ping 10.1.10.23            </span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.23, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 5/6/8 ms</span><br></pre></td></tr></table></figure>

<p>现在我们再来观察一下他们的路由:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show ip route </span></span><br><span class="line">...(omitted)</span><br><span class="line">      10.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        10.1.10.16/28 is directly connected, Ethernet0/0</span><br><span class="line">L        10.1.10.23/32 is directly connected, Ethernet0/0</span><br><span class="line">      172.16.0.0/29 is subnetted, 1 subnets</span><br><span class="line">S        172.16.1.96 is directly connected, Ethernet0/1</span><br><span class="line">      192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.1.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.1.1/32 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>其中S就是指该路由为静态路由:</p>
<p>也可以直接指明:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#show ip route static </span></span><br><span class="line">...(omitted)</span><br><span class="line">      10.0.0.0/28 is subnetted, 1 subnets</span><br><span class="line">S        10.1.10.16 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>实验结束.</p>
<p>附赠大礼包:</p>
<p><strong>报文与分片</strong></p>
<p>默认的MTU是1500, 我们可以通过查看接口来获得值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#show inter e0/1</span></span><br><span class="line">Ethernet0/1 is up, line protocol is up </span><br><span class="line">  Hardware is AmdP2, address is aabb.cc00.0110 (bia aabb.cc00.0110)</span><br><span class="line">  Internet address is 192.168.1.1/24</span><br><span class="line">  MTU 1500 bytes, BW 10000 Kbit/sec, DLY 1000 usec, </span><br><span class="line">  ...(omitted)</span><br></pre></td></tr></table></figure>

<p>另外我们的Branch也是这样:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#show inter e0/1</span></span><br><span class="line">Ethernet0/1 is up, line protocol is up </span><br><span class="line">  Hardware is AmdP2, address is aabb.cc00.0310 (bia aabb.cc00.0310)</span><br><span class="line">  Internet address is 192.168.1.2/24</span><br><span class="line">  MTU 1500 bytes, BW 10000 Kbit/sec, DLY 1000 usec,</span><br><span class="line">  ...(omitted)</span><br></pre></td></tr></table></figure>

<p>接下来还是进行熟悉的Ping操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.1 df-bit </span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">Packet sent with the DF bit <span class="built_in">set</span></span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>这里添加了一个限定参数, df-bit在命令执行的输出中我们也可以看到有DF的字样, 什么玩意呢这是, DF就是Don’t fragment的意思啦, 也就是不要进行分片. 从上述的结果看不出来什么, 因为发送的报文大小是100bytes, 现在我们发送&gt;1500的报文:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.1 df-bit size 1501</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 1501-byte ICMP Echos to 192.168.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">Packet sent with the DF bit <span class="built_in">set</span></span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>发不过去了.  移除DF标志位:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.1 size 1501       </span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 1501-byte ICMP Echos to 192.168.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>顺利发送.</p>
<p>玩上瘾了, 再来一个子网广播小实验:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#ping 192.168.1.255</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.255, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line"></span><br><span class="line">Reply to request 0 from 192.168.1.2, 6 ms</span><br><span class="line">Reply to request 1 from 192.168.1.2, 5 ms</span><br><span class="line">Reply to request 2 from 192.168.1.2, 5 ms</span><br><span class="line">Reply to request 3 from 192.168.1.2, 5 ms</span><br></pre></td></tr></table></figure>

<p>嘿嘿, 收到了Branch的回信, 接着在试试Branch的那一端:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.155</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.155, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>咦? 没有人回应? 还记得上面我们特意把他们的子网掩码设置的不同吗, 所以这里的Branch的广播地址应该是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 192.168.1.3</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.3, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line"></span><br><span class="line">Reply to request 0 from 192.168.1.1, 4 ms</span><br><span class="line">Reply to request 1 from 192.168.1.1, 5 ms</span><br><span class="line">Reply to request 2 from 192.168.1.1, 4 ms</span><br></pre></td></tr></table></figure>

<p>这就可以了.</p>
<h2 id="ARP实验"><a href="#ARP实验" class="headerlink" title="ARP实验"></a>ARP实验</h2><p>实验拓扑和上面一样:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/subnet2.png" alt="subnet2"></p>
<p>路由的配置保持不变, 现在我们再来实验. 首先我在HQ上做了一点手脚, 现在 先不说 我们再次来进行Ping测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#ping 172.16.1.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 1/4/5 ms</span><br></pre></td></tr></table></figure>

<p>是通的, 接着我们进行Branch的Ping测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 10.1.10.16</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.16, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>不同了, 但是HQ-&gt;Branch是通的啊. 现在我们查看一下Branch的ARP表:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh arp</span></span><br><span class="line">Protocol  Address          Age (min)  Hardware Addr   Type   Interface</span><br><span class="line">Internet  10.1.10.16              0   Incomplete      ARPA   </span><br><span class="line">Internet  172.16.1.100            -   aabb.cc00.0300  ARPA   Ethernet0/0</span><br><span class="line">Internet  192.168.1.1             1   aabb.cc00.0110  ARPA   Ethernet0/1</span><br><span class="line">Internet  192.168.1.2             -   aabb.cc00.0310  ARPA   Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>我们都知道ARP的作用是做MAC和IPADDR的转换, 尤其是当在这个试验中的直连路由中. 我们明明配置了静态路由, 但是依然没法Ping到10.1.10.16. 原因就出自HQ那一端: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#sh ip interface e0/1</span></span><br><span class="line">Ethernet0/1 is up, line protocol is up</span><br><span class="line">  Internet address is 192.168.1.1/24</span><br><span class="line">  ...(omitted)</span><br><span class="line">  Proxy ARP is disabled</span><br></pre></td></tr></table></figure>

<p>Proxy ARP被关闭了!这就是为什么Branch无法获得MAC地址, 我们的HQ不告诉他了. 这就是说 事实上路由包括两个部分: <strong>决策</strong>和<strong>执行</strong>. 光有路线还不行, 还需要有行动.</p>
<p>重新开启e0&#x2F;1接口的代理ARP, Branch就可以通信了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inter e0/1</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip proxy-arp </span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 10.1.10.16</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.16, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 5/5/5 ms</span><br></pre></td></tr></table></figure>

<p>注意: 第一个包绝对不会通. 另外, 如果你想要实现MAC INCOMLETE的效果, 首先要记得清空Branch的ARP缓存才行.</p>
<p>同样, 如果现在再次将HQ的代理ARP关闭, Ping测试的结果还是通的. 这就是因为Branch上有ARP的缓存 ( 这个缓存的老化时间特别长 ).</p>
<p>从这个实验也可以看出, 直接设置出接口的静态路由是有弊端的, 那么更好的方式其实是设置下一跳路由, 这样玩的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#no ip route 10.1.10.16 255.255.255.240</span></span><br></pre></td></tr></table></figure>

<p>先关闭路由, Ping不通现在. </p>
<p>接着重写路由, 但这次写成下一跳的形式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip route 10.1.10.16 255.255.255.240 192.168.1.1</span></span><br></pre></td></tr></table></figure>

<p>关闭HQ的代理ARP功能, 清空本地ARP缓存:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inter e0/1</span></span><br><span class="line">HQ(config-if)<span class="comment">#no ip proxy-arp </span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 08:38:08.122: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#clear ip arp 10.1.10.16</span></span><br><span class="line">Branch<span class="comment">#sh arp</span></span><br><span class="line">Protocol  Address          Age (min)  Hardware Addr   Type   Interface</span><br><span class="line">Internet  172.16.1.100            -   aabb.cc00.0300  ARPA   Ethernet0/0</span><br><span class="line">Internet  192.168.1.1            23   aabb.cc00.0110  ARPA   Ethernet0/1</span><br><span class="line">Internet  192.168.1.2             -   aabb.cc00.0310  ARPA   Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>激动人心的时候到了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 10.1.10.16</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.16, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/4/5 ms</span><br></pre></td></tr></table></figure>

<p>超级顺畅.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh arp</span></span><br><span class="line">Protocol  Address          Age (min)  Hardware Addr   Type   Interface</span><br><span class="line">Internet  172.16.1.100            -   aabb.cc00.0300  ARPA   Ethernet0/0</span><br><span class="line">Internet  192.168.1.1             0   aabb.cc00.0110  ARPA   Ethernet0/1</span><br><span class="line">Internet  192.168.1.2             -   aabb.cc00.0310  ARPA   Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>ARP解析项也没了, 所以这样的好处还有节约性能. </p>
<p>另外,为了保险, 其实可以接口和下一跳一起写的. 最后配置的结果就是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip route 10.1.10.16 255.255.255.240 e0/1 192.168.1.1</span></span><br><span class="line">Branch(config)<span class="comment">#do sh ip rou </span></span><br><span class="line">...(omitted)</span><br><span class="line">      10.0.0.0/28 is subnetted, 1 subnets</span><br><span class="line">S        10.1.10.16 [1/0] via 192.168.1.1, Ethernet0/1</span><br><span class="line">...(omitted)</span><br></pre></td></tr></table></figure>

<p><strong>别忘了先把之前的路由删除了啊.</strong> </p>
<h2 id="静态路由-amp-浮动路由"><a href="#静态路由-amp-浮动路由" class="headerlink" title="静态路由&amp;浮动路由"></a>静态路由&amp;浮动路由</h2><p><strong>默认路由实验</strong>:</p>
<p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/route2.png" alt="route1"></p>
<p>路由器配置就忽略了, 基本和上面的几个实验的配置没有什么区别.</p>
<p>现在我们在HQ写一个明细路由(也就是非默认路由).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#ip route 10.1.10.0 255.255.255.0 e0/1 192.168.1.1</span></span><br></pre></td></tr></table></figure>

<p>Check一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#sh ip rou</span></span><br><span class="line">...(omitted)</span><br><span class="line">      10.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">S        10.1.10.0 [1/0] via 192.168.1.1, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>接着给Branch配一个默认路由, 默认路由其实就是0.0.0.0&#x2F;0了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 e0/1</span></span><br><span class="line">%Default route without gateway, <span class="keyword">if</span> not a point-to-point interface, may impact performance</span><br><span class="line">Branch(config)<span class="comment">#no ip route 0.0.0.0 0.0.0.0 e0/1</span></span><br><span class="line">Branch(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 e0/1 192.168.1.2</span></span><br></pre></td></tr></table></figure>

<p>上面第一次的设置有警告了, 如果你不在一个点对点网络中, 这样做会影响性能.</p>
<p>当然了, 总不能所有的包都从一个出口出去了, 这样岂不是会把我们的Branch累死.</p>
<p>所以最好的方法就是综合设置下一跳和出接口.</p>
<p>配置完成了, 那么现在我们就来看一下路由表吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip ro</span></span><br><span class="line">S*    0.0.0.0/0 [1/0] via 192.168.1.2, Ethernet0/1</span><br><span class="line">      10.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br></pre></td></tr></table></figure>

<p>这个S*是什么呢? 这被称为候选默认路由.</p>
<p>从这个实验我们引出浮动路由的实验:</p>
<p><strong>静态默认路由和路由负载均衡的实验</strong></p>
<p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/route4.png" alt="route4"></p>
<p>( 妈呀, 画图累死了.</p>
<p>先按照实验拓扑中的状态进行配置.</p>
<p>我现在配置的越来越熟练了哈哈哈.</p>
<p>你可以参考下面的配置, 当然是建议自己动手啦~</p>
<p>PC1 [路由模拟]:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">PC1(config)<span class="comment">#inter e0/1</span></span><br><span class="line">PC1(config-if)<span class="comment">#no sh</span></span><br><span class="line">PC1(config-if)<span class="comment">#ip addr 10.1.</span></span><br><span class="line">*Sep 17 13:33:43.877: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 17 13:33:44.882: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">PC1(config-if)<span class="comment">#ip addr 10.1.10.100 255.255.255.0</span></span><br><span class="line">PC1(config-if)<span class="comment">#exi</span></span><br><span class="line">PC1(config)<span class="comment">#ip default-gateway 10.1.10.254              </span></span><br><span class="line">PC1(config)<span class="comment">#no ip routing</span></span><br><span class="line">PC1(config)<span class="comment">#end</span></span><br><span class="line">PC1<span class="comment">#</span></span><br><span class="line">*Sep 17 13:34:18.742: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#inter e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#no sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip address </span></span><br><span class="line">*Sep 17 13:36:02.132: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 17 13:36:03.139: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#ip address 10.1.10.254 255.255.255.0</span></span><br><span class="line">Branch(config-if)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#inte e0/1</span></span><br><span class="line">Branch(config-if)<span class="comment">#no sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip addre 1</span></span><br><span class="line">*Sep 17 13:36:24.959: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 17 13:36:25.965: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#ip addre 192.168.1.1 255.255.255.0</span></span><br><span class="line">Branch(config-if)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 e0/1 192.168.1.2</span></span><br><span class="line">Branch(config)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 13:36:36.208: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inte e0/1</span></span><br><span class="line">HQ(config-if)<span class="comment">#no sh</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip addr 192.168.1</span></span><br><span class="line">*Sep 17 13:37:21.008: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to up</span><br><span class="line">*Sep 17 13:37:22.013: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip addr 192.168.1.2 255.255.255.0</span></span><br><span class="line">HQ(config-if)<span class="comment">#exi</span></span><br><span class="line">HQ(config)<span class="comment">#inte e0/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#no sh</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip addr </span></span><br><span class="line">*Sep 17 13:37:33.536: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 17 13:37:34.537: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip addr 172.16.1.1 255.255.255.0</span></span><br><span class="line">HQ(config-if)<span class="comment">#exi</span></span><br><span class="line">HQ(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 e0/1 192.168.1.1</span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">*Sep 17 13:37:53.594: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>Server [路由模拟]:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Server<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Server(config)<span class="comment">#inte e0/0</span></span><br><span class="line">Server(config-if)<span class="comment">#no sh</span></span><br><span class="line">Server(config-if)<span class="comment">#ip address 172.1</span></span><br><span class="line">*Sep 17 13:38:18.541: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 17 13:38:19.547: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br><span class="line">Server(config-if)<span class="comment">#ip address 172.16.1.2 255.255.255.0</span></span><br><span class="line">Server(config-if)<span class="comment">#exi</span></span><br><span class="line">Server(config)<span class="comment">#no ip routing</span></span><br><span class="line">Server(config)<span class="comment">#ip default-gateway 172.16.1.1</span></span><br><span class="line">Server(config)<span class="comment">#end</span></span><br><span class="line">Server<span class="comment">#</span></span><br><span class="line">*Sep 17 13:38:54.270: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>进行Ping测试:</p>
<p>PC1 –&gt; Server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 172.16.1.2</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/2 ms</span><br></pre></td></tr></table></figure>

<p>Server –&gt; PC1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Server<span class="comment">#ping 10.1.10.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>

<p>OK, 他们可以通信了.</p>
<p>接着上面的来, 我们来实现路由表的负载均衡. 现在我们在Branch和HQ之间加上一根串行线:也就变成了这样</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/route6.png" alt="route6"></p>
<p>开始配置Branch和HQ之间的serial接口:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inter s2/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#no sh</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip address 200.</span></span><br><span class="line">*Sep 17 14:14:05.632: %LINK-3-UPDOWN: Interface Serial2/0, changed state to up</span><br><span class="line">*Sep 17 14:14:06.633: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ip address 200.202.100.2 255.255.255.0</span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#ping </span></span><br><span class="line">*Sep 17 14:14:15.225: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#ping 200.202.100.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 200.202.100.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 8/9/10 ms</span><br></pre></td></tr></table></figure>

<p>Branch同理.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter </span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 s2/0</span></span><br><span class="line">Branch(config)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 14:15:14.748: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>这一次就没有警告了, 看到没. 查看路由表, 就会看到有两个下一跳. 这就是<strong>路由表的负载均衡</strong> </p>
<p>并且, 检查arp表, 我们发现, 串行线路是不会有ARP记录的.</p>
<p><strong>浮动静态路由的实验</strong></p>
<p>所谓浮动路由, 其实就是管理距离(或者我们说叫优先级吧) , 如果我们吧刚刚设置的serial口的路由距离调的高一些, 就可以实现浮动路由, 也就是使这一条成为备份.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#ip route 0.0.0.0 0.0.0.0 s2/0 10</span></span><br><span class="line">Branch(config)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#sh i</span></span><br><span class="line">*Sep 17 14:23:15.496: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#sh ip rou</span></span><br><span class="line">S*    0.0.0.0/0 [1/0] via 192.168.1.2, Ethernet0/1</span><br><span class="line">      10.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        10.1.10.0/24 is directly connected, Ethernet0/0</span><br><span class="line">L        10.1.10.254/32 is directly connected, Ethernet0/0</span><br><span class="line">      192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.1.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.1.1/32 is directly connected, Ethernet0/1</span><br><span class="line">      200.202.100.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        200.202.100.0/24 is directly connected, Serial2/0</span><br><span class="line">L        200.202.100.1/32 is directly connected, Serial2/0</span><br><span class="line">Branch<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>看到没, 原本的哪一个默认路由已经看不到了. 测试一下吧:</p>
<p>首先先给HQ加上路由:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#ip route 10.1.10.0 255.255.255.0 s2/0</span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 14:25:26.060: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>接着, 关闭接口:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#inte e0/1 </span></span><br><span class="line">Branch(config-if)<span class="comment">#sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 14:26:19.050: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 17 14:26:20.541: %LINK-5-CHANGED: Interface Ethernet0/1, changed state to administratively down</span><br><span class="line">*Sep 17 14:26:21.545: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to down</span><br></pre></td></tr></table></figure>

<p>HQ同理: (这说一下, 在我看的视频中讲的是如果你关闭一端的接口, 那么另一端的接口会自动的断掉, 但是模拟器好像并不会做到这一点)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf te</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#inte e0/1 </span></span><br><span class="line">HQ(config-if)<span class="comment">#sh</span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 14:26:45.056: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 17 14:26:46.287: %LINK-5-CHANGED: Interface Ethernet0/1, changed state to administratively down</span><br><span class="line">*Sep 17 14:26:47.292: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to down</span><br></pre></td></tr></table></figure>

<p>现在再使用PC1去Ping Server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 172.16.1.2</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 9/9/10 ms</span><br></pre></td></tr></table></figure>

<p>Server也可和PC1正常通信.</p>
<p>这个时候查看路由表就可以看到s2&#x2F;0这一条了.</p>
<p>浮动路由实验结束.</p>
<p>小彩蛋:</p>
<p>这个时候如果你进行大量的Ping测试, 会明显看出速率的降低.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 172.16.1.2 repeat 100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 100, 100-byte ICMP Echos to 172.16.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">Success rate is 100 percent (100/100), round-trip min/avg/max = 1/1/6 ms</span><br><span class="line">-------关闭接口前后的分割线-----------</span><br><span class="line">PC1<span class="comment">#ping 172.16.1.2 repeat 100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 100, 100-byte ICMP Echos to 172.16.1.2, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">Success rate is 100 percent (100/100), round-trip min/avg/max = 6/9/12 ms</span><br></pre></td></tr></table></figure>



<h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><p><strong>最长匹配原则</strong></p>
<p>什么是最长匹配原则呢? 其实就是更精确的路由更优先走的意思了, 我们沿用上一次实验的拓扑来进行:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/route6.png" alt="route6"></p>
<p>在进行实验前, 我将之前关闭的接口重新打开, 接着将HQ的serial路由改成管理距离为10的备用路由. 也就是说现在的Branch和HQ的路由情况如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh run | s rou</span></span><br><span class="line">ip route 0.0.0.0 0.0.0.0 Ethernet0/1 192.168.1.2</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 Serial2/0 10</span><br></pre></td></tr></table></figure>

<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#sh run | s rou</span></span><br><span class="line">ip route 0.0.0.0 0.0.0.0 Ethernet0/1 192.168.1.1</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 Serial2/0 10</span><br></pre></td></tr></table></figure>

<p>那么现在我们调整Branch端的路由, 增加一条更精确的, 通往黑洞的路由:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip route 172.16.1.0 255.255.255.0 null0</span></span><br></pre></td></tr></table></figure>

<p>接着使用PC1尝试和服务器通信:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 172.16.1.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">UUUUU</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>目标不可达.</p>
<p>接着我们再给Branch增加一条更更精确的正确路由:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip route 172.16.1.1 255.255.255.255 e0/1 192.168.1.2</span></span><br><span class="line">Branch<span class="comment">#sh ip rou sta  </span></span><br><span class="line">S*    0.0.0.0/0 is directly connected, Ethernet0/1</span><br><span class="line">      172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">S        172.16.1.0/24 is directly connected, Null0</span><br><span class="line">S        172.16.1.1/32 [1/0] via 192.168.1.2, Ethernet0/1</span><br></pre></td></tr></table></figure>

<p>再试试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 172.16.1.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.1.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/2 ms</span><br></pre></td></tr></table></figure>

<p>通了, 这就是最长匹配原则.</p>
<h2 id="VLAN技术"><a href="#VLAN技术" class="headerlink" title="VLAN技术"></a>VLAN技术</h2><p>实验一: 简单vlan的配置, 初次尝试简单vlan划分</p>
<p>实验拓扑:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan1.png" alt="vlan1"></p>
<p>配置完成之后, 我们查看一下SW1当前的VLAN信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh vlan </span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0/0, Et0/1, Et0/2, Et0/3</span><br><span class="line">                                                Et1/0, Et1/1, Et1/2, Et1/3</span><br><span class="line">                                                Et2/0, Et2/1, Et2/2, Et2/3</span><br><span class="line">                                                Et3/0, Et3/1, Et3/2, Et3/3</span><br></pre></td></tr></table></figure>

<p>就是默认的配置, 所有的接口都从VLAN1走, 现在我们尝试创建两个VLAN:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#vlan 10</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#name 507a</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#vlan 20</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#name 507b</span></span><br></pre></td></tr></table></figure>

<p>接着划分VLAN(其实把接口划分到VLAN上):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#interface range e0/0 -1 </span></span><br><span class="line">SW1(config-if-range)<span class="comment">#switchport mode access</span></span><br><span class="line">SW1(config-if-range)<span class="comment">#switchport access vlan 10</span></span><br></pre></td></tr></table></figure>

<p>查看一下vlan10的信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh vlan id 10</span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">10   507a                             active    Et0/0, Et0/1</span><br><span class="line">....(omitted)</span><br></pre></td></tr></table></figure>

<p>测试一下数据包是否是通的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 10.1.10.254</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.254, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>实验二: access模式vlan, 交换机之间的vlan划分</p>
<p>这里使用的交换机都是三层交换机. 继续沿用我们上面的拓扑, 但是稍微升级一下:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan2.png" alt="vlan2"></p>
<p>这里省略PC2的配置, 因为和PC1几乎一样.</p>
<p>首先我们配置一下SW1的vlan20的模式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#int e0/2</span></span><br><span class="line">SW1(config-if)<span class="comment">#switchport mo acc</span></span><br><span class="line">SW1(config-if)<span class="comment">#switchport acc vlan 20 </span></span><br><span class="line">SW1(config-if)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 18 12:45:36.057: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>接着进入SW2进行相对应的配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW2(config)<span class="comment">#vlan 10</span></span><br><span class="line">SW2(config-vlan)<span class="comment">#name 507a</span></span><br><span class="line">SW2(config-vlan)<span class="comment">#</span></span><br><span class="line">*Sep 18 12:52:06.159: %CDP-4-NATIVE_VLAN_MISMATCH: Native VLAN mismatch discovered on Ethernet0/2 (1), with SW1 Ethernet0/2 (20).</span><br><span class="line">SW2(config-vlan)<span class="comment">#vlan 20</span></span><br><span class="line">SW2(config-vlan)<span class="comment">#name 507b</span></span><br></pre></td></tr></table></figure>

<p>这个时候你的SW2开始报错, 其实你的SW1也有报错, 这是说你的本征VLAN不匹配, 就是说你的SW1配置了access, 但是SW2没有.</p>
<p>那么现在就赶紧配置上吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW2(config)<span class="comment">#int e0/2</span></span><br><span class="line">SW2(config-if)<span class="comment">#switchport mo acc</span></span><br><span class="line">SW2(config-if)<span class="comment">#switchport acc vlan 20</span></span><br><span class="line">SW2(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>以及别忘了, 我们要把PC2也加入vlan20: [ 这里犯蠢了, 可以直接用range的. ]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW2(config)<span class="comment">#int e0/1</span></span><br><span class="line">SW2(config-if)<span class="comment">#swi</span></span><br><span class="line">SW2(config-if)<span class="comment">#switchport mode acc</span></span><br><span class="line">SW2(config-if)<span class="comment">#switchport acc vlan 20</span></span><br><span class="line">SW2(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>接着, 我们把SW1的vlan20打开端口, 配置充当网关的IP:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#int vlan 20</span></span><br><span class="line">SW1(config-if)<span class="comment">#no sh</span></span><br><span class="line">SW1(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 18 13:02:23.072: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan20, changed state to down</span><br><span class="line">SW1(config-if)<span class="comment">#ip add</span></span><br><span class="line">*Sep 18 13:02:25.643: %LINK-3-UPDOWN: Interface Vlan20, changed state to up</span><br><span class="line">*Sep 18 13:02:26.650: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan20, changed state to up</span><br><span class="line">SW1(config-if)<span class="comment">#ip addr 10.1.20.254 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<p>接着我们测试连通性:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC2<span class="comment">#ping 10.1.20.254</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.20.254, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p><strong>我觉得OK</strong>.</p>
<p>第三个实验: trunk vlan的实现, 首先要加一个e0&#x2F;3的网线:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan3.png" alt="vlan3"></p>
<p>现在开始配置SW1的trunk:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#int range e0/2 -3</span></span><br><span class="line">SW1(config-if-range)<span class="comment">#switch</span></span><br><span class="line">SW1(config-if-range)<span class="comment">#switchport mode trunk</span></span><br><span class="line">Command rejected: An interface whose trunk encapsulation is <span class="string">&quot;Auto&quot;</span> can not be configured to <span class="string">&quot;trunk&quot;</span> mode.</span><br><span class="line">% Range <span class="built_in">command</span> terminated because it failed on Ethernet0/2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>出现了报错, 这个原因是因为我们的e0&#x2F;2端口配置的是access结果进行了自动协商, 所以我们现需要进行手工指定一下封装格式, 接着就不会报错了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if-range)<span class="comment">#switchport trunk encapsulation dot1q </span></span><br><span class="line">SW1(config-if-range)<span class="comment">#switchport mode tru</span></span><br></pre></td></tr></table></figure>

<p>SW2同理. 配置完成之后 我们查看一下trunk情况:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#sh int tru</span></span><br><span class="line"></span><br><span class="line">Port        Mode             Encapsulation  Status        Native vlan</span><br><span class="line">Et0/2       on               802.1q         trunking      1</span><br><span class="line">Et0/3       on               802.1q         trunking      1</span><br></pre></td></tr></table></figure>

<p>两端一样的配置才可以.</p>
<p>现在, PC2还可以Ping通网关吗?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC2<span class="comment">#ping 10.1.20.254</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.20.254, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>

<p>没问题, 经过了trunk的解包, 最后变成和一般的ETH II包相同的头部了. ( 这里感觉说的不对, 现在只是做做实验配置啥的, 下次进行抓包实验就知道了. )</p>
<p>之所以没有打上VLAN ID, 是因为报文经过了本征VLAN, 其实就是native vlan.	</p>
<p>收到不打tag的包默认只能转给本征VLAN.</p>
<h2 id="中途休息"><a href="#中途休息" class="headerlink" title="中途休息"></a>中途休息</h2><p>下面一些简单的命令使用记录就是根据CCNA学习指南中第6,7章节所讲述的内容. 其中有一些在一开始的初入IOS中已经记录过了, 所以这里不再赘述.</p>
<p>实验拓扑没有, 只有一台单独的路由器&#x2F;交换机.</p>
<p><strong>显示版本, 主机名, 旗标, 密码, 接口描述, 密码</strong>这些都已经说过了, 所以略过.</p>
<p><strong>SSH的设定</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Router<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Router(config)<span class="comment">#hostname router </span></span><br><span class="line">router(config)<span class="comment">#ip domain-name yaoxuannn.com</span></span><br><span class="line">router(config)<span class="comment">#username router password justin13wyx</span></span><br><span class="line">router(config)<span class="comment">#crypto key generate rsa general-keys modulus 2048</span></span><br><span class="line">The name <span class="keyword">for</span> the keys will be: router.yaoxuannn.com</span><br><span class="line"></span><br><span class="line">% The key modulus size is 2048 bits</span><br><span class="line">% Generating 2048 bit RSA keys, keys will be non-exportable...</span><br><span class="line">[OK] (elapsed time was 2 seconds)</span><br><span class="line"></span><br><span class="line">router(config)<span class="comment">#</span></span><br><span class="line">*Sep 19 05:01:11.887: %SSH-5-ENABLED: SSH 1.99 has been enabled</span><br><span class="line">router(config)<span class="comment">#line vty 0 4</span></span><br><span class="line">router(config-line)<span class="comment">#transport input ssh telnet</span></span><br></pre></td></tr></table></figure>

<p>于是, 我一直都没有成功登录. 虽然是连接到了主机, 但是总是密码错误被拒绝. ( 好气</p>
<p><strong>do</strong>:</p>
<p>这个其实就像有点像vim等里面的<code>!</code>命令啦. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">IOU1<span class="comment">#sh ip int b   </span></span><br><span class="line">Interface                  IP-Address      OK? Method Status                Protocol</span><br><span class="line">Ethernet0/0                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet0/1                192.168.1.2     YES manual up                    up      </span><br><span class="line">Ethernet0/2                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet0/3                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/0                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/1                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/2                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/3                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/0                  unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/1                  unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/2                  unassigned      YES NVRAM  administratively down down    </span><br><span class="line">          </span><br><span class="line">IOU1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">IOU1(config)<span class="comment">#sh ip int b</span></span><br><span class="line">                 ^</span><br><span class="line">% Invalid input detected at <span class="string">&#x27;^&#x27;</span> marker.</span><br><span class="line"></span><br><span class="line">IOU1(config)<span class="comment">#do sh ip int b</span></span><br><span class="line">Interface                  IP-Address      OK? Method Status                Protocol</span><br><span class="line">Ethernet0/0                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet0/1                192.168.1.2     YES manual up                    up      </span><br><span class="line">Ethernet0/2                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet0/3                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/0                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/1                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/2                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Ethernet1/3                unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/0                  unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/1                  unassigned      YES NVRAM  administratively down down    </span><br><span class="line">Serial2/2                  unassigned      YES NVRAM  administratively down down </span><br></pre></td></tr></table></figure>

<p>查看当前的会话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Router<span class="comment">#sh users</span></span><br><span class="line">    Line       User       Host(s)              Idle       Location</span><br><span class="line">*  0 con 0                idle                 00:00:00   </span><br><span class="line">   2 vty 0                idle                 00:00:10 192.168.1.2</span><br><span class="line"></span><br><span class="line">  Interface    User               Mode         Idle     Peer Address</span><br></pre></td></tr></table></figure>

<p>奇怪的是, 我明明使用telnet连接到了远端设备, 但是使用下面的命令似乎一点用都没, 奇怪, 难道是模拟器的缘故, 还是我哪里操作不对?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IOU1<span class="comment">#telnet 192.168.1.1</span></span><br><span class="line">Trying 192.168.1.1 ... Open</span><br><span class="line"></span><br><span class="line">User Access Verification</span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line">Router&gt;sh sess</span><br><span class="line">% No connections open</span><br></pre></td></tr></table></figure>

<p>神奇.</p>
<p><strong>没有想到, 这么快就结束了. 早知道就不设置这个标题了. ( 果然这种实践性的东西看书就是麻烦 )</strong></p>
<h2 id="VLAN-self"><a href="#VLAN-self" class="headerlink" title="VLAN-self"></a>VLAN-self</h2><p>话说之前一直都没怎么搞定trunk, 本征vlan, access到底是个什么玩意. 于是….我自己设计了一个实验来彻底搞懂他们! ( 所以现在了解了很多, 差不多明白了hhh ) </p>
<p>实验拓扑如下:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5.png" alt="vlan5"></p>
<p>现在我们进行一下配置, 主要有: PC{1,2,3,4}的初始化设置, 开启端口, 关闭路由, 设置IP; SW{1,2}对主机的access设置, vlan设置和划分, SW之间的配置(*).</p>
<p>省略主机的设置, 下面是SW1的配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#vlan 10</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#name 507a</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#vlan 20</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#name 507b</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#int e0/1</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw mo acc</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw acc vlan 10</span></span><br><span class="line">SW1(config-if)<span class="comment">#int e0/2</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw mo acc </span></span><br><span class="line">SW1(config-if)<span class="comment">#sw acc vlan 20</span></span><br><span class="line">SW1(config-if)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 19 15:08:02.531: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">SW1<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>SW2几乎和SW1一样的配置, 所以也省略了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">SW1(config)<span class="comment">#int e0/0</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw tr en do</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw mo tru</span></span><br><span class="line">SW1(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>同上, SW2也是这样. 现在进行Ping测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.3</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.3, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>

<p>现在的状态是, PC1仅仅可以Ping通PC3. PC2仅仅可以Ping通PC4. 原因很简单了, 就是VLAN ID匹配嘛~.</p>
<p>那么有趣的是, 怎么使得PC2和PC3进行通信, PC1和PC4进行通信呢?</p>
<p>首先我们如果采用一般的方法肯定是行不通的. 其实这种跨ID的通信, 可以认定为vlan跳跃攻击. 做法其实很简单 , 只要把SW1的本征VLAN配置成SW1一方你想要通信的那个, SW2的本征VLAN配置成你想要SW2那一边通信的一方就行了.</p>
<p>先不考虑后果, 我们来配一配再试试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.4</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.4, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>肯定是不通的嘛~</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#int e0/0</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw tr na</span></span><br><span class="line">SW1(config-if)<span class="comment">#sw tr native vlan 10</span></span><br><span class="line">SW1(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>另外一边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW2(config)<span class="comment">#int e0/0</span></span><br><span class="line">SW2(config-if)<span class="comment">#sw tr </span></span><br><span class="line">*Sep 19 15:21:23.782: %CDP-4-NATIVE_VLAN_MISMATCH: Native VLAN mismatch discovered on Ethernet0/0 (1), with SW1 Ethernet0/0 (10).</span><br><span class="line">SW2(config-if)<span class="comment">#sw tr na vlan 20</span></span><br><span class="line">SW2(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>刚刚配好SW1的时候你会发现有报错, 也就是本征VLAN不匹配的报错, 不用管它.</p>
<p>这个报错会一直跟随着你,但是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.4</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.4, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>

<p>啊哈哈哈, 竟然通了! 真神奇!</p>
<p>但是遗憾的是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.3</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.3, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>咦咦咦? 自己家的东西怎么Ping不通? 其实啊, PC1是可以访问到PC3的, Ping不同的缘故只是因为PC3返回的reply报文携带的vlan10ID被SW1进行了帧过滤到了PC2身上, 接着PC2就把他丢弃了. 这个可以通过进行抓包进行分析. – (注: 这个情况发生的前提条件式PC1有PC3的arp缓存.)</p>
<p>附: 抓包截图:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5_1.png" alt="vlan5_1"></p>
<p>而返回的报文中:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan5_2.png" alt="vlan5_2"></p>
<p>根本没有插入携带vlanID帧.</p>
<p><strong>补充: 本征VLAN其实也是可以打上tag的, 使用下面的命令就可以:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#vlan dot1q tag native </span></span><br></pre></td></tr></table></figure>

<h2 id="STP生成树"><a href="#STP生成树" class="headerlink" title="STP生成树"></a>STP生成树</h2><p>  简单的说, 生成树协议是为了避免出现二层设备环路所造成的: 广播风暴, 单点帧拷贝, MAC表不稳定而开发的802.1D协议组. </p>
<p>( 生成树好烦啊…</p>
<p>好像我也做不出什么实验, 烦死了 ,随便丢个拓扑图给你:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp1.png" alt="stp1"></p>
<p>这里的SW1和SW2构成了环路. </p>
<p>你猜一猜, 如果这个时候我用PC1去PingPC2, 是否能通呢?</p>
<p>实践出真知, 我们来试试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.200            </span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.200, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>没问题!和你想的是否一样呢?</p>
<p>哈哈哈你是不是觉得就算通了, 其实效率很低呢? 我们再来试试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.200 repeat 1000</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 1000, 100-byte ICMP Echos to 192.168.1.200, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">Success rate is 100 percent (1000/1000), round-trip min/avg/max = 1/2/21 ms</span><br></pre></td></tr></table></figure>

<p>平均2ms, 并没有被拉慢速度. 很神奇吧, 这就是生成树的力量, 我们来看看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Altn BLK 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>看到没, 生成树机制使得e0&#x2F;2接口处于block状态. 所以才没造成环路! 那么这个接口就不能用了吗? 当然不是, 我们查看一下接口就明白了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh ip int b</span></span><br><span class="line">Interface              IP-Address      OK? Method Status                Protocol</span><br><span class="line">Ethernet0/0            unassigned      YES <span class="built_in">unset</span>  up                    up      </span><br><span class="line">Ethernet0/1            unassigned      YES <span class="built_in">unset</span>  up                    up      </span><br><span class="line">Ethernet0/2            unassigned      YES <span class="built_in">unset</span>  up                    up     </span><br></pre></td></tr></table></figure>

<p>是up的状态.</p>
<p>所以说这是个逻辑上的block, 而且仅仅适用于vlan10这个环境.</p>
<p>现在我们强制打开这个端口看看会出现什么现象:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if)<span class="comment">#spanning-tree bpdufilter enable</span></span><br></pre></td></tr></table></figure>

<p>过一小会而查看一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Desg LRN 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>接口变成来了LRN状态, 说明正在学习. ( 其实在LRN之前还有一个LIS的状态, 如果你点的快的话或许能看到</p>
<p>接着三口均为转发状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Desg FWD 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>再Ping试试: ( 为了实验效果, 请清除arp缓存 )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.200 repeat 100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 1000, 100-byte ICMP Echos to 192.168.1.200, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">..............!.......................................................</span><br><span class="line">...................</span><br><span class="line">Success rate is 1 percent (1/89), round-trip min/avg/max = 99/99/99 ms</span><br></pre></td></tr></table></figure>

<p>这个时候查看交换机的CPU, 你会发现会被疯狂占用. 而且其实这个时候, 你的命令敲的已经不是那么顺畅了.</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp2.png" alt="stp2"></p>
<p>如果这是真机后果可能会比你想象的严重.</p>
<p>赶紧变回来吧.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if)<span class="comment">#spanning-tree bpdufilter disable</span></span><br></pre></td></tr></table></figure>

<h2 id="生成树的调整和实施"><a href="#生成树的调整和实施" class="headerlink" title="生成树的调整和实施"></a>生成树的调整和实施</h2><p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp1.png" alt="stp1"></p>
<p>还是这样的拓扑图, 首先我们来切换根桥, 也就是通过调整优先级来实施.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    32778</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             This bridge is the root</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Desg FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Desg FWD 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>显然现在的根网桥就是SW1这只, 现在我们把它切换到SW2上:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW2(config)<span class="comment">#spanning-tree vlan 10 priority 0</span></span><br><span class="line">SW2<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             This bridge is the root</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    10   (priority 4096 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Desg FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Desg FWD 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>很简单吧, 合理的修改优先级来优化根位置. 在原本BLK的接口变得FWD的时候, 他也是经历了LIS, LRN的过程的.</p>
<p>接着我们再看看, trunk对于vlan的控制, 老实说我觉得这个实验应该在之前说VLAN的时候做的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Altn BLK 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>显然我们当前的SW1的0&#x2F;2端口是被堵住的, 现在我们不允许VLAN ID为10的帧通过e0&#x2F;2会怎么样呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if)<span class="comment">#sw tr allowed vlan remove 10</span></span><br><span class="line">SW1<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    10</span><br><span class="line">             Address     aabb.cc00.0200</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br></pre></td></tr></table></figure>

<p>没有了, 同时之前的潜在环路也消失了, 也就是说逻辑上已经不需要vlan10的生成树来封堵它了.通过这样的配置就可以实现链路的负载了.</p>
<p>接下来再说一个超级有用的二层交换的命令, 这个小实验建议手要快一点(建议使用分开的Tab, 这方便观察结果, 首先展示实验结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.1.200 r 1000000</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 1000000, 100-byte ICMP Echos to 192.168.1.200, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!...................!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!.....!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br></pre></td></tr></table></figure>

<p>这个是想表达什么呢? 首先我们开始进行批量的ping, 接着将SW1的e0&#x2F;1接口关闭, 于是出现了第一次的中断, 但是我在关闭接口之后立即又打开了它, 但是显然, 差不多经历了30s数据包才继续通信, 接着我再次将SW1的e0&#x2F;1接口关闭, 于是出现了第二次的中断, 接着, 和第一次不同的是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if)<span class="comment">#spanning-tree portfast </span></span><br><span class="line">%Warning: portfast should only be enabled on ports connected to a single</span><br><span class="line"> host. Connecting hubs, concentrators, switches, bridges, etc... to this</span><br><span class="line"> interface  when portfast is enabled, can cause temporary bridging loops.</span><br><span class="line"> Use with CAUTION</span><br><span class="line"></span><br><span class="line">%Portfast has been configured on Ethernet0/0 but will only</span><br><span class="line"> have effect when the interface is <span class="keyword">in</span> a non-trunking mode.</span><br></pre></td></tr></table></figure>

<p>接着再次打开了端口, 与第一次不同的是, 通信状态立即回复.</p>
<p>这个就是fastport, 这个选项使得生成树直接跳过LIS-LRN-FWD的30s时间, 而直接进入FWD状态.</p>
<p>如果说一个接口一个接口的配置太麻烦了, 也可以直接配个全局的, 就是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#spanning-tree portfast normal default </span></span><br></pre></td></tr></table></figure>

<p>如此即可.</p>
<p>那么这个fastport是不是有点不安全呢? 想象这么一种情况:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/stp3.png" alt="stp3"></p>
<p>(当然也不一定就是黑客啥的, 如果有一些网络管理员不小心把交换机啥的配置在了这个地方也会有造成网络崩溃的危险)这个时候, 我们需要SW能够拥有识别和保护的能力, 这就是现在要说的<strong>BPDUGUARD</strong> 也就是受到BPDU包, 那么就会将接口关闭. ( 实验不好做, 不想做了</p>
<p>(结果还是做了) 我们把SW1的e0&#x2F;1端口上加上这个选项:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#int e0/1</span></span><br><span class="line">SW1(config-if)<span class="comment">#span bpdug enab</span></span><br><span class="line">SW1(config-if)<span class="comment">#end</span></span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 20 12:29:53.672: %SPANTREE-2-BLOCK_BPDUGUARD: Received BPDU on port Et0/1 with BPDU Guard enabled. Disabling port.</span><br><span class="line">*Sep 20 12:29:53.672: %PM-4-ERR_DISABLE: bpduguard error detected on Et0/1, putting Et0/1 <span class="keyword">in</span> err-disable state</span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 20 12:29:54.248: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">*Sep 20 12:29:54.683: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to down</span><br><span class="line">SW1<span class="comment">#</span></span><br><span class="line">*Sep 20 12:29:55.684: %LINK-3-UPDOWN: Interface Ethernet0/1, changed state to down</span><br></pre></td></tr></table></figure>

<p>直接就被关闭了. 现在查看端口显示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh int e0/1</span></span><br><span class="line">Ethernet0/1 is down, line protocol is down (err-disabled) </span><br></pre></td></tr></table></figure>

<p>这里的err-disable可以进行自动回复, 还可以一定间隔自动回复:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#errdisable recovery cause bpduguard </span></span><br><span class="line">SW1(config)<span class="comment">#errdisable recovery interval 30</span></span><br></pre></td></tr></table></figure>

<p>这里就是说, 回复因为bpduguard造成的err-disabled, 第二个是说, 每个30s进行回复 (不过我自己实验的时候, 发现连个卵用都没有. 1分钟之后的更新, 当你把这个接口上的guard关掉之后才会看到自动回复的日志)</p>
<p>这个命令也可以进行全局设置, 但是必须结合fastport才可以.</p>
<h2 id="以太通道的建立"><a href="#以太通道的建立" class="headerlink" title="以太通道的建立"></a>以太通道的建立</h2><p>实验拓扑:<br><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/channel1.png" alt="channel1"></p>
<p>和上面的拓扑没什么区别, 但这一次总结配置了很多说过的东西. 接下来注意到e0&#x2F;1和e0&#x2F;2中间的那个小圈. 之前说过e0&#x2F;1和e0&#x2F;2由于会形成环路, 所以生成树会堵塞其中一个接口. 但是如果我们能够把这两条路当成是生成树的一个接口, 那么不仅能够提升带宽, 还可以增加冗余. 这个技术就是<strong>以太通道</strong></p>
<p>先来查看一下当前接口和生成树的状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#sh run int e0/0</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 109 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br><span class="line"> spanning-tree portfast edge</span><br><span class="line"> spanning-tree bpduguard <span class="built_in">enable</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">SW2<span class="comment">#sh run int e0/1</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 90 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">SW2<span class="comment">#sh run int e0/2</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 90 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>SW1这边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh run int e0/0         </span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 109 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br><span class="line"> spanning-tree portfast edge</span><br><span class="line"> spanning-tree bpduguard <span class="built_in">enable</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">SW1<span class="comment">#sh run int e0/1</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 90 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">SW1<span class="comment">#sh run int e0/2</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 90 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>而目前的生成树:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh span vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    32778</span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             Cost        100</span><br><span class="line">             Port        2 (Ethernet0/1)</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0500</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr Edge </span><br><span class="line">Et0/1               Root FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Altn BLK 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p>作为根桥的SW2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SW2<span class="comment">#sh span vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    32778</span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             This bridge is the root</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr Edge </span><br><span class="line">Et0/1               Desg FWD 100       128.2    Shr </span><br><span class="line">Et0/2               Desg FWD 100       128.3    Shr </span><br></pre></td></tr></table></figure>

<p><strong>现在我们把e0&#x2F;1和e0&#x2F;2捆绑起来:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SW1(config-if-range)<span class="comment">#channel-group 1 mode active </span></span><br><span class="line">Creating a port-channel interface Port-channel 1</span><br><span class="line"></span><br><span class="line">SW1(config-if-range)<span class="comment">#</span></span><br><span class="line">*Sep 21 04:00:19.927: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to down</span><br><span class="line">*Sep 21 04:00:19.927: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/2, changed state to down</span><br><span class="line">SW1(config-if-range)<span class="comment">#</span></span><br><span class="line">*Sep 21 04:00:21.192: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/2, changed state to up</span><br><span class="line">*Sep 21 04:00:21.192: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/1, changed state to up</span><br><span class="line">SW1(config-if-range)<span class="comment">#</span></span><br><span class="line">*Sep 21 04:00:27.353: %EC-5-L3DONTBNDL2: Et0/1 suspended: LACP currently not enabled on the remote port.</span><br><span class="line">*Sep 21 04:00:27.374: %EC-5-L3DONTBNDL2: Et0/2 suspended: LACP currently not enabled on the remote port.</span><br><span class="line">SW1(config-if-range)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>端口先进行了关闭, 接着又Up起来, 接着收到了消息, LACP没有在远端端口上开启. 在SW2上进行完全相同的操作( 这个地方SW2可以有多个方案选择, active或者passive )  </p>
<p>完成了之后来看一下效果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh etherchannel summary </span></span><br><span class="line">Flags:  D - down        P - bundled <span class="keyword">in</span> port-channel</span><br><span class="line">        I - stand-alone s - suspended</span><br><span class="line">        H - Hot-standby (LACP only)</span><br><span class="line">        R - Layer3      S - Layer2</span><br><span class="line">        U - <span class="keyword">in</span> use      N - not <span class="keyword">in</span> use, no aggregation</span><br><span class="line">        f - failed to allocate aggregator</span><br><span class="line"></span><br><span class="line">        M - not <span class="keyword">in</span> use, minimum links not met</span><br><span class="line">        m - not <span class="keyword">in</span> use, port not aggregated due to minimum links not met</span><br><span class="line">        u - unsuitable <span class="keyword">for</span> bundling</span><br><span class="line">        w - waiting to be aggregated</span><br><span class="line">        d - default port</span><br><span class="line"></span><br><span class="line">        A - formed by Auto LAG</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Number of channel-groups <span class="keyword">in</span> use: 1</span><br><span class="line">Number of aggregators:           1</span><br><span class="line"></span><br><span class="line">Group  Port-channel  Protocol    Ports</span><br><span class="line">------+-------------+-----------+-----------------------------------------------</span><br><span class="line">1      Po1(SU)         LACP      Et0/1(P)    Et0/2(P)    </span><br></pre></td></tr></table></figure>

<p><strong>U</strong>即表示已经在使用.</p>
<p>那么这个时候我们的生成树会变成什么样的呢? 很好奇吧, 我们来看一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#sh span vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    32778</span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             This bridge is the root</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg FWD 100       128.1    Shr Edge </span><br><span class="line">Po1                 Desg FWD 56        128.65   Shr </span><br></pre></td></tr></table></figure>

<p>原先FWD的e0&#x2F;1和BLK的e0&#x2F;2端口现在合成成了一个FWD的Po1, 注意到Nbr也发生了变化.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#sh int Po1</span></span><br><span class="line">Port-channel1 is up, line protocol is up (connected) </span><br><span class="line">  Hardware is EtherChannel, address is aabb.cc00.0310 (bia aabb.cc00.0310)</span><br><span class="line">  MTU 1500 bytes, BW 20000 Kbit/sec, DLY 1000 usec, </span><br><span class="line">  ...(omitted)</span><br></pre></td></tr></table></figure>

<p>带宽是原来的两倍!</p>
<h2 id="VTP协议-VLAN中继协议"><a href="#VTP协议-VLAN中继协议" class="headerlink" title="VTP协议-VLAN中继协议"></a>VTP协议-VLAN中继协议</h2><p>在做实验之前, 我们先说说这个VTP协议, 简单的说就是为了VLAN配置信息的同步, 也可以理解成是一台交换机进行统一部署. VTP共有3个版本, 各个版本之间不兼容, 所以说, 如果要进行VTP, 就要保证交换机之间的版本号一致.</p>
<p>除此之外, 还需要满足: 交换机之间的VTP管理域名相同, 至少有一台VTP服务器, VTP的密码相同, 以及只在trunk上工作. 这很好理解</p>
<p>值得注意的是, VTP不是基于C&#x2F;S架构的, 这就是说, 一个VTP域中可以存在多个服务器.</p>
<p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vtp2.png" alt="vtp2"></p>
<p>SW3和SW4暂时没有开机.</p>
<p>现在我们在SW上查看一下当前vtp的状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SW<span class="comment">#sh vtp status</span></span><br><span class="line">VTP Version capable             : 1 to 3</span><br><span class="line">VTP version running             : 1</span><br><span class="line">VTP Domain Name                 : </span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Traps Generation            : Disabled</span><br><span class="line">Device ID                       : aabb.cc80.0200</span><br><span class="line">Configuration last modified by 0.0.0.0 at 0-0-00 00:00:00</span><br><span class="line">Local updater ID is 0.0.0.0 (no valid interface found)</span><br><span class="line"></span><br><span class="line">Feature VLAN:</span><br><span class="line">--------------</span><br><span class="line">VTP Operating Mode                : Server</span><br><span class="line">Maximum VLANs supported locally   : 1005</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 0</span><br><span class="line">MD5 digest                        : 0x57 0xCD 0x40 0x65 0x63 0x59 0x47 0xBD </span><br><span class="line">                                    0x56 0x9D 0x4A 0x3E 0xA5 0x69 0x35 0xBC </span><br></pre></td></tr></table></figure>

<p>要关注的地方是version版本号(1), Mode模式(Server, 这是默认值), 已存在的vlan和配置版本(这个配置版本就有一点像程序的版本号, 每次进行vlan的修改,删除,新增都会使得这个值加一)</p>
<p>SW1也是一台vtp server,略过.</p>
<p>现在我们在SW上进行下面的操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SW(config)<span class="comment">#vtp domain jky   </span></span><br><span class="line">Changing VTP domain name from NULL to jky</span><br><span class="line">SW(config)<span class="comment">#vtp version 2</span></span><br></pre></td></tr></table></figure>

<p>提示说VTP域名从没有到变成了jky, 现在查看SW1或者SW2的vtp status, 你就会发现:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh vtp status</span></span><br><span class="line">VTP Version capable             : 1 to 3</span><br><span class="line">VTP version running             : 2</span><br><span class="line">VTP Domain Name                 : jky</span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Traps Generation            : Disabled</span><br><span class="line">Device ID                       : aabb.cc80.0100</span><br><span class="line">Configuration last modified by 0.0.0.0 at 9-21-17 05:23:53</span><br><span class="line">Local updater ID is 0.0.0.0 (no valid interface found)</span><br><span class="line"></span><br><span class="line">Feature VLAN:</span><br><span class="line">--------------</span><br><span class="line">VTP Operating Mode                : Server</span><br><span class="line">Maximum VLANs supported locally   : 1005</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 1</span><br><span class="line">MD5 digest                        : 0x7C 0x50 0x18 0xD1 0xBF 0x8C 0xF3 0x39 </span><br><span class="line">                                    0x58 0xC0 0x7B 0x6E 0xDD 0x66 0xFF 0x90 </span><br></pre></td></tr></table></figure>

<p>版本号变成了2, 而且域的名字也变成了jky, 另外我之前说过的Conf Revision也自动加了一.</p>
<p>现在我们尝试为SW和SW1添加相同的vtp密码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SW(config)<span class="comment">#vtp password jky507</span></span><br><span class="line">Setting device VTP password to jky507</span><br></pre></td></tr></table></figure>

<p>开始为SW配置VLAN:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW(config)<span class="comment">#vlan 10</span></span><br><span class="line">SW(config-vlan)<span class="comment">#name 507a</span></span><br><span class="line">SW(config-vlan)<span class="comment">#vlan 20</span></span><br><span class="line">SW(config-vlan)<span class="comment">#name 507b</span></span><br><span class="line">SW(config-vlan)<span class="comment">#vlan 30,40,50</span></span><br><span class="line">SW(config-vlan)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>来看看SW1是否得到了更新和同步:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SW1<span class="comment">#sh vlan b</span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0/1, Et0/2, Et0/3, Et1/0</span><br><span class="line">                                                Et1/1, Et1/2, Et1/3, Et2/0</span><br><span class="line">                                                Et2/1, Et2/2, Et2/3, Et3/0</span><br><span class="line">                                                Et3/1, Et3/2, Et3/3</span><br><span class="line">10   507a                             active    </span><br><span class="line">20   507b                             active    </span><br><span class="line">30   VLAN0030                         active    </span><br><span class="line">40   VLAN0040                         active    </span><br><span class="line">50   VLAN0050                         active    </span><br><span class="line">1002 fddi-default                     act/unsup </span><br><span class="line">1003 trcrf-default                    act/unsup </span><br><span class="line">1004 fddinet-default                  act/unsup </span><br><span class="line">1005 trbrf-default                    act/unsup </span><br></pre></td></tr></table></figure>

<p>看吧, SW1和SW的vlan保持了一致! 那, 没有设置密码的SW2显然就没有得到同步了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SW2<span class="comment">#sh vlan b </span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0/0, Et0/2, Et0/3, Et1/0</span><br><span class="line">                                                Et1/1, Et1/2, Et1/3, Et2/0</span><br><span class="line">                                                Et2/1, Et2/2, Et2/3, Et3/0</span><br><span class="line">                                                Et3/1, Et3/2, Et3/3</span><br><span class="line">1002 fddi-default                     act/unsup </span><br><span class="line">1003 trcrf-default                    act/unsup </span><br><span class="line">1004 fddinet-default                  act/unsup </span><br><span class="line">1005 trbrf-default                    act/unsup </span><br></pre></td></tr></table></figure>

<p>接下来, 你来猜一猜, 如果我现在把SW2的vtp密码设置上, 他会得到同步吗?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">SW2(config)<span class="comment">#vtp pas jky507</span></span><br><span class="line">Setting device VTP password to jky507</span><br><span class="line">SW2(config)<span class="comment">#end</span></span><br><span class="line">SW2<span class="comment">#sh vlan</span></span><br><span class="line">*Sep 21 05:31:32.763: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">SW2<span class="comment">#sh vlan b</span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0/0, Et0/2, Et0/3, Et1/0</span><br><span class="line">                                                Et1/1, Et1/2, Et1/3, Et2/0</span><br><span class="line">                                                Et2/1, Et2/2, Et2/3, Et3/0</span><br><span class="line">                                                Et3/1, Et3/2, Et3/3</span><br><span class="line">1002 fddi-default                     act/unsup </span><br><span class="line">1003 trcrf-default                    act/unsup </span><br><span class="line">1004 fddinet-default                  act/unsup </span><br><span class="line">1005 trbrf-default                    act/unsup </span><br><span class="line">SW2<span class="comment">#sh vtp status</span></span><br><span class="line">VTP Version capable             : 1 to 3</span><br><span class="line">VTP version running             : 2</span><br><span class="line">VTP Domain Name                 : jky</span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Traps Generation            : Disabled</span><br><span class="line">Device ID                       : aabb.cc80.0500</span><br><span class="line">Configuration last modified by 0.0.0.0 at 9-21-17 05:23:53</span><br><span class="line">Local updater ID is 0.0.0.0 (no valid interface found)</span><br><span class="line"></span><br><span class="line">Feature VLAN:</span><br><span class="line">--------------</span><br><span class="line">VTP Operating Mode                : Server</span><br><span class="line">Maximum VLANs supported locally   : 1005</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 1</span><br><span class="line">MD5 digest                        : 0xF4 0xD1 0xC8 0xA8 0xAB 0xFF 0x33 0x7E </span><br><span class="line">                                    0x84 0xCC 0xD5 0x91 0xA7 0x16 0x8D 0xBC </span><br></pre></td></tr></table></figure>

<p>挨 ? 按理说现在SW2和SW1的环境应该是一样的呀, 为什么没有用呢? 这里就要说IOS的一个大大大大的坑了, 这个VTP的触发条件就是对VLAN的操作, 如果没有, 不好意思. 他不会进行同步. 这样的话我们可以尝试对VLAN进行一些操作来触发它, 比如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SW(config)<span class="comment">#vlan 99</span></span><br><span class="line">SW(config-vlan)<span class="comment">#no vlan 99</span></span><br><span class="line">SW(config)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>这个时候查看SW2的vlan配置, 就已经和SW, SW1保持一致了.</p>
<p>好了, 到了把SW3和SW4开机的时候了.</p>
<p>别忘了把trunk先开开:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SW3(config)<span class="comment">#int e0/0</span></span><br><span class="line">SW3(config-if)<span class="comment">#sw tr en do</span></span><br><span class="line">SW3(config-if)<span class="comment">#sw mo tr</span></span><br><span class="line">SW3(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>接着我们尝试一下client模式.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SW3(config)<span class="comment">#vtp mode client</span></span><br><span class="line">Setting device to VTP Client mode <span class="keyword">for</span> VLANS.</span><br><span class="line">SW3(config)<span class="comment">#do sh vtp status</span></span><br><span class="line">VTP Version capable             : 1 to 3</span><br><span class="line">VTP version running             : 1</span><br><span class="line">VTP Domain Name                 : </span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Traps Generation            : Disabled</span><br><span class="line">Device ID                       : aabb.cc80.0300</span><br><span class="line">Configuration last modified by 0.0.0.0 at 0-0-00 00:00:00</span><br><span class="line"></span><br><span class="line">Feature VLAN:</span><br><span class="line">--------------</span><br><span class="line">VTP Operating Mode                : Client</span><br><span class="line">Maximum VLANs supported locally   : 1005</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 0</span><br><span class="line">MD5 digest                        : 0x57 0xCD 0x40 0x65 0x63 0x59 0x47 0xBD </span><br><span class="line">                                    0x56 0x9D 0x4A 0x3E 0xA5 0x69 0x35 0xBC </span><br></pre></td></tr></table></figure>

<p>这个时候先别急着试, 我们说过vtp的同步是要很多条件的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SW3(config)<span class="comment">#vtp password jky507</span></span><br><span class="line">Setting device VTP password to jky507</span><br><span class="line">SW3(config)<span class="comment">#vtp version 2</span></span><br><span class="line">Cannot modify version <span class="keyword">in</span> VTP client mode unless the system is <span class="keyword">in</span> VTP version 3</span><br><span class="line">SW3(config)<span class="comment">#vtp domain jky</span></span><br><span class="line">Changing VTP domain name from NULL to jky</span><br></pre></td></tr></table></figure>

<p>如果是Client模式, 你是不能进行version的变更的, 同时, 如果你想要进行vlan配置的改变:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SW3(config)<span class="comment">#vlan 10</span></span><br><span class="line">VTP VLAN configuration not allowed when device is <span class="keyword">in</span> CLIENT mode.</span><br></pre></td></tr></table></figure>

<p>是不被允许的.</p>
<p>接着我们把SW4和SW的接口down掉.</p>
<p>最后一定不要忘记:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SW4(config)<span class="comment">#vtp password jky507</span></span><br><span class="line">Setting device VTP password to jky507</span><br><span class="line">SW4(config)<span class="comment">#vtp domain jky</span></span><br><span class="line">Changing VTP domain name from NULL to jky</span><br><span class="line">SW4(config)<span class="comment">#vtp mode client</span></span><br><span class="line">Setting device to VTP Client mode <span class="keyword">for</span> VLANS.</span><br><span class="line">SW4(config)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>OK, 我们来测试一下Client的转发和续传:</p>
<p>这次我们特地在SW1上进行更改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SW1(config)<span class="comment">#vlan 50</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#name 508</span></span><br><span class="line">SW1(config-vlan)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>看看SW4怎么样了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SW4<span class="comment">#sh vlan b</span></span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0/1, Et0/2, Et0/3, Et1/0</span><br><span class="line">                                                Et1/1, Et1/2, Et1/3, Et2/0</span><br><span class="line">                                                Et2/1, Et2/2, Et2/3, Et3/0</span><br><span class="line">                                                Et3/1, Et3/2, Et3/3</span><br><span class="line">10   507a                             active    </span><br><span class="line">20   507b                             active    </span><br><span class="line">30   506                              active    </span><br><span class="line">40   505                              active    </span><br><span class="line">50   508                              active    </span><br><span class="line">1002 fddi-default                     act/unsup </span><br><span class="line">1003 trcrf-default                    act/unsup </span><br><span class="line">1004 fddinet-default                  act/unsup </span><br><span class="line">1005 trbrf-default                    act/unsup </span><br></pre></td></tr></table></figure>

<p>更新了, 这次更新显然是SW3转发给SW4得到的, 其实不仅Client可以进行转发, 由于这一次我们是在SW1上做的改变, 所以这同时也证明Server端也是可以进行转发的, 同时也可以进行同步.</p>
<p>除了这两种模式, 还有一种透明模式, 这种模式就像是自治一般, 允许更改但是不能进行发布. 这种模式相较于Server和Client更加可靠其实, 至于为什么, 你自己想吧. 所以一般我们推荐使用transport模式.</p>
<h2 id="HCRP小实验"><a href="#HCRP小实验" class="headerlink" title="HCRP小实验"></a>HCRP小实验</h2><p>这个实验很简单, 拓扑也很simple, 就是感受一下虚拟IP而已.</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/hcrp.png" alt="hcrp"></p>
<p>最简单的连接了 不说直接配.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#int e0/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#standby 1 ip 192.168.1.254</span></span><br><span class="line">HQ(config-if)<span class="comment">#^Z</span></span><br><span class="line">...(omitted)</span><br><span class="line">*Sep 21 06:53:11.122: %HSRP-5-STATECHANGE: Ethernet0/0 Grp 1 state Standby -&gt; Active</span><br></pre></td></tr></table></figure>

<p>看到输出, e0&#x2F;0的第一组状态变成了Active.</p>
<p>我们把Branch也设置成同样的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#int e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#standby 1 ip 192.168.1.254</span></span><br><span class="line">Branch(config-if)<span class="comment">#^Z</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 21 06:54:43.377: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 21 06:55:06.347: %HSRP-5-STATECHANGE: Ethernet0/0 Grp 1 state Speak -&gt; Standby</span><br></pre></td></tr></table></figure>

<p>此时的Branch就相当是一台热备路由了. 我们来观察一下standby的状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh standby b</span></span><br><span class="line">                     P indicates configured to preempt.</span><br><span class="line">                     |</span><br><span class="line">Interface   Grp  Pri P State   Active          Standby         Virtual IP</span><br><span class="line">Et0/0       1    100   Standby 192.168.1.20    <span class="built_in">local</span>           192.168.1.254</span><br></pre></td></tr></table></figure>

<p>显示本地设备是standby的状态, 这个时候使用HQ查看是相反的两个. 那么如果我想使得Branch成为Active的状态, 有什么办法么?</p>
<p>这里的Active其实参考的是上面的Pri值, 也就是优先级, 越大越优先.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Branch(config-if)<span class="comment">#standby 1 priority 125</span></span><br><span class="line">Branch(config-if)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>过了很久, 你本以为会有什么消息输出, 结果没有.</p>
<p>查看一下状态吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh standby b</span></span><br><span class="line">                     P indicates configured to preempt.</span><br><span class="line">                     |</span><br><span class="line">Interface   Grp  Pri P State   Active          Standby         Virtual IP</span><br><span class="line">Et0/0       1    125   Standby 192.168.1.20    <span class="built_in">local</span>           192.168.1.254</span><br></pre></td></tr></table></figure>

<p>改是改过来了, 但是就没有切换状态呀.</p>
<p>这个时候, 就需要Branch主动发出请求了, 也就是需要进行一个属性的调用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Branch(config-if)<span class="comment">#standby 1 preempt </span></span><br><span class="line">Branch(config-if)<span class="comment">#^Z</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 21 07:01:11.706: %HSRP-5-STATECHANGE: Ethernet0/0 Grp 1 state Standby -&gt; Active</span><br></pre></td></tr></table></figure>

<p>同时, HQ那边也还会有提示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 21 07:01:11.707: %HSRP-5-STATECHANGE: Ethernet0/0 Grp 1 state Active -&gt; Speak</span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 21 07:01:22.034: %HSRP-5-STATECHANGE: Ethernet0/0 Grp 1 state Speak -&gt; Standby</span><br></pre></td></tr></table></figure>

<p>最后我们来Ping这虚拟IP试试吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#ping 192.168.1.254</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.254, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.!!!!</span><br><span class="line">Success rate is 80 percent (4/5), round-trip min/avg/max = 1/3/6 ms</span><br></pre></td></tr></table></figure>

<p>第一个包是在进行ARP请求 虚拟IP的实验完成.</p>
<h2 id="VLAN间路由"><a href="#VLAN间路由" class="headerlink" title="VLAN间路由"></a>VLAN间路由</h2><p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/vlan6_new.png" alt="vlan6_new"></p>
<p>似曾相识?emmmm..就是这样.</p>
<p>我们还是先把基本的属性配置好. 现在的问题是, 我们想要使得PC1和PC2进行通信, 之前我们说过可以使用修改本征VLAN使得帧不携带VLANID的方法, 但是这显然不好, 现在我们通过单臂路由的实现使PC1和PC2进行通信.</p>
<p>首先确认除Branch以外的设备都已经配置完成. 现在我们进入Branch的配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#int e0/0.10</span></span><br><span class="line">Branch(config-subif)<span class="comment">#en</span></span><br><span class="line">Branch(config-subif)<span class="comment">#encapsulation do</span></span><br><span class="line">Branch(config-subif)<span class="comment">#encapsulation dot1Q 10</span></span><br><span class="line">Branch(config-subif)<span class="comment">#ip addr 10.1.10.254 255.255.255.0</span></span><br><span class="line">Branch(config-subif)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#int e0/0.20</span></span><br><span class="line">Branch(config-subif)<span class="comment">#en do 20</span></span><br><span class="line">Branch(config-subif)<span class="comment">#ip addr 10.1.20.254 255.255.255.0</span></span><br><span class="line">Branch(config-subif)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#int e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#no sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#^Z</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 21 08:47:44.945: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 21 08:47:46.257: %LINK-3-UPDOWN: Interface Ethernet0/0, changed state to up</span><br><span class="line">*Sep 21 08:47:47.266: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet0/0, changed state to up</span><br></pre></td></tr></table></figure>

<p>好, 进行测试. 激动人心的时刻到了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC2<span class="comment">#ping 10.1.10.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.10.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>

<p>太好了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 10.1.20.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 10.1.20.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/2/4 ms</span><br></pre></td></tr></table></figure>

<p>如果你的PC1和PC2无法通信, 请检查一下:</p>
<ul>
<li>SW1和SW2对应VLAN的生成树, 其中SW1有10和20的两个生成树实例</li>
<li>trunk的配置是否完成(一共有两个交换机trunk, 路由器的子接口两个dot1q封装)</li>
<li>vlan的划分是否完成.</li>
</ul>
<h2 id="SVI交换虚拟接口"><a href="#SVI交换虚拟接口" class="headerlink" title="SVI交换虚拟接口"></a>SVI交换虚拟接口</h2><p>实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/svi.png" alt="svi"></p>
<p>这个实验的关键点在于SW的三层交换.</p>
<p>我们配置三个VLAN10, 20, 30分别使用access模式划分给PC1, PC2, 路由器Branch. 接着为SW配置路由表, 将默认路由指向VLAN30.  最好手动开启交换功能.</p>
<p>To tell you from the heart, 这个实验我没有做成功. 虽然我排查了很久确定没有出错, 但是就是无法使得PC1和Branch通信.</p>
<blockquote>
<p>这个实验中SW配置了默认路由, 确定了SW到每一个节点的连通, 我也确定<strong>我敲了SW的 ip routing 命令, 但是就是不转发!</strong> 到底是为什么呢? 在这里贴下SW的配置, 如果你能发现问题 请告知 : )</p>
<p>SW2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">SW<span class="comment">#sh ip rout</span></span><br><span class="line">S*    0.0.0.0/0 [1/0] via 192.168.3.254, Vlan30</span><br><span class="line">      192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.1.0/24 is directly connected, Vlan10</span><br><span class="line">L        192.168.1.100/32 is directly connected, Vlan10</span><br><span class="line">      192.168.2.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.2.0/24 is directly connected, Vlan20</span><br><span class="line">L        192.168.2.100/32 is directly connected, Vlan20</span><br><span class="line">      192.168.3.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.3.0/24 is directly connected, Vlan30</span><br><span class="line">L        192.168.3.100/32 is directly connected, Vlan30</span><br><span class="line"></span><br><span class="line">SW<span class="comment">#sh run int e0/1</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 80 bytes</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport access vlan 10</span><br><span class="line"> switchport mode access</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">SW<span class="comment">#sh spanning-tree vlan 10</span></span><br><span class="line"></span><br><span class="line">VLAN0010</span><br><span class="line">  Spanning tree enabled protocol rstp</span><br><span class="line">  Root ID    Priority    32778</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             This bridge is the root</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32778  (priority 32768 sys-id-ext 10)</span><br><span class="line">             Address     aabb.cc00.0100</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec</span><br><span class="line"></span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/1               Desg FWD 100       128.2    Shr Edge </span><br><span class="line"></span><br><span class="line">interface Vlan1</span><br><span class="line"> no ip address</span><br><span class="line"> shutdown </span><br><span class="line">!         </span><br><span class="line">interface Vlan10</span><br><span class="line"> ip address 192.168.1.100 255.255.255.0</span><br><span class="line">!         </span><br><span class="line">interface Vlan20</span><br><span class="line"> ip address 192.168.2.100 255.255.255.0</span><br><span class="line">!         </span><br><span class="line">interface Vlan30</span><br><span class="line"> ip address 192.168.3.100 255.255.255.0</span><br><span class="line">!         </span><br><span class="line">ip forward-protocol nd</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="DHCP实现"><a href="#DHCP实现" class="headerlink" title="DHCP实现"></a>DHCP实现</h2><p>首先我们的实验拓扑:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp4.png" alt="dhcp4"></p>
<p>和我们设置单臂路由的时候几乎一样. 现在我们先关闭PC1和PC2的IP地址. 接着重新设置IP获取方式为DHCP.下述配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PC1(config)<span class="comment">#int e0/1</span></span><br><span class="line">PC1(config-if)<span class="comment">#no ip addr # 关闭IP地址</span></span><br><span class="line">PC1(config-if)<span class="comment">#ip addr dhcp # 设置成DHCP动态获取</span></span><br></pre></td></tr></table></figure>

<p>接着我们要把路由器设置成为一台DHCP服务器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#ip dhcp pool VLAN10</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#network 10.1.10.0 255.255.255.0</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#default-router 10.1.10.254</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#dns-server 114.114.114.114 223.5.5.5</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#domain-name yaoxuannn.com</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#ip dhcp pool VLAN20</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#network 10.1.20.0 255.255.255.0</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#default-router 10.1.20.254</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#dns-server 223.5.5.5 114.114.114.114</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#domain-name yaoxuannn.com</span></span><br><span class="line">Branch(dhcp-config)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#ip dhcp excluded-address ?</span></span><br><span class="line">  A.B.C.D  Low IP address</span><br><span class="line">  vrf      VRF name <span class="keyword">for</span> excluded address range</span><br><span class="line"></span><br><span class="line">Branch(config)<span class="comment">#ip dhcp excluded-address 10.1.10.250 10.1.10.254</span></span><br><span class="line">Branch(config)<span class="comment">#ip dhcp excluded-address 10.1.20.250 10.1.20.254</span></span><br></pre></td></tr></table></figure>

<p>这个时候, PC1和PC2会收到消息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PC2<span class="comment">#</span></span><br><span class="line">*Sep 21 11:31:17.361: %DHCP-6-ADDRESS_ASSIGN: Interface Ethernet0/1 assigned DHCP address 10.1.20.1, mask 255.255.255.0, hostname PC2</span><br></pre></td></tr></table></figure>

<p>很简单吧~</p>
<p>有趣的是, 我们的DHCP事实上很有趣. 我们来抓个包看看.</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp2.png" alt="dhcp2"></p>
<p>这是释放IP的时候所发的包.</p>
<p>有意思的是:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp3.png" alt="dhcp3"></p>
<p>有没有发现, 所有的包都是广播啊!哈哈哈这个是不是和你想象的不太一样啊.</p>
<p>另外, 如果出现了IP地址冲突, 是需要网络管理员进行手动的修改的.命令就是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip dhcp conflict </span></span><br><span class="line">IP address        Detection method   Detection time          VRF</span><br><span class="line">Branch<span class="comment">#clear ip dhcp conflict ?</span></span><br><span class="line">  *        Clear all address conflicts</span><br><span class="line">  A.B.C.D  Clear a specific conflict</span><br><span class="line">  vrf      DHCP vrf conflicts</span><br></pre></td></tr></table></figure>

<p>另外还可以查看当前IP池的分配情况:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip dhcp pool</span></span><br><span class="line"></span><br><span class="line">Pool VLAN10 :</span><br><span class="line"> Utilization mark (high/low)    : 100 / 0</span><br><span class="line"> Subnet size (first/next)       : 0 / 0 </span><br><span class="line"> Total addresses                : 254</span><br><span class="line"> Leased addresses               : 1</span><br><span class="line"> Pending event                  : none</span><br><span class="line"> 1 subnet is currently <span class="keyword">in</span> the pool :</span><br><span class="line"> Current index        IP address range                    Leased addresses</span><br><span class="line"> 10.1.10.2            10.1.10.1        - 10.1.10.254       1</span><br><span class="line"></span><br><span class="line">Pool VLAN20 :</span><br><span class="line"> Utilization mark (high/low)    : 100 / 0</span><br><span class="line"> Subnet size (first/next)       : 0 / 0 </span><br><span class="line"> Total addresses                : 254</span><br><span class="line"> Leased addresses               : 1</span><br><span class="line"> Pending event                  : none</span><br><span class="line"> 1 subnet is currently <span class="keyword">in</span> the pool :</span><br><span class="line"> 10.1.20.2            10.1.20.1        - 10.1.20.254       1</span><br></pre></td></tr></table></figure>

<p>如果是更想知道IP分配给了谁, 这样看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip dhcp binding</span></span><br><span class="line">Bindings from all pools not associated with VRF:</span><br><span class="line">IP address          Client-ID/              Lease expiration        Type</span><br><span class="line">                    Hardware address/</span><br><span class="line">                    User name</span><br><span class="line">10.1.10.1           0063.6973.636f.2d61.    Sep 23 2017 01:40 AM    Automatic</span><br><span class="line">                    6162.622e.6363.3030.</span><br><span class="line">                    2e30.3531.302d.4574.</span><br><span class="line">                    302f.31</span><br><span class="line">10.1.20.1           0063.6973.636f.2d61.    Sep 23 2017 01:40 AM    Automatic</span><br><span class="line">                    6162.622e.6363.3030.</span><br><span class="line">                    2e30.3431.302d.4574.</span><br><span class="line">                    302f.31	</span><br></pre></td></tr></table></figure>

<p>接下来, 我们扯扯<strong>DHCP中继</strong>.</p>
<p>使用的场景在DHCP服务器和客户端不在同一个网络中, 这个时候广播不能跨越网络到达DHCP服务器, 所以我们要将广播封装成单播来实现.</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/dhcp%E4%B8%AD%E7%BB%A7.png" alt="dhcp中继"></p>
<p>现在我们来将CMCC设置成DHCP服务器, 路由器Branch设置了两个dot1q封装的子接口分别对应PC1所处的VLAN10和PC2所处的VLAN20.</p>
<p>直接来看路由器的配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#int e0/0   </span></span><br><span class="line">Branch(config-if)<span class="comment">#no sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#int e0/0.10</span></span><br><span class="line">Branch(config-subif)<span class="comment">#encapsulation dot1q 10</span></span><br><span class="line">Branch(config-subif)<span class="comment">#ip addr 192.168.1.100 255.255.255.0</span></span><br><span class="line">Branch(config-subif)<span class="comment">#ip helper-address 172.16.1.100</span></span><br><span class="line">Branch(config-subif)<span class="comment">#exi</span></span><br></pre></td></tr></table></figure>

<p>这里的helper-address就是将广播封装成单播发出去的.</p>
<p>PC1会受到DHCP分配消息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*Sep 22 02:40:14.398: %DHCP-6-ADDRESS_ASSIGN: Interface Ethernet0/1 assigned DHCP address 192.168.1.1, mask 255.255.255.0, hostname PC1</span><br></pre></td></tr></table></figure>

<p>同理, PC2和路由器的子接口也做相似的操作就行了.</p>
<h2 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h2><p>BGP称为边际网关协议, 用于在AS之间进行自动的邻居间的单播路由. 现在我们用一个超小的实验来模拟一下:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/bgp2.png" alt="bgp2"></p>
<p>现在我们有两个AS, 为了使得AS号100里的PC1和AS号200里的PC2通信, 我们先通过DHCP的方式使得PC1和PC2自动获得IP地址, 接着评定Branch和HQ之间的连通:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip dhcp pool Branch</span></span><br><span class="line"></span><br><span class="line">Pool Branch :</span><br><span class="line"> Utilization mark (high/low)    : 100 / 0</span><br><span class="line"> Subnet size (first/next)       : 0 / 0 </span><br><span class="line"> Total addresses                : 254</span><br><span class="line"> Leased addresses               : 1</span><br><span class="line"> Pending event                  : none</span><br><span class="line"> 1 subnet is currently <span class="keyword">in</span> the pool :</span><br><span class="line"> Current index        IP address range                    Leased addresses</span><br><span class="line"> 192.168.1.2          192.168.1.1      - 192.168.1.254     1</span><br><span class="line"> ----------------------</span><br><span class="line"> HQ<span class="comment">#sh ip dhcp pool HQ </span></span><br><span class="line"></span><br><span class="line">Pool HQ :</span><br><span class="line"> Utilization mark (high/low)    : 100 / 0</span><br><span class="line"> Subnet size (first/next)       : 0 / 0 </span><br><span class="line"> Total addresses                : 254</span><br><span class="line"> Leased addresses               : 1</span><br><span class="line"> Pending event                  : none</span><br><span class="line"> 1 subnet is currently <span class="keyword">in</span> the pool :</span><br><span class="line"> Current index        IP address range                    Leased addresses</span><br><span class="line"> 192.168.2.2          192.168.2.1      - 192.168.2.254     1</span><br></pre></td></tr></table></figure>

<p>还是惯例, Ping一下试试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#ping 172.16.2.100     </span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.2.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>好啦 开始设置我们的BGP, 这样来:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#router bgp 100</span></span><br><span class="line">Branch(config-router)<span class="comment">#neighbor 172.16.2.100 remote-as 200</span></span><br><span class="line">Branch(config-router)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 22 11:57:34.347: %SYS-5-CONFIG_I: Configured from console by console</span><br></pre></td></tr></table></figure>

<p>对面也这么设置, 过一小会就会有BGP的邻居up的消息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 22 11:58:12.494: %BGP-5-ADJCHANGE: neighbor 172.16.2.100 Up </span><br></pre></td></tr></table></figure>

<p>激动人心的时候到啦, 我!要!通!信!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.2.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 172.16.2.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">.....</span><br><span class="line">Success rate is 0 percent (0/5)</span><br></pre></td></tr></table></figure>

<p>嘿嘿, 失败了. 为啥? 是因为我们还没有进行BGP路由的<strong>发布</strong> </p>
<p>现在试试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#router bgp 100</span></span><br><span class="line">Branch(config-router)<span class="comment">#network 192.168.1.0 mask 255.255.255.0</span></span><br><span class="line">Branch(config-router)<span class="comment">#network 172.16.0.0 mask 255.255.0.0</span></span><br><span class="line">Branch(config-router)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>接着对方:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#router bgp 200</span></span><br><span class="line">HQ(config-router)<span class="comment">#network 192.168.2.0 mask 255.255.255.0</span></span><br><span class="line">HQ(config-router)<span class="comment">#network 172.16.0.0 mask 255.255.0.0</span></span><br><span class="line">HQ(config-router)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>现在再试试,就可以通信了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.2.1</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.2.1, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/5 ms</span><br></pre></td></tr></table></figure>

<p>建议, 在发布前, 中, 后经常查看一下路由表, 以及使用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip bgp</span></span><br><span class="line">BGP table version is 6, <span class="built_in">local</span> router ID is 192.168.1.100</span><br><span class="line">Status codes: s suppressed, d damped, h <span class="built_in">history</span>, * valid, &gt; best, i - internal, </span><br><span class="line">              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, </span><br><span class="line">              x best-external, a additional-path, c RIB-compressed, </span><br><span class="line">Origin codes: i - IGP, e - EGP, ? - incomplete</span><br><span class="line">RPKI validation codes: V valid, I invalid, N Not found</span><br><span class="line"></span><br><span class="line">     Network          Next Hop            Metric LocPrf Weight Path</span><br><span class="line"> *   172.16.0.0       172.16.2.100             0             0 200 i</span><br><span class="line"> *&gt;                   0.0.0.0                  0         32768 i</span><br><span class="line"> *&gt;  192.168.1.0      0.0.0.0                  0         32768 i</span><br><span class="line"> *&gt;  192.168.2.0      172.16.2.100             0             0 200 i</span><br></pre></td></tr></table></figure>

<p>你会有很多发现, 对BGP发布也会更理解.</p>
<h2 id="OSPF"><a href="#OSPF" class="headerlink" title="OSPF"></a>OSPF</h2><p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/odpf.png" alt="odpf"></p>
<p>不想打字.</p>
<p>配置完成之后, 我们直接进行OSPF路由的设置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	Branch<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Branch(config)<span class="comment">#router ospf 1</span></span><br><span class="line">Branch(config-router)<span class="comment">#router-id 1.1.1.1</span></span><br><span class="line">Branch(config-router)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#int e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip ospf 1 area 0</span></span><br><span class="line">Branch(config-if)<span class="comment">#exi</span></span><br><span class="line">Branch(config)<span class="comment">#int e0/1</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip ospf 1 area 0</span></span><br><span class="line">Branch(config-if)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>同样另外一边也做同样的事, 但是这里的ospf的进程号是可以不一样的, 而router-id自然是需要不一样的.</p>
<p>接着我们就会受到消息通知, 这个时候查看OSPF的邻居也可以看到了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 22 13:30:02.975: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/0 from LOADING to FULL, Loading Done</span><br><span class="line">Branch<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">2.2.2.2           1   FULL/BDR        00:00:35    172.16.1.2      Ethernet0/0</span><br></pre></td></tr></table></figure>

<p>好了, 这样就行了. 比BGP要容易多了!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.2.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.2.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>接着, 没完. 你会发现有个东西不对劲:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">2.2.2.2           1   FULL/DR         00:00:37    172.16.1.2      Ethernet0/0</span><br><span class="line">Branch<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">2.2.2.2           1   FULL/DR         00:00:34    172.16.1.2      Ethernet0/0</span><br><span class="line">Branch<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">2.2.2.2           1   FULL/DR         00:00:33    172.16.1.2      Ethernet0/0</span><br></pre></td></tr></table></figure>

<p>死亡时间在减少 但是你又发现, 这个时间每次到了30的时候会自动增加回去.</p>
<p>是这样, 死亡时间是指收到Hello的时间间隔, 如果一直没收到DeadTime就会一直减少, 直到降为0. 因此我关闭了Branch这边的ospf路由, 于是HQ这边就会一直收不到Hello消息导致时间一直在下降:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">1.1.1.1           1   FULL/BDR        00:00:00    172.16.1.1      Ethernet0/0</span><br><span class="line">HQ<span class="comment">#sh ip ospf nei</span></span><br><span class="line">HQ<span class="comment">#</span></span><br><span class="line">*Sep 22 14:10:11.105: %OSPF-5-ADJCHG: Process 1, Nbr 1.1.1.1 on Ethernet0/0 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br></pre></td></tr></table></figure>

<p>当时间降为0的时候, 邻居就会被删除.</p>
<p>接下来说说这个Hello消息, 该消息时间默认是10s一次. 如何修改这个Hello时间呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#int e0/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip ospf hello-interval 15</span></span><br></pre></td></tr></table></figure>

<p>结果过了一会你发现, 挨!我的邻居怎么又被删除了?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Branch(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 22 14:16:46.466: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/0 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br></pre></td></tr></table></figure>

<p>这个Hello时间, 要求必须一致. 所以一端改了, 另一端也是需要进行更改的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#int e0/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip ospf hello-interval 15</span></span><br><span class="line">HQ(config-if)<span class="comment">#end</span></span><br><span class="line">*Sep 22 14:18:07.735: %OSPF-5-ADJCHG: Process 1, Nbr 1.1.1.1 on Ethernet0/0 from LOADING to FULL, Loading Done</span><br><span class="line">HQ<span class="comment">#sh ip ospf nei</span></span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">1.1.1.1           1   FULL/BDR        00:00:58    172.16.1.1      Ethernet0/0</span><br></pre></td></tr></table></figure>

<p>这样就可以了. (虽然默认死亡时间是Hello时间的4倍, 但是我们也是可以进行设置的, 同理,两端也要一致</p>
<p>由一个很重要的东西没有提到, 那就是区域. 这个玩意决定着邻居的发现和建立关系, 必须一致才行.</p>
<h2 id="RIP"><a href="#RIP" class="headerlink" title="RIP"></a>RIP</h2><p>都到RIP了, 这个文章终于快结束了, 好开心. 做了这么多的实验. 虽然我觉得没有什么意思…(好吧, 其实我觉得我走错路了, 玩这些东西简直就是在浪费我的时间啊. 还是老老实实去看我的Linux运维吧..我又不搞这些JB东西…不过呢..写都写了, 不如就把这篇完成掉,收个好尾好了. 做完RIP的实验之后就只剩VPN的实施和ACL了. 把这些结束, 我就继续更新Linux的文章啦!)</p>
<p>OK, 还是像往常一样, 把我们的实验拓扑图拿出来~~:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/rip.png" alt="rip"></p>
<p>其实和上面的OSPF的图是一样的啦, 这次我不使用OSPF而是使用RIP来实施路由. 这样来操作:<br>Branch:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#router rip</span></span><br><span class="line">Branch(config-router)<span class="comment">#version 2</span></span><br><span class="line">Branch(config-router)<span class="comment">#no auto-summary </span></span><br><span class="line">Branch(config-router)<span class="comment">#passive-interface default</span></span><br><span class="line">Branch(config-router)<span class="comment">#network 172.16.1.0</span></span><br><span class="line">Branch(config-router)<span class="comment">#network 192.168.1.0</span></span><br><span class="line">Branch(config-router)<span class="comment">#neighbor 172.16.1.2</span></span><br><span class="line">Branch(config-router)<span class="comment">#^Z</span></span><br></pre></td></tr></table></figure>

<p>HQ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#router rip</span></span><br><span class="line">HQ(config-router)<span class="comment">#version 2</span></span><br><span class="line">HQ(config-router)<span class="comment">#no auto-summary </span></span><br><span class="line">HQ(config-router)<span class="comment">#passive-interface default </span></span><br><span class="line">HQ(config-router)<span class="comment">#netwo 192.168.2.0</span></span><br><span class="line">HQ(config-router)<span class="comment">#netwo 172.16.1.0</span></span><br><span class="line">HQ(config-router)<span class="comment">#nei 172.16.1.1</span></span><br><span class="line">HQ(config-router)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>接下来就行了, 这就是RIP最经典的配置了. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PC1<span class="comment">#ping 192.168.2.100</span></span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.2.100, <span class="built_in">timeout</span> is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/6 ms</span><br></pre></td></tr></table></figure>

<p>我们说过RIPv1和v2是不兼容的, 但是就是要折腾一下才好玩嘛, 现在我们把一端的版本改成1版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HQ(config)<span class="comment">#router rip</span></span><br><span class="line">HQ(config-router)<span class="comment">#version 1</span></span><br><span class="line">HQ(config-router)<span class="comment">#no passive-interface default</span></span><br></pre></td></tr></table></figure>

<p>另外一边也把接口调整一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#router rip</span></span><br><span class="line">Branch(config-router)<span class="comment">#no passive-interface default </span></span><br></pre></td></tr></table></figure>

<p>现在我们来查看一下两方的路由协议信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Branch<span class="comment">#sh ip protocols </span></span><br><span class="line">...(omitted)</span><br><span class="line">Routing Protocol is <span class="string">&quot;rip&quot;</span></span><br><span class="line">  Outgoing update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  Incoming update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  Sending updates every 30 seconds, next due <span class="keyword">in</span> 3 seconds</span><br><span class="line">  Invalid after 180 seconds, hold down 180, flushed after 240</span><br><span class="line">  Redistributing: rip</span><br><span class="line">  Neighbor(s):</span><br><span class="line">    172.16.1.2</span><br><span class="line">  Default version control: send version 2, receive version 2</span><br><span class="line">    Interface             Send  Recv  Triggered RIP  Key-chain</span><br><span class="line">    Ethernet0/0           2     2                                    </span><br><span class="line">    Ethernet0/1           2     2         </span><br><span class="line">    ..(omitted)</span><br></pre></td></tr></table></figure>

<p>如你所见, Branch这边接受版本2, 发送版本2. 那么猜也能猜出来了, HQ那边是指接受和发送版本1的报文了, 这样两人是没有办法建立关系的. 但是我们可以使用命令来使得某一个接口接受特定版本的报文从而解决兼容问题.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#int r e0/0 -1</span></span><br><span class="line">Branch(config-if-range)<span class="comment">#ip rip send version 1 2</span></span><br><span class="line">Branch(config-if-range)<span class="comment">#ip rip re version 1 2 </span></span><br></pre></td></tr></table></figure>

<p>现在其实已经通了. 因为由一方是两种版本都可使用的.</p>
<p>我们在实验时关闭了自动汇总功能, 这个汇总其实就是我们说的路由汇总啦.</p>
<h2 id="PAP认证"><a href="#PAP认证" class="headerlink" title="PAP认证"></a>PAP认证</h2><p>实验拓扑异常简单:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/ppp.png" alt="ppp"></p>
<p>其实只是为了展示一下PPP而已嘛</p>
<p>HQ一端做这样的处理:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HQ<span class="comment">#conf ter</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">HQ(config)<span class="comment">#int s2/0</span></span><br><span class="line">HQ(config-if)<span class="comment">#no sh</span></span><br><span class="line">HQ(config-if)<span class="comment">#ip addr 202.10.100.10 255.255.255.0</span></span><br><span class="line">HQ(config-if)<span class="comment">#encapsulation ppp</span></span><br><span class="line">HQ(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 23 05:45:18.209: %LINK-3-UPDOWN: Interface Serial2/0, changed state to up</span><br><span class="line">HQ(config-if)<span class="comment">#ppp authentication pap</span></span><br><span class="line">HQ(config-if)<span class="comment">#exi</span></span><br><span class="line">HQ(config)<span class="comment">#username justin password justin</span></span><br><span class="line">HQ(config)<span class="comment">#service password-encryption </span></span><br><span class="line">HQ(config)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>接着另外一端:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Branch(config)<span class="comment">#in s2/0</span></span><br><span class="line">Branch(config-if)<span class="comment">#no sh</span></span><br><span class="line">Branch(config-if)<span class="comment">#ip addr 202.102</span></span><br><span class="line">*Sep 23 05:47:05.729: %LINK-3-UPDOWN: Interface Serial2/0, changed state to up</span><br><span class="line">*Sep 23 05:47:06.729: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#ip addr 202.10.100.20 255.255.255.0</span></span><br><span class="line">Branch(config-if)<span class="comment">#en</span></span><br><span class="line">Branch(config-if)<span class="comment">#encapsulation ppp</span></span><br><span class="line">*Sep 23 05:47:23.553: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to down</span><br><span class="line">Branch(config-if)<span class="comment">#ppp pap sent-username justin password justi </span></span><br><span class="line"><span class="comment"># 这里我故意输错密码</span></span><br><span class="line">Branch(config-if)<span class="comment">#ppp pap sent-username justin password justin</span></span><br><span class="line">Branch(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 23 05:48:32.410: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br><span class="line">Branch(config-if)<span class="comment">#end</span></span><br><span class="line">Branch<span class="comment">#</span></span><br><span class="line">*Sep 23 05:48:48.907: %SYS-5-CONFIG_I: Configured from console by console</span><br><span class="line">Branch<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>我在另外一端打开了debug调试, 于是在收到了错误的密码之后, 信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*Sep 23 05:48:30.334: Se2/0 PPP: Using default call direction</span><br><span class="line">*Sep 23 05:48:30.334: Se2/0 PPP: Treating connection as a dedicated line</span><br><span class="line">*Sep 23 05:48:30.334: Se2/0 PPP: Session handle[3400000F] Session <span class="built_in">id</span>[15]</span><br><span class="line">*Sep 23 05:48:30.354: Se2/0 PAP: I AUTH-REQ <span class="built_in">id</span> 1 len 17 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 05:48:30.354: Se2/0 PAP: Authenticating peer justin</span><br><span class="line">*Sep 23 05:48:30.354: Se2/0 PPP: Sent PAP LOGIN Request</span><br><span class="line">*Sep 23 05:48:30.354: Se2/0 PPP: Received LOGIN Response FAIL</span><br><span class="line">*Sep 23 05:48:30.354: Se2/0 PAP: O AUTH-NAK <span class="built_in">id</span> 1 len 26 msg is <span class="string">&quot;Authentication failed&quot;</span></span><br></pre></td></tr></table></figure>

<p>密码正确之后, 双方都显示接口up, 并且:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*Sep 23 05:48:32.386: Se2/0 PPP: Using default call direction</span><br><span class="line">*Sep 23 05:48:32.386: Se2/0 PPP: Treating connection as a dedicated line</span><br><span class="line">*Sep 23 05:48:32.386: Se2/0 PPP: Session handle[39000010] Session <span class="built_in">id</span>[16]</span><br><span class="line">*Sep 23 05:48:32.402: Se2/0 PAP: I AUTH-REQ <span class="built_in">id</span> 1 len 18 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 05:48:32.402: Se2/0 PAP: Authenticating peer justin</span><br><span class="line">*Sep 23 05:48:32.403: Se2/0 PPP: Sent PAP LOGIN Request</span><br><span class="line">*Sep 23 05:48:32.403: Se2/0 PPP: Received LOGIN Response PASS</span><br><span class="line">*Sep 23 05:48:32.409: Se2/0 PAP: O AUTH-ACK <span class="built_in">id</span> 1 len 5</span><br></pre></td></tr></table></figure>

<h2 id="CHAP"><a href="#CHAP" class="headerlink" title="CHAP"></a>CHAP</h2><p>先来搞一个单向认证的, 十分简单:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/chap1.png" alt="chap1"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Router1(config)<span class="comment">#int s2/0</span></span><br><span class="line">Router1(config-if)<span class="comment">#no sh</span></span><br><span class="line">Router1(config-if)<span class="comment">#ip add</span></span><br><span class="line">*Sep 23 06:07:37.658: %LINK-3-UPDOWN: Interface Serial2/0, changed state to up</span><br><span class="line">*Sep 23 06:07:38.666: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br><span class="line">Router1(config-if)<span class="comment">#ip addr 202.10.100.10 255.255.255.0</span></span><br><span class="line">Router1(config-if)<span class="comment">#encapsulation ppp</span></span><br><span class="line">Router1(config-if)<span class="comment">#ppp authn</span></span><br><span class="line">*Sep 23 06:07:56.329: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to down</span><br><span class="line">Router1(config-if)<span class="comment">#ppp authen chap</span></span><br><span class="line">Router1(config-if)<span class="comment">#exi     </span></span><br><span class="line">Router1(config)<span class="comment">#username justin password justin</span></span><br><span class="line">Router1(config)<span class="comment">#service password-encryption </span></span><br><span class="line">Router1(config)<span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>同样这个时候我打开了debug, 可以看到.</p>
<p>在我们为Router2设置的时候, router1一直在尝试进行挑战:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*Sep 23 06:11:13.788: Se2/0 PPP: Using default call direction</span><br><span class="line">*Sep 23 06:11:13.788: Se2/0 PPP: Treating connection as a dedicated line</span><br><span class="line">*Sep 23 06:11:13.788: Se2/0 PPP: Session handle[72000027] Session <span class="built_in">id</span>[39]</span><br><span class="line">*Sep 23 06:11:13.822: Se2/0 CHAP: O CHALLENGE <span class="built_in">id</span> 1 len 28 from <span class="string">&quot;Router1&quot;</span></span><br></pre></td></tr></table></figure>

<p>接着当我们设置了正确的主机名和密码之后:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*Sep 23 06:14:23.736: Se2/0 PPP: Using default call direction</span><br><span class="line">*Sep 23 06:14:23.736: Se2/0 PPP: Treating connection as a dedicated line</span><br><span class="line">*Sep 23 06:14:23.736: Se2/0 PPP: Session handle[BE000047] Session <span class="built_in">id</span>[70]</span><br><span class="line">*Sep 23 06:14:23.773: Se2/0 CHAP: O CHALLENGE <span class="built_in">id</span> 1 len 28 from <span class="string">&quot;Router1&quot;</span></span><br><span class="line">*Sep 23 06:14:23.784: Se2/0 CHAP: I RESPONSE <span class="built_in">id</span> 1 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:14:23.784: Se2/0 PPP: Sent CHAP LOGIN Request</span><br><span class="line">*Sep 23 06:14:23.784: Se2/0 PPP: Received LOGIN Response PASS</span><br><span class="line">*Sep 23 06:14:23.790: Se2/0 CHAP: O SUCCESS <span class="built_in">id</span> 1 len 4</span><br><span class="line">Router1<span class="comment">#</span></span><br><span class="line">*Sep 23 06:14:23.790: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br></pre></td></tr></table></figure>

<p>这是一个单向的认证. 十分简单.</p>
<p>接着我们来看看双向认证是个什么样子</p>
<p>其实是一样的, 就是把Router2也设置上用户和密码, 但是奇怪的事情发生了, 尽管我们把Router1也设置对了(发送主机名和密码) 但是.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Router1(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 23 06:18:58.433: Se2/0 AUTH: Timeout 8</span><br><span class="line">*Sep 23 06:18:58.433: Se2/0 CHAP: O CHALLENGE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:18:58.450: Se2/0 CHAP: I CHALLENGE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:18:58.450: Se2/0 CHAP: Ignoring Challenge with <span class="built_in">local</span> name</span><br></pre></td></tr></table></figure>

<p>另外一边:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Router2(config-if)<span class="comment">#</span></span><br><span class="line">*Sep 23 06:19:08.457: Se2/0 AUTH: Timeout 9</span><br><span class="line">*Sep 23 06:19:08.457: Se2/0 CHAP: O CHALLENGE <span class="built_in">id</span> 10 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:19:08.457: Se2/0 CHAP: I CHALLENGE <span class="built_in">id</span> 10 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:19:08.457: Se2/0 CHAP: Ignoring Challenge with <span class="built_in">local</span> name</span><br></pre></td></tr></table></figure>

<p>都在疯狂的超时, 奇怪. 我们确认一下配置: (为了确认效果, 暂时把password-encryption的服务撤掉)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Router1<span class="comment">#sh run int s2/0</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 197 bytes</span><br><span class="line">!</span><br><span class="line">interface Serial2/0</span><br><span class="line"> ip address 202.10.100.10 255.255.255.0</span><br><span class="line"> encapsulation ppp</span><br><span class="line"> ppp authentication chap</span><br><span class="line"> ppp chap hostname justin</span><br><span class="line"> ppp chap password 0 justin</span><br><span class="line"> serial restart-delay 0</span><br><span class="line">end</span><br><span class="line">---------</span><br><span class="line">Router2<span class="comment">#sh run int s2/0</span></span><br><span class="line">Building configuration...</span><br><span class="line"></span><br><span class="line">Current configuration : 197 bytes</span><br><span class="line">!</span><br><span class="line">interface Serial2/0</span><br><span class="line"> ip address 202.10.100.20 255.255.255.0</span><br><span class="line"> encapsulation ppp</span><br><span class="line"> ppp authentication chap</span><br><span class="line"> ppp chap hostname justin</span><br><span class="line"> ppp chap password 0 justin</span><br><span class="line"> serial restart-delay 0</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>奇怪, 确认了也没有问题, 难道是用户名不能一样吗?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Router2(config)<span class="comment">#username bieber password justin</span></span><br></pre></td></tr></table></figure>

<p>接着:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Router1(config-if)<span class="comment">#ppp chap hostname bieber</span></span><br></pre></td></tr></table></figure>

<p>突然之间:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*Sep 23 06:28:19.557: Se2/0 CHAP: O CHALLENGE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 CHAP: I CHALLENGE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;bieber&quot;</span></span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 PPP: Sent CHAP SENDAUTH Request</span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 PPP: Received SENDAUTH Response PASS</span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 CHAP: Using hostname from interface CHAP</span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 CHAP: Using password from AAA</span><br><span class="line">*Sep 23 06:28:19.558: Se2/0 CHAP: O RESPONSE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;justin&quot;</span></span><br><span class="line">*Sep 23 06:28:19.564: Se2/0 CHAP: I RESPONSE <span class="built_in">id</span> 9 len 27 from <span class="string">&quot;bieber&quot;</span></span><br><span class="line">*Sep 23 06:28:19.564: Se2/0 PPP: Sent CHAP LOGIN Request</span><br><span class="line">*Sep 23 06:28:19.564: Se2/0 PPP: Received LOGIN Response PASS</span><br><span class="line">*Sep 23 06:28:19.570: Se2/0 CHAP: O SUCCESS <span class="built_in">id</span> 9 len 4</span><br><span class="line">*Sep 23 06:28:19.575: Se2/0 CHAP: I SUCCESS <span class="built_in">id</span> 9 len 4</span><br><span class="line">Router2<span class="comment">#</span></span><br><span class="line">*Sep 23 06:28:19.576: %LINEPROTO-5-UPDOWN: Line protocol on Interface Serial2/0, changed state to up</span><br></pre></td></tr></table></figure>

<p>连密码都不需要输入, 接口工作了.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">Tags</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">大实验环境介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E8%BF%9B%E5%85%A5IOS"><span class="toc-number">2.</span> <span class="toc-text">初次进入IOS.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%B6%E5%8C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">时间和时区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E7%9A%84Ping"><span class="toc-number">2.2.</span> <span class="toc-text">第一次的Ping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%BC%86"><span class="toc-number">2.3.</span> <span class="toc-text">配置远程管理虚拟线缆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E5%AE%9E%E9%AA%8C%E5%89%8D%E7%9A%84%E4%BF%9D%E5%AD%98"><span class="toc-number">2.4.</span> <span class="toc-text">结束实验前的保存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.5.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91"><span class="toc-number">3.</span> <span class="toc-text">局域网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%92%8C%E4%B8%BB%E6%9C%BA%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">路由和主机远程管理交换机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E7%BD%91%E4%B8%8E%E7%AE%80%E5%8D%95%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">4.</span> <span class="toc-text">子网与简单静态路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARP%E5%AE%9E%E9%AA%8C"><span class="toc-number">5.</span> <span class="toc-text">ARP实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1-amp-%E6%B5%AE%E5%8A%A8%E8%B7%AF%E7%94%B1"><span class="toc-number">6.</span> <span class="toc-text">静态路由&amp;浮动路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-number">7.</span> <span class="toc-text">路由规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN%E6%8A%80%E6%9C%AF"><span class="toc-number">8.</span> <span class="toc-text">VLAN技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%80%94%E4%BC%91%E6%81%AF"><span class="toc-number">9.</span> <span class="toc-text">中途休息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN-self"><span class="toc-number">10.</span> <span class="toc-text">VLAN-self</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#STP%E7%94%9F%E6%88%90%E6%A0%91"><span class="toc-number">11.</span> <span class="toc-text">STP生成树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%A0%91%E7%9A%84%E8%B0%83%E6%95%B4%E5%92%8C%E5%AE%9E%E6%96%BD"><span class="toc-number">12.</span> <span class="toc-text">生成树的调整和实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E9%80%9A%E9%81%93%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-number">13.</span> <span class="toc-text">以太通道的建立</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VTP%E5%8D%8F%E8%AE%AE-VLAN%E4%B8%AD%E7%BB%A7%E5%8D%8F%E8%AE%AE"><span class="toc-number">14.</span> <span class="toc-text">VTP协议-VLAN中继协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HCRP%E5%B0%8F%E5%AE%9E%E9%AA%8C"><span class="toc-number">15.</span> <span class="toc-text">HCRP小实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VLAN%E9%97%B4%E8%B7%AF%E7%94%B1"><span class="toc-number">16.</span> <span class="toc-text">VLAN间路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SVI%E4%BA%A4%E6%8D%A2%E8%99%9A%E6%8B%9F%E6%8E%A5%E5%8F%A3"><span class="toc-number">17.</span> <span class="toc-text">SVI交换虚拟接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DHCP%E5%AE%9E%E7%8E%B0"><span class="toc-number">18.</span> <span class="toc-text">DHCP实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BGP"><span class="toc-number">19.</span> <span class="toc-text">BGP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OSPF"><span class="toc-number">20.</span> <span class="toc-text">OSPF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RIP"><span class="toc-number">21.</span> <span class="toc-text">RIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAP%E8%AE%A4%E8%AF%81"><span class="toc-number">22.</span> <span class="toc-text">PAP认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CHAP"><span class="toc-number">23.</span> <span class="toc-text">CHAP</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&text=CCNA学习&amp;实验-[完结]"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&is_video=false&description=CCNA学习&amp;实验-[完结]"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CCNA学习&amp;实验-[完结]&body=Check out this article: https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&title=CCNA学习&amp;实验-[完结]"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&name=CCNA学习&amp;实验-[完结]&description=&lt;p&gt;在学习完CCNA前都一直更新, 这份文档的创建时间是17-09-15, 每次更新都将会直接更新文档时间以用于置顶. 另外,这篇文档主要用来记录一些CCNA相关的思科IOS的操作和命令. ( 毕竟我不是学网工的,所以里面的一些看法可能不是很准确 ). 实验的主要参考资料:  CCNA学习指南(7th), 以及乾颐堂CCNA3.0的视频.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2017/09/22/CCNA%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-updating/&t=CCNA学习&amp;实验-[完结]"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Yaoxuan Wei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'yaoxuannn-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
