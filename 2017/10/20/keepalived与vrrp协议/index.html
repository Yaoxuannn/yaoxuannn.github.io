<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="打开高可用的探索之门~">
<meta property="og:type" content="article">
<meta property="og:title" content="keepalived">
<meta property="og:url" content="https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Yaoxuannn&#39;s Blog">
<meta property="og:description" content="打开高可用的探索之门~">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.keepalived.org/images/Software%20Design.gif">
<meta property="article:published_time" content="2017-10-20T15:10:32.000Z">
<meta property="article:modified_time" content="2020-11-30T01:25:25.000Z">
<meta property="article:author" content="Yaoxuan Wei">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Cluster">
<meta property="article:tag" content="keepalived">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.keepalived.org/images/Software%20Design.gif">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>keepalived</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-09NWQ40K0B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-09NWQ40K0B');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2017/10/21/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80%E5%92%8Cheartbeat/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2017/10/19/HAProxy%E7%9A%84%E9%85%8D%E7%BD%AE%E5%92%8C%E5%BA%94%E7%94%A8/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&text=keepalived"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&is_video=false&description=keepalived"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=keepalived&body=Check out this article: https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&name=keepalived&description=&lt;p&gt;打开高可用的探索之门~&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&t=keepalived"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">高可用集群基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived%E5%92%8Cvrrp%E7%AE%80%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">keepalived和vrrp简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">keepalived配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE-LVS-keepalived%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">项目: LVS + keepalived实现基础高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE-Nginx-keepalived%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">项目: Nginx + keepalived实现基础高可用</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        keepalived
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Yaoxuan Wei</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-10-20T15:10:32.000Z" class="dt-published" itemprop="datePublished">2017-10-20</time>
        
        (Updated: <time datetime="2020-11-30T01:25:25.000Z" class="dt-updated" itemprop="dateModified">2020-11-29</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Cluster/" rel="tag">Cluster</a>, <a class="p-category" href="/tags/Linux/" rel="tag">Linux</a>, <a class="p-category" href="/tags/keepalived/" rel="tag">keepalived</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>打开高可用的探索之门~</p>
<span id="more"></span>

<h2 id="高可用集群基础"><a href="#高可用集群基础" class="headerlink" title="高可用集群基础"></a>高可用集群基础</h2><p>我们已经了解了LB集群的实现, 使用了lvs, nginx, haproxy等等. 其实这些服务或者功能都十分轻量. 但是director作为整个系统的单点所在, 我们需要考虑下对这个调度器做高可用 (HA).</p>
<p>但是高可用的架构有很多, 例如今天要说的keepalived, 还有heartbeat, corosync, cman等等. 这些中最为轻量的就是这个keepalived. 在这样的场景下, 真心没有必要去使用后面的那些. 所以 我们选择使用keepalived来构建这么一个小型的高可用集群. 事实上 keepalived原本设计的面向就是为了LVS实现的高可用解决方案. 只不过现在他已经拓展了很多功能了, 通过外置脚本和插件的形式, 只不过在配置文件中, keepalived原本就已经支持对LVS的种种高可用操作. 所以十分适合. 至于后面那些, 都是为了10几个, 几百个这样的大型服务器集群.</p>
<p>在高可用的场景中, 我们经常会将一个节点做双份, 这个时候我们把正在使用的那一个定义成**<code>active</code><strong>的, 而冗余的那一台就是</strong><code>passive</code>**的, 也可以叫做backup节点. 回到那个问题, 备用节点怎么得知活动节点服务出现问题, 并且通过什么方式来取代其作为服务.  现在我们就很好回答这个问题了, 只要两个或者多个节点都有相同的服务, 例如我们的LVS, 一个director需要一个VIP和ipvs规则才可以, 在例如我们的nginx, 他也需要一个VIP和自己的nginx服务, 再如haproxy, 还是需要一个VIP和自己的服务配置.  那么也就是说, 从节点需要获得和主节点一样的IP, 一样的服务配置或者规则.</p>
<p>但是, 以现在的认知, 两个节点拥有同一个IP地址似乎是存在问题的. 先不管这个, 一个主机想要作为负载均衡调度的节点的话, 是需要我们上面 说的那些的, 我们把这个东西称作<strong>资源(<code>resource</code>)</strong>, 高可用集群中的资源. 所以一个高可用集群中最珍贵的资源就是我们的VIP了.</p>
<p>那么, 如果当发现主节点出现问题, 从节点将IP配置上, 这个时候我们漏掉了一个很重要的部分的, <strong>存储</strong>.我们说过存储的数据分两种, 结构化数据和非结构化数据. 结构化的数据都是存储在数据库中的, 数据库对于并发控制是存在的, 所以我们也先不考虑这个, 问题在于非结构化数据, 如果是挂载的共享存储, 这个时候两台节点都有进程都在对文件系统进读写, 我们知道Linux对于文件系统的数据读写是在内存中完成的, 这样在并发的情况下就会出现大量脏数据的情况, 导致结果不一致, 从而使得数据损坏. 除了共享存储, 我们也可以使用同步, 不过仅仅适合于数据量很少的情况.</p>
<p>这个时候, 我们就需要分布式存储的协力, 或者支持并发访问的文件系统了. 所以, 我们现在稍作总结, 在这样的高可用场景中, 最重要的资源就是IP和存储了, 至于服务, 我们只要运行相同, 配置文件也保持一致就行了.</p>
<p>接着在回到之前说的配置IP这一点上, 如果直接就这么配置上, 一个明显的问题就是我们director之前的路由器就傻了, 可能会出现一段时间是第一台节点, 一段时间路由到第二台节点的情况. 这怎么办呢? 很简单了, 只要确保必须是一台活动, 一台备用就行了, 也就是说只要一台得到了IP, 另外一台就不能进行工作. 这样的话就回到了那个老话题 – 如何判断主备状态.</p>
<p>监控, 对. 显然, 监控就可以解决问题. 但是监控也是分很多形式的, 比如可以一问一答, 也可以进行单方向发送状态信息. 一般情况下, 我们选择的方式是后者. 而且还是基于组播的发送. 另外, 这个机制的一个重要的考量因素就是<strong>时间</strong>. 主机之间的时间必须同步. 否则极大几率会出现误判. 那么如何实现时间同步? 简单, 只要指向同一台ntp服务器就行了. 我不管这个时间是否准确, 只要<strong>你们的</strong>时间一样就行了. </p>
<p>要说到keepalived, 首先我们要说说vrrp, 也就是虚拟路由冗余协议.</p>
<h2 id="keepalived和vrrp简述"><a href="#keepalived和vrrp简述" class="headerlink" title="keepalived和vrrp简述"></a>keepalived和vrrp简述</h2><p>网络工程师肯定是很熟悉这个vrrp了, 在华为, H3C, Cisco都有相关的技术文档. 事实上vrrp的工作原理和上面说的那些差不多了, 作为网关的路由器可以说是很重要的设备, 所以为了后端服务器的高可用, 我们会对网关进行一个冗余, 只要正在运行的, 也就是active的路由设备一直向冗余的路由设备发送心跳, 就认定成是可用的, 一段周期内, 备份的路由器如果没有心跳数据包, 就会取代这个网关路由, 保持这个通道的连续和可靠. </p>
<p>那么vrrp怎么工作的? 核心的思想就是将两个路由器构建成一个或者多个虚拟路由. 具体的实施过程是这样的, 首先, 配置成虚拟路由的多台路由器之间协商, 选举出一台Master节点, 选举主要依靠他们的优先级, 如果优先级相同, IP地址大的成为Master. 接着, Master路由周期性的发送vrrp报文, 通报自己的配置信息和工作状态. 如果Master路由出现故障, 剩余的Backup路由重新进行选举出新的Master, 并且发布一个携带虚拟IP和自己的虚拟MAC地址的免费ARP报文从而更新网络中的ARP信息. 这里的ARP报文也可以理解成是ARP欺骗.</p>
<p>当然直接这样发送报文, 不是这么的安全, 所以vrrp也支持认证功能. 包括简单的字符认证, 和MD5认证. 不过对于一个频繁发送的心跳包来说, MD5计算显然是一个很消耗性能和带宽的方式. 所以一般都会选择简单的字符认证. </p>
<p>另外, 考虑到backup路由一直处于闲置的状态, 我们可以构建<strong>双主模型</strong>. 就是说, R1和R2两台路由器, 我们可以配置两个虚拟路由器, 其中一个R1做主, 另一个R2做主. 这样还可以实现负载均衡, 还充分运用了资源.</p>
<p>keepalived就是对vrrp协议在Linux主机上的以守护进程的方式的一种实现. 能够根据配置文件自动生成ipvs规则, 并且可以对各个RS做健康状态检测.</p>
<p><img src="http://www.keepalived.org/images/Software%20Design.gif" alt="img"></p>
<p>上图就是keepalived官方的一张架构图. 可以很清楚的看到, 核心组件就是那个VRRP stack了.</p>
<h2 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># yum info keepalived</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">...(omitted)</span><br><span class="line">Available Packages</span><br><span class="line">Name        : keepalived</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 1.3.5</span><br><span class="line">Release     : 1.el7</span><br><span class="line">Size        : 327 k</span><br><span class="line">Repo        : base/7/x86_64</span><br><span class="line">Summary     : Load balancer and high availability service</span><br><span class="line">URL         : http://www.keepalived.org/</span><br><span class="line">License     : GPLv2+</span><br><span class="line">Description : Keepalived provides simple and robust facilities <span class="keyword">for</span> load balancing</span><br><span class="line">            : and high availability.  The load balancing framework relies on the</span><br><span class="line">            : well-known and widely used Linux Virtual Server (IPVS) kernel module</span><br><span class="line">            : providing layer-4 (transport layer) load balancing.  Keepalived</span><br><span class="line">            : implements a <span class="built_in">set</span> of checkers to dynamically and adaptively maintain</span><br><span class="line">            : and manage a load balanced server pool according their health.</span><br><span class="line">            : Keepalived also implements the Virtual Router Redundancy Protocol</span><br><span class="line">            : (VRRPv2) to achieve high availability with director failover.</span><br></pre></td></tr></table></figure>

<p>安装就直接yum install就行了.</p>
<p>来看看安装了那些东西吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@VM-node1 ~]<span class="comment"># rpm -ql keepalived</span></span><br><span class="line">/etc/keepalived</span><br><span class="line">/etc/keepalived/keepalived.conf</span><br><span class="line">/etc/sysconfig/keepalived</span><br><span class="line">/usr/bin/genhash</span><br><span class="line">/usr/lib/systemd/system/keepalived.service</span><br><span class="line">/usr/libexec/keepalived</span><br><span class="line">/usr/sbin/keepalived</span><br><span class="line">/usr/share/doc/keepalived-1.3.5</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/AUTHOR</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/CONTRIBUTORS</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/COPYING</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/ChangeLog</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/NOTE_vrrp_vmac.txt</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/README</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/TODO</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/keepalived.conf.SYNOPSIS</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.HTTP_GET.port</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.IPv6</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.SMTP_CHECK</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.SSL_GET</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.fwmark</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.inhibit</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.misc_check</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.misc_check_arg</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.quorum</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.sample</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.status_code</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.track_interface</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.virtual_server_group</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.virtualhost</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.localcheck</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.lvs_syncd</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.routes</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.rules</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.scripts</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.static_ipaddress</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.sync</span><br><span class="line">/usr/share/doc/keepalived-1.3.5/samples/sample.misccheck.smbcheck.sh</span><br><span class="line">/usr/share/man/man1/genhash.1.gz</span><br><span class="line">/usr/share/man/man5/keepalived.conf.5.gz</span><br><span class="line">/usr/share/man/man8/keepalived.8.gz</span><br><span class="line">/usr/share/snmp/mibs/KEEPALIVED-MIB.txt</span><br><span class="line">/usr/share/snmp/mibs/VRRP-MIB.txt</span><br><span class="line">/usr/share/snmp/mibs/VRRPv3-MIB.txt</span><br></pre></td></tr></table></figure>

<p>也很简洁, 直接看看他的配置文件吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># grep &quot;^[^[:space:]]&quot; /etc/keepalived/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.200.100 443 &#123;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 10.10.10.2 1358 &#123;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 10.10.10.3 1358 &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是全局配置 接着是vrrp相关配置, 接着就是和LVS相关的vs设定.</p>
<p>其中vrrp的配置主要分成两个部分, 一个是vrrp实例的设定, 一个是vrrp同步组的设定. 在上面的生成的文件列表中, 可以看到还有很多配置文件的示例.</p>
<p>现在我们先来说几个HA集群的配置的前提:</p>
<ul>
<li>本机主机名要和hostname以及uname -r保持一致, 并且各个节点需要能够互相解析主机名, 建议使用hosts文件进行解析.</li>
<li>各个节点的时间同步</li>
</ul>
<p>这里我们使用两台CentOS7主机, 首先我们Check一下时间:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># date; ssh 192.168.206.21 &#x27;date&#x27;</span></span><br><span class="line">Fri Oct 20 18:43:55 CST 2017</span><br><span class="line">Fri Oct 20 18:43:55 CST 2017</span><br></pre></td></tr></table></figure>

<p>没有问题, 是同步的. </p>
<p>接着检查hosts文件 ( 这一步骤对于keepalived来说没这么重要 )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.206.9	VM-node1</span><br><span class="line">192.168.206.21	VM-node2</span><br></pre></td></tr></table></figure>

<p>接着我们要确保iptables和SELinux不会成为阻碍.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># getenforce </span></span><br><span class="line">Enforcing</span><br><span class="line">[root@VM-node1 ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@VM-node1 ~]<span class="comment"># iptables -F</span></span><br><span class="line">[root@VM-node1 ~]<span class="comment"># iptables -X</span></span><br></pre></td></tr></table></figure>

<p>双节点安装keepalived. </p>
<p>好了, 准备的差不多了. 开始吧~</p>
<p>开始编辑配置文件, 先不使用后面的virtual server, 我们来看看前面的两个部分:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># cp /etc/keepalived/keepalived.conf&#123;,.bak&#125;</span></span><br><span class="line">(In-Vim):.,<span class="variable">$s</span>/^/<span class="comment">#/g  [从virtual server那一行开始操作]</span></span><br></pre></td></tr></table></figure>

<p>从第一个全局配置来看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123; <span class="comment"># 如果keepalived发现VIP进行了更换把邮件发送给谁.</span></span><br><span class="line">       root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from kaadmin@localhost <span class="comment"># 发信人</span></span><br><span class="line">   smtp_server 127.0.0.1 <span class="comment"># 邮件服务器地址</span></span><br><span class="line">   smtp_connect_timeout 30 <span class="comment"># 连接到邮件服务器的超时时长</span></span><br><span class="line">   router_id node1 <span class="comment"># id</span></span><br><span class="line">   vrrp_skip_check_adv_addr <span class="comment"># 如果指明,跳过先前接受过的同一个主路由的通告</span></span><br><span class="line">   vrrp_strict <span class="comment"># 严格模式, 阻止单播的对端, 0VIP, IPv6在VRRP V2</span></span><br><span class="line">   vrrp_garp_interval 0 <span class="comment"># 免费ARP报文发送间隔.</span></span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实还有很多配置, 在man手册中可以看到. 我们就先这样, 主要是下面的设置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123; <span class="comment"># 这里需要协商实例的名字.</span></span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass </span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">    	192.168.206.100/24 dev eth0 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于vrrp实例的配置, 我们来看看.</p>
<p>首先是<code>state</code>, 该选项的意思是初始状态标记. 后面的<code>interface</code>标识接口也就是VIP的绑定位置. 接着后面的<code>virtual_router_id</code> 该ID就比较重要了, 因为这个玩意首先是作为虚拟MAC的末尾那一位 ( 虚拟MAC的前几位是固定的00-00-5E-00-01-{VRID} ) 所以是需要保持一致的, 再往后的<code>priority</code>标识优先级, 越大的越高. <code>advert_int</code>通告的发送时间间隔.  后面的一个上下文环境是进行认证的, 类型有字符认证和md5认证, 这里使用的是简单的字符认证. 后面的虚拟IP也就是比较重要的了. 其实这里指定的就是我们的VIP. 默认使用的是抢占模式, 如果不想使用抢占模式, 那么可以指定<code>nopreempt</code>. </p>
<p>我最后修改完成的配置如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.100/24 dev eth0 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中, 随机字串是使用<code>openssl</code>输出的. OK, 接下来把配置文件拷贝到第二台主机上.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># scp /etc/keepalived/keepalived.conf VM-node2:/etc/keepalived/</span></span><br></pre></td></tr></table></figure>

<p>备用节点需要做稍微的修改:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.100/24 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来, 启动服务吧!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># systemctl start keepalived ; ssh VM-node2 &#x27;systemctl start keepalived&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查看一下进程和接口:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node2 ~]<span class="comment"># ps aux | grep keepalived</span></span><br><span class="line">root       3092  0.0  0.1 120740  1408 ?        Ss   19:32   0:00 /usr/sbin/keepalived -D</span><br><span class="line">root       3093  0.0  0.2 120740  2764 ?        S    19:32   0:00 /usr/sbin/keepalived -D</span><br><span class="line">root       3094  0.0  0.2 125104  2660 ?        S    19:32   0:00 /usr/sbin/keepalived -D</span><br></pre></td></tr></table></figure>

<p>在node1上:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># ifconfig </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.9  netmask 255.255.255.0  broadcast 192.168.206.255</span><br><span class="line">        inet6 fe80::1c:8a20:479a:ddc0  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:b0:97:f6  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 116014  bytes 20485653 (19.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 144513  bytes 10838375 (10.3 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.100  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:b0:97:f6  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而在node2上, 你是看不到的. 为什么? 因为node2是从节点啊~</p>
<p>这个时候 我们手动关闭node1的keepalived服务, 接着立即去node2查看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node2 ~]<span class="comment"># ifconfig </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.21  netmask 255.255.255.0  broadcast 192.168.206.255</span><br><span class="line">        inet6 fe80::1c:8a20:479a:ddc0  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        inet6 fe80::2e92:22f5:af33:2394  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:71:99:af  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 88514  bytes 14361599 (13.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 70290  bytes 5571477 (5.3 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.100  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:71:99:af  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从passive变成了active了. 然而, 当我们重新恢复node1的服务的时候, 由于默认是抢占模式, 所以node1就重新变成active状态了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">[root@VM-node1 ~]<span class="comment"># ifconfig </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.9  netmask 255.255.255.0  broadcast 192.168.206.255</span><br><span class="line">        inet6 fe80::1c:8a20:479a:ddc0  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:b0:97:f6  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 116439  bytes 20524771 (19.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 145291  bytes 10898289 (10.3 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.206.100  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:b0:97:f6  txqueuelen 1000  (Ethernet)</span><br></pre></td></tr></table></figure>

<p>但是有的时候, 我们希望能够进行服务的升级, 所以就需要让主服务器暂时成为从的, 升级之后, 再成为主的, 升级从服务器. 这个时候我就需要平滑的修改主从服务器的优先级, 而vrrp脚本功能就能满足我们的需求, 来看一个示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_maintenance &#123;</span><br><span class="line">    script <span class="string">&quot;[[ -f /etc/keepalived/mt ]] &amp;&amp; exit 0 || exit 1&quot;</span></span><br><span class="line">    interval 1 </span><br><span class="line">    weight -2</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	...(omitted)</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_maintenance</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>只要脚本返回值不是0, 就会执行下面的操作, 也就是将权重-2, 接着在实例中启动这个脚本.</p>
<blockquote>
<p>在这里插一句, 首先新版本似乎不支持这种方式了, 仅允许在这里指定文件系统中的脚本路径. 第二, 不知道是我的操作有问题还是这个版本的keepalived有Bug(当然我觉得还是我的问题), 当我每次重启动keepalived的时候, 首次执行就会判定脚本执行成功, 于是执行下面的语句调整, 接着就一直正常执行, 但是这个时候我们的优先级是调整过的了, 所以说, 当我们把文件创建的时候, 反而会将减少的优先级加出来 ( 也就是说脚本的功能完全发生了相反的效果??. ) 于是我就在这里debug了很长时间. 还是不知道是怎么回事. 烦死了 </p>
</blockquote>
<p>就先当做keepalived没有这个功能吧. 继续往后.</p>
<blockquote>
<p>于是不甘于失败的我又进行了尝试. 结论是: <strong>脚本失败的时候, 会执行后面的指令. 如果脚本执行成功就不会触发.</strong> 所以上面的结论没要毛病, 所以完完全全是我的错, 所以我真的好气哦, 所以上面的脚本写反了 应该是<code>&quot;[[ -f /etc/keepalived/mt ]] &amp;&amp; exit 1 || exit 0&quot;</code> ( 耽误了好多时间烦死了 )</p>
</blockquote>
<p>行吧, 这样我们只要在指定的地方touch一个mt就可以实现主从切换了. </p>
<p>接下来来看一下同步组的设定. 我们知道当VIP发生改变的时候, 必须把后面接口的DIP也做转交, 这两个过程是同步的, 所以就需要绑定成组. 方法很简单, 只要使用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">	VI_1</span><br><span class="line">	VI_2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就行了, 同样这个也有一些选项的. 不过就先不说了.</p>
<p>接着我们看一下发生状态了之后 怎么进行通知呢? 我们发现, 当刚刚做实验得时候 好像没有出现接收到邮件的情况. 这是以为, 邮件的发送是需要我们自行定义邮件内容和发送脚本的.</p>
<p>具体的定制选项在这里: ( 可以在vrrp实例和同步组中定义 )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">notify_master <span class="string">&quot;PATH/TO/SCRIPT master&quot;</span></span><br><span class="line">notify_backup <span class="string">&quot;PATH/TO/SCRIPT backup&quot;</span></span><br><span class="line">notify_fault <span class="string">&quot;PATH/TO/SCRIPT fault&quot;</span></span><br></pre></td></tr></table></figure>

<p>一个典型的脚本实例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">vip=192.168.206.100</span><br><span class="line">contact=<span class="string">&quot;root@localhost&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">notify</span></span> () &#123;</span><br><span class="line">  mailsubject=<span class="string">&quot;`hostname` to be <span class="variable">$1</span>: <span class="variable">$vip</span> floating.&quot;</span></span><br><span class="line">  mailbody=<span class="string">&quot;`date &#x27;+%F %H:%M:%S&#x27;` : vrrp transition, `hostname` changed to be <span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$mailbody</span> | mail -s <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="variable">$contact</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  master)</span><br><span class="line">      notify master</span><br><span class="line">      <span class="comment"># haproxy start</span></span><br><span class="line">      <span class="built_in">exit</span> 0</span><br><span class="line">  ;;</span><br><span class="line">  backup)</span><br><span class="line">      notify backup</span><br><span class="line">      <span class="comment"># haproxy stop</span></span><br><span class="line">      <span class="built_in">exit</span> 0</span><br><span class="line">  ;;</span><br><span class="line">  fault)</span><br><span class="line">      notify fault</span><br><span class="line">      <span class="comment"># haproxy stop</span></span><br><span class="line">      <span class="built_in">exit</span> 0</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Usage: `basename <span class="variable">$0</span>` &#123;master|backup|fault&#125;&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>但是到现在为止, 我们都只是在玩玩而已, 还没有发挥keepalived作为LVS的高可用功能. 所以现在就来看下关于LVS的设定吧.</p>
<p>在manual中, LVS的设定都用virtual server这个关键字来说明, 可以使用IP地址, 也可以使用防火墙标记.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># delay timer for service polling</span></span><br><span class="line">delay_loop &lt;INT&gt; <span class="comment"># 健康状态探查的时间间隔.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LVS scheduler</span></span><br><span class="line">lb_algo rr|wrr|lc|wlc|lblc|sh|dh <span class="comment"># 负载均衡的调度算法.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable One-Packet-Scheduling for UDP (-O in ipvsadm)</span></span><br><span class="line">ops <span class="comment"># 每一个报文单独调度, 也就是对UDP的追踪</span></span><br><span class="line"><span class="comment"># LVS forwarding method</span></span><br><span class="line">lb_kind NAT|DR|TUN <span class="comment"># LVS的类型</span></span><br><span class="line"><span class="comment"># LVS persistence timeout in seconds, default 6 minutes</span></span><br><span class="line">persistence_timeout [&lt;INT&gt;] <span class="comment"># 持久的延时</span></span><br><span class="line"><span class="comment"># L4 protocol</span></span><br><span class="line">protocol TCP|UDP|SCTP <span class="comment"># 协议</span></span><br><span class="line"><span class="comment"># If VS IP address is not set,</span></span><br><span class="line"><span class="comment"># suspend healthchecker&#x27;s activity</span></span><br><span class="line">ha_suspend <span class="comment"># 如果IP没有就不做测试</span></span><br><span class="line"><span class="comment"># VirtualHost string for HTTP_GET or SSL_GET</span></span><br><span class="line"><span class="comment"># eg virtualhost www.firewall.loc</span></span><br><span class="line">virtualhost &lt;STRING&gt;</span><br><span class="line"><span class="comment"># RS to add when all realservers are down</span></span><br><span class="line">sorry_server &lt;IPADDR&gt; &lt;PORT&gt; <span class="comment"># 这里就是设定最后的错误页面提供服务器的</span></span><br><span class="line"><span class="comment"># one entry for each realserver</span></span><br><span class="line">real_server &lt;IPADDR&gt; &lt;PORT&gt; <span class="comment"># 这就是最重要的real server的设定了</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># relative weight to use, default: 1</span></span><br><span class="line">    weight &lt;INT&gt; <span class="comment"># 权重设定</span></span><br><span class="line">    <span class="comment"># Set weight to 0 when healthchecker detects failure</span></span><br><span class="line">    inhibit_on_failure</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Script to execute when healthchecker</span></span><br><span class="line">    <span class="comment"># considers service as up.</span></span><br><span class="line">    notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br><span class="line">    <span class="comment"># Script to execute when healthchecker</span></span><br><span class="line">    <span class="comment"># considers service as down.</span></span><br><span class="line">    notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt; <span class="comment"># 同样也是发通知的</span></span><br><span class="line"></span><br><span class="line">    uthreshold &lt;INTEGER&gt; <span class="comment"># maximum number of connections to server</span></span><br><span class="line">    lthreshold &lt;INTEGER&gt; <span class="comment"># minimum number of connections to server # 设定最大最小连接数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pick one healthchecker</span></span><br><span class="line">    <span class="comment"># HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|DNS_CHECK|MISC_CHECK # 这里就是设定健康状态检查的.</span></span><br><span class="line">    HTTP_GET|SSL_GET</span><br><span class="line">	&#123;</span><br><span class="line">      <span class="comment"># An url to test</span></span><br><span class="line">      <span class="comment"># can have multiple entries here</span></span><br><span class="line">      url &#123;</span><br><span class="line">        <span class="comment">#eg path / , or path /mrtg2/</span></span><br><span class="line">        path &lt;STRING&gt; <span class="comment"># 请求的资源</span></span><br><span class="line">        <span class="comment"># healthcheck needs status_code</span></span><br><span class="line">        <span class="comment"># or status_code and digest</span></span><br><span class="line">        <span class="comment"># Digest computed with genhash</span></span><br><span class="line">        <span class="comment"># eg digest 9b3a0c85a887a256d6939da88aabd8cd</span></span><br><span class="line">        digest &lt;STRING&gt; <span class="comment"># 对返回的页面做摘要计算, 如果和这里一样就是健康的</span></span><br><span class="line">        <span class="comment"># status code returned in the HTTP header</span></span><br><span class="line">        <span class="comment"># eg status_code 200. Default is any 2xx value</span></span><br><span class="line">        status_code &lt;INT&gt; <span class="comment"># 对响应码做匹配, 什么样的认定为是健康的, 一般和摘要选择一个就行了, 但是两者都有可以的</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment"># number of get retries</span></span><br><span class="line">      nb_get_retry &lt;INT&gt;</span><br><span class="line">      <span class="comment"># delay before retry</span></span><br><span class="line">      delay_before_retry &lt;INT&gt;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们再看看TCP的健康检查:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP healthchecker</span></span><br><span class="line">TCP_CHECK</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># ======== generic connection options</span></span><br><span class="line">    <span class="comment"># Optional IP address to connect to.</span></span><br><span class="line">    <span class="comment"># The default is the realserver IP</span></span><br><span class="line">    connect_ip &lt;IP ADDRESS&gt;</span><br><span class="line">    <span class="comment"># Optional port to connect to</span></span><br><span class="line">    <span class="comment"># The default is the realserver port</span></span><br><span class="line">    connect_port &lt;PORT&gt;</span><br><span class="line">    <span class="comment"># Optional interface to use to</span></span><br><span class="line">    <span class="comment"># originate the connection</span></span><br><span class="line">    bindto &lt;IP ADDRESS&gt;</span><br><span class="line">    <span class="comment"># Optional source port to</span></span><br><span class="line">    <span class="comment"># originate the connection from</span></span><br><span class="line">    bind_port &lt;PORT&gt;</span><br><span class="line">    <span class="comment"># Optional connection timeout in seconds.</span></span><br><span class="line">    <span class="comment"># The default is 5 seconds</span></span><br><span class="line">    connect_timeout &lt;INTEGER&gt;</span><br><span class="line">	...(omitted)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上我们也就使用这两种了. </p>
<h2 id="项目-LVS-keepalived实现基础高可用"><a href="#项目-LVS-keepalived实现基础高可用" class="headerlink" title="项目: LVS + keepalived实现基础高可用"></a>项目: LVS + keepalived实现基础高可用</h2><p>我们一共开启四台虚拟机, 首先做director的有两台, 一台主节点, 一台做备份. 另外两台后端real server跑Web服务(httpd).</p>
<p>他们的IP分别是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VIP:  192.168.206.11</span><br><span class="line">DIP1: 192.168.206.9</span><br><span class="line">DIP2: 192.168.206.10</span><br><span class="line">RIP1: 192.168.206.22</span><br><span class="line">RIP2: 192.168.206.23</span><br></pre></td></tr></table></figure>

<p>哦 对了,这里我们选择使用DR集群.</p>
<p>先来确保需要使用的软件包存在: httpd, ipvsadm(不是必须的,仅仅是为了观察实验效果), keepalived, mailx.</p>
<p>接着先配置director的VIP, real server的内核参数, 添加VIP, 添加路由, 添加ipvs规则. 现在是很熟练了.</p>
<p>好了, 现在我们的第一个director就没问题了, 接着我们把规则清空, IP拿掉. 进入另外一个director, 进行同样的配置, 进行测试, 如果没有问题的话, 我们就可以进行配置sorry server了, 对于两个director, 安装httpd, 写入一个sorry页面, 并且启动服务.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node2 ~]<span class="comment"># echo &quot;Sorry, under maintenance&quot; &gt; /var/www/html/index.html </span></span><br><span class="line">[root@VM-node2 ~]<span class="comment"># httpd</span></span><br></pre></td></tr></table></figure>

<p>好了, 主角上场了, 我们最后的配置是这样的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@127.0.0.1</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from kaadmin@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_maintenance &#123;</span><br><span class="line">    script /etc/keepalived/chk_maintenance</span><br><span class="line">    interval 1</span><br><span class="line">    weight -5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 98</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.11/32 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_maintenance</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.206.11 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 192.168.206.22 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /</span><br><span class="line">              status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.206.23 80 &#123;</span><br><span class="line">        weight 2</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /</span><br><span class="line">              status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把这份配置复制连同脚本拷贝到另一个director上, 并且稍作修改.</p>
<p><strong>激动人心的时候到来了! 启动服务</strong></p>
<p>尝试访问, 成功了! 我们的ipvs规则, 自动的被填充了.</p>
<p>访问效果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;It works! (From node3)&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;It works! (From node3)&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>好, 现在我们把其中一个real server下线:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node3 ~]<span class="comment"># service httpd stop</span></span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br></pre></td></tr></table></figure>

<p>这个时候连规则都会进行重写:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.206.11:80 wrr</span><br><span class="line">  -&gt; 192.168.206.23:80            Route   2      0          3      </span><br></pre></td></tr></table></figure>

<p>访问自然是没有问题的. </p>
<p>同时维护第一台主机也是可以的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]<span class="comment"># cd /etc/keepalived/</span></span><br><span class="line">[root@VM-node1 keepalived]<span class="comment"># touch down</span></span><br><span class="line">[root@VM-node1 keepalived]<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:b0:97:f6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.206.9/24 brd 192.168.206.255 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1c:8a20:479a:ddc0/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>这个是就是第二台从节点顶替上来了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>访问仍然正常. 最后我们加上sorry_server的设定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.206.11 80 &#123;</span><br><span class="line">	...(omitted)</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 192.168.206.22 80 &#123;</span><br><span class="line">	...(omitted)</span><br></pre></td></tr></table></figure>

<p>两边都做一样的设定, 接着我们重启服务之后将两个real server都手动关闭服务.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">Sorry, under maintenance</span><br></pre></td></tr></table></figure>

<p>同时, 我们的调度规则也发生改变.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 keepalived]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.206.11:80 wrr</span><br><span class="line">  -&gt; 127.0.0.1:80                 Route   1      0          0    </span><br></pre></td></tr></table></figure>

<p>就是这样的一个过程. </p>
<blockquote>
<p>中途关于邮件我一直没有提到, 其实会在实验中一直受到邮件的, 当然了, 前提是你要安装邮件程序包.</p>
</blockquote>
<p>接下来把两台的服务开起来, 瞬间复活~.</p>
<h2 id="项目-Nginx-keepalived实现基础高可用"><a href="#项目-Nginx-keepalived实现基础高可用" class="headerlink" title="项目: Nginx + keepalived实现基础高可用"></a>项目: Nginx + keepalived实现基础高可用</h2><p>首先, 我们很清楚了, Nginx是不需要real server的, 他需要的是upstream server就行了. 所以我们要先把之前的操作, 也就是那些IP地址删除, 路由删除, 内核参数还原. </p>
<p>好了 环境恢复了之后, 安装必要的软件包: Nginx.</p>
<p>开始配置Nginx的上游服务器组和调度, 这也是很熟练了的.</p>
<p>尝试访问, 是正常的就可以继续了. nginx和keepalived的基础高可用是很简单的.</p>
<p>这里, 由于我们不需要ipvs, 所以不需要virtual server了, 可以全部注释掉:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script /etc/keepalived/chk_nginx</span><br><span class="line">    interval 1</span><br><span class="line">    weight -10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 98</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.11/24 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_maintenance</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用的脚本也很简单, 你也可以添加更复杂的机制. 主要的原理就是想nginx发送0号信号, 如果返回值不是0, 就说明nginx存活. 这样我们连exit语句也可以省略:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 keepalived]<span class="comment"># cat chk_nginx </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">$(killall -0 nginx)</span><br></pre></td></tr></table></figure>

<p>接下来启动keepalived服务吧. 访问是正常的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;It works! (From node3)&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>然而, 当我们关闭主节点的nginx服务的时候:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 keepalived]<span class="comment"># nginx -s stop</span></span><br><span class="line">[root@VM-node1 keepalived]<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:b0:97:f6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.206.9/24 brd 192.168.206.255 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1c:8a20:479a:ddc0/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<p>继续访问:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;web on Node4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;It works! (From node3)&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo</span><br><span class="line">λ curl 192.168.206.11</span><br><span class="line">&lt;h1&gt;It works! (From node3)&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>仍然没有问题. VIP也已经转交给了次节点:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Oct 21 11:49:04 VM-node2 Keepalived_vrrp[68777]: VRRP_Script(chk_maintenance) succeeded</span><br><span class="line">Oct 21 11:50:11 VM-node2 Keepalived_vrrp[68777]: VRRP_Instance(VI_1) forcing a new MASTER election</span><br><span class="line">Oct 21 11:50:12 VM-node2 Keepalived_vrrp[68777]: VRRP_Instance(VI_1) Transition to MASTER STATE</span><br><span class="line">Oct 21 11:50:13 VM-node2 Keepalived_vrrp[68777]: VRRP_Instance(VI_1) Entering MASTER STATE</span><br><span class="line">Oct 21 11:50:13 VM-node2 Keepalived_vrrp[68777]: VRRP_Instance(VI_1) setting protocol iptable drop rule</span><br><span class="line">Oct 21 11:50:13 VM-node2 Keepalived_vrrp[68777]: VRRP_Instance(VI_1) setting protocol VIPs.</span><br></pre></td></tr></table></figure>

<p>但是这样其实有个问题的. 想一下, 如果我们两边的Nginx服务都死了. 于是双方的weight都下降最后还是没有区别啊, 所以, 这样的一种解决方案就是在notify脚本中添加当状态发生改变的时候自动重启Nginx服务. 但是这很强硬, 有点太粗糙了.</p>
<p>不过起码可用.</p>
<p>接下来我们玩一个好玩的, 我们继续Nginx+Keepalived的组合, 组建一个双主模型的高可用集群.</p>
<p>首先当然我们需要两个vrrp实例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script /etc/keepalived/chk_nginx</span><br><span class="line">    interval 1</span><br><span class="line">    weight -10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.11/24 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 2</span><br><span class="line">    priority 98</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 700c8be7b50</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.206.12/24 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个做主, 一个做备. 另外一个节点也是如此, 只不过主备颠倒. 这样就可以实现一个双主的模型.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">Tags</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">高可用集群基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived%E5%92%8Cvrrp%E7%AE%80%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">keepalived和vrrp简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">keepalived配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE-LVS-keepalived%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">项目: LVS + keepalived实现基础高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE-Nginx-keepalived%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">项目: Nginx + keepalived实现基础高可用</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&text=keepalived"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&is_video=false&description=keepalived"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=keepalived&body=Check out this article: https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&title=keepalived"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&name=keepalived&description=&lt;p&gt;打开高可用的探索之门~&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2017/10/20/keepalived%E4%B8%8Evrrp%E5%8D%8F%E8%AE%AE/&t=keepalived"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Yaoxuan Wei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'yaoxuannn-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
