<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="接下来我们就来更加深入的来看一下Varnish的相关.">
<meta property="og:type" content="article">
<meta property="og:title" content="Varnish的状态引擎和VCL">
<meta property="og:url" content="https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/index.html">
<meta property="og:site_name" content="Yaoxuannn&#39;s Blog">
<meta property="og:description" content="接下来我们就来更加深入的来看一下Varnish的相关.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/varnish_statusV3.png">
<meta property="og:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/varnish_statusV4.png">
<meta property="og:image" content="http://book.varnish-software.com/4.0/_images/detailed_fsm.svg">
<meta property="article:published_time" content="2018-09-10T17:41:58.000Z">
<meta property="article:modified_time" content="2020-11-30T01:48:15.000Z">
<meta property="article:author" content="Yaoxuan Wei">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Varnish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hexopic.s3-ap-northeast-1.amazonaws.com/varnish_statusV3.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Varnish的状态引擎和VCL</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018/09/14/Java%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB%E5%92%8Ctomcat%E5%88%9D%E8%AF%86/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2018/09/08/Varnish%E5%88%9D%E8%A7%81/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&text=Varnish的状态引擎和VCL"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&is_video=false&description=Varnish的状态引擎和VCL"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Varnish的状态引擎和VCL&body=Check out this article: https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&name=Varnish的状态引擎和VCL&description=&lt;p&gt;接下来我们就来更加深入的来看一下Varnish的相关.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&t=Varnish的状态引擎和VCL"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">状态引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VCL%E5%8F%82%E8%80%83"><span class="toc-number">2.</span> <span class="toc-text">VCL参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.</span> <span class="toc-text">变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bereq"><span class="toc-number">2.1.1.</span> <span class="toc-text">bereq</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#beresp"><span class="toc-number">2.1.2.</span> <span class="toc-text">beresp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#obj"><span class="toc-number">2.1.3.</span> <span class="toc-text">obj</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server"><span class="toc-number">2.1.4.</span> <span class="toc-text">Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">2.3.</span> <span class="toc-text">模式匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">负载均衡</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Varnish的状态引擎和VCL
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Yaoxuan Wei</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-09-10T17:41:58.000Z" class="dt-published" itemprop="datePublished">2018-09-10</time>
        
        (Updated: <time datetime="2020-11-30T01:48:15.000Z" class="dt-updated" itemprop="dateModified">2020-11-29</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Linux/" rel="tag">Linux</a>, <a class="p-category" href="/tags/Varnish/" rel="tag">Varnish</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>接下来我们就来更加深入的来看一下Varnish的相关.</p>
<span id="more"></span>

<p>我们之前已经通过使用Varnish所提供的命令行工具进行了一些基本的配置. 并且还知道可以通过对<code>varnish.param</code>文件的配置来操作他启动的一些行为参数.</p>
<p>Varnish的缓存功能配置主要都是通过编译和执行vcl来进行操作的, 那么为了能够操作Varnish进行负载均衡, 是否进行对Backend服务器群的健康状态检测等等, 就需要通过VCL来进行定义了.</p>
<h2 id="状态引擎"><a href="#状态引擎" class="headerlink" title="状态引擎"></a>状态引擎</h2><p>VCL是一种域配置文件, 因此我们对VCL的配置操作对象就是很多类似我们代码块一样的东西, 只不过这里被叫做<strong>域</strong>. 这里我们就可以引入varnish的状态引擎了.</p>
<p>那么什么是状态引擎呢, 这个可以类比我们之前学习过的<code>netfilter</code>的钩子函数. 由于到达我们varnish的请求可能是请求静态资源的, 可能是请求动态资源的, 也有可能是非法访问, 还有可能是请求的方法不支持或者不允许. 这么多情况, 他们都需要不同的应对措施, 这个就是varnish的状态引擎.</p>
<p>首先我们来看一下V3版本的状态引擎吧:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/varnish_statusV3.png" alt="varnish_statusV3"></p>
<p>这个图是一个简化版本, 类似流程图一样的东西. 这里的每一个矩形都代表一个状态引擎.</p>
<p>从图中, 我们可以很清楚的看到, 当用户的请求达到时, 我们的<code>vcl_recv</code>引擎先来进行处理, 如果请求的对象是可以被缓存的,那么就会去到下一个状态引擎, 如果不能被缓存. 那就会变得很简单了, 请求将会直接到达<code>vcl_fetch</code>状态, 由这个引擎来负责去后端服务器来取得数据.最后交给<code>vcl_deliver</code>来返回给用户.</p>
<p>如果之前的状态是<code>vcl_hash</code>. Varnish就会在自己的缓存空间中进行寻找, 如果可以找到,  就会进入命中状态, 如果没有就是miss状态, 接着交给fetch状态引擎去后台服务器取得数据, 然后一边缓存到自己的空间中, 一边将结果返回给用户.</p>
<p>这里我们也可以看到, 各个引擎之间是存在相关性的, 前一个engine如果可以有多个下游engine, 则上游需要使用return来指明要转移的下游engine.</p>
<p> 接下来我们来看一下完全版的一个WORKFLOW:</p>
<p><img src="http://hexopic.s3-ap-northeast-1.amazonaws.com/varnish_statusV4.png" alt="varnish_statusV4"></p>
<p>我们刚刚说过, 上一个engine使用return来返回下一个engine, 这里我们就能看到, 根据<code>vcl_recv</code>所返回的值不同, 到达的下一个engine也不一样. 例如说, 如果说用户发送过来的请求是不可缓存的, 那就没与必要去自己的缓存空间里寻找了, 于是就会返回pass, 直接到达<code>vcl_pass</code>. </p>
<blockquote>
<p>VCL的语法:</p>
<p>这里我们稍微穿插一点关于VCL语法的小东西: 对于每一个状态引擎, 我们通过使用<code>sub</code>关键字来声明, 例如说, 如果对<code>vcl_recv</code>进行操作, 就需要有类似下面的声明语句:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">	<span class="comment">// 这是注释</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到, 这里使用了双斜线来注释, 除此之外, 还可以通过<code>#</code>, <code>/* foo */</code>来实现单行和多行注释.</p>
<p>对于每一个Varnish的状态引擎, 都要很多内部定义好的内置变量供你调用, 这些变量他们的使用都是限制在状态里的(state-limited), 另外, vcl没有循环语句, 但是存在条件判断和分支语句.</p>
<p>通过在域中使用<code>return</code>函数来进行状态引擎的跳转. 除此之外, 还有很多内置函数, 具体就需要查阅官方的文档了.</p>
<p>操作符包括: <code>=, ==, ~, !, &amp;&amp;, ||</code>.</p>
</blockquote>
<p>现在我们来看一个典型的vcl配置:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.restarts == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.http.x-forwarded-<span class="keyword">for</span>) &#123;</span><br><span class="line">            <span class="built_in">set</span> req.http-X-Forwarded-For = </span><br><span class="line">                req.http.X-Forwarded-For + <span class="string">&quot;,&quot;</span> + client.ip;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">set</span> req.http.X-Forwarded-For = client.ip;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.request != <span class="string">&#x27;GET&#x27;</span> &amp;&amp; req.request != <span class="string">&quot;HEAD&quot;</span> &amp;&amp;</span><br><span class="line">        req.request != <span class="string">&quot;PUT&quot;</span> &amp;&amp; req.request != <span class="string">&quot;POST&quot;</span> &amp;&amp;</span><br><span class="line">       	req.request != <span class="string">&quot;POST&quot;</span> &amp;&amp; rq.request != <span class="string">&quot;TRACE&quot;</span> &amp;&amp;</span><br><span class="line">        req.request != <span class="string">&quot;OPTIONS&quot;</span> &amp;&amp; req.request != <span class="string">&quot;DELETE&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (pipe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.request != <span class="string">&quot;GET&quot;</span> &amp;&amp; req.request != <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (pass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (lookup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应该还是挺好看懂的吧. 设置变量的关键字就是<code>set</code>. </p>
<p>假如说现在我们的请求到达了上面vcl的最后一句<code>return (lookup)</code>, 也就是到达了下一个状态引擎<code>vcl_hash</code>, 这里会发生什么呢? 同样我们还是看一个示例:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_hash &#123;</span><br><span class="line">    hash_data(req.url);</span><br><span class="line">    <span class="keyword">if</span> (req.http.post) &#123;</span><br><span class="line">        hash_data(req.http.host);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hash_data(server.ip);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算得到hash, 也即是缓存的键之后就可以去尝试命中缓存了.</p>
<p>接下来的过程就省略掉了, 我们直接来小结一下, 各个状态引擎的工作流:</p>
<ul>
<li>vcl_recv -&gt; vcl_hash -&gt; vcl_hit -&gt; vcl_deliver 理想的状态, 命中缓存</li>
<li>vcl_recv -&gt; vcl_hash -&gt; vcl_miss -&gt; vcl_fetch -&gt; vcl_deliver 请求的资源可以缓存但是没有命中缓存</li>
<li>vcl_recv -&gt; vcl_pass -&gt; vcl_fetch -&gt; vcl_deliver 请求的资源无法被缓存, 直接到后台服务器去取数据</li>
<li>vcl_recv -&gt; vcl_pipe 请求不能理解, 直接发送到后端服务器</li>
</ul>
<p>顺便一提, 我们这里列出来的状态引擎仍然不全, 这里列出来的只是前端处理的engine, 之前我们在说到varnish的子进程的时候, 提到过, 有一个专门负责和后台服务器进行交互的进程, 这个进程的状态引擎幼又包括: <code>vcl_backend_fetch</code>, <code>vcl_backend_response</code>, <code>vcl_backend_error</code>. 另外还有用来进行缓存删除的状态引擎: <code>vcl_synth</code>和<code>vcl_purge</code>.</p>
<p>最后, 我们来看一下官方给出的图:</p>
<p><img src="http://book.varnish-software.com/4.0/_images/detailed_fsm.svg" alt="Varnish_workflow"></p>
<p>接下来我们把官方给出的<code>vcl_recv</code>的示例拷贝到我们的配置文件中, 也即是:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">&quot;PRI&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">/* We do not support SPDY or HTTP/2.0 */</span></span><br><span class="line">        <span class="keyword">return</span> (synth(<span class="number">405</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method != <span class="string">&quot;GET&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;HEAD&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;PUT&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;POST&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;TRACE&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;OPTIONS&quot;</span> &amp;&amp;</span><br><span class="line">      req.method != <span class="string">&quot;DELETE&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">/* Non-RFC2616 or CONNECT which is weird. */</span></span><br><span class="line">        <span class="keyword">return</span> (pipe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.method != <span class="string">&quot;GET&quot;</span> &amp;&amp; req.method != <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">/* We only deal with GET and HEAD by default */</span></span><br><span class="line">        <span class="keyword">return</span> (pass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.http.Authorization || req.http.Cookie) &#123;</span><br><span class="line">        <span class="comment">/* Not cacheable by default */</span></span><br><span class="line">        <span class="keyword">return</span> (pass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们复制一份配置文件, 然后使用varnish的命令行工具来进行载入:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vcl.list</span><br><span class="line">200        </span><br><span class="line">active          0 boot</span><br><span class="line"></span><br><span class="line">vcl.load test1 new.vcl</span><br><span class="line">200        </span><br><span class="line">VCL compiled.</span><br><span class="line">vcl.list</span><br><span class="line">200        </span><br><span class="line">active          0 boot</span><br><span class="line">available       0 test1</span><br><span class="line">                           </span><br><span class="line"><span class="meta prompt_">varnish&gt; </span><span class="language-bash">vcl.use test1</span></span><br><span class="line">200        </span><br><span class="line">VCL &#x27;test1&#x27; now active</span><br><span class="line">vcl.list </span><br><span class="line">200        </span><br><span class="line">available       0 boot</span><br><span class="line">active          0 test1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先我们使用<code>load</code>来编译这个VCL, 接着再声明我们使用它就行了. 还可以通过<code>show</code>命令来查看当前的VCL的内容.</p>
<p>但是这个默认行为我们更换之后还是没法看出效果, 现在我们来对<code>vcl_deliver</code>这个地方来进行一些设定:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_deliver &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj.hits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> resp.http.X-Cache = <span class="string">&quot;HIT&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">set</span> resp.http.X-Cache = <span class="string">&quot;MISS&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加进去之后我们再通过load和use命令来使得新修改的vcl文件生效.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vcl.<span class="built_in">list</span></span><br><span class="line"><span class="number">200</span>        </span><br><span class="line">available       <span class="number">0</span> boot</span><br><span class="line">active          <span class="number">0</span> test1</span><br><span class="line"></span><br><span class="line">vcl.load test2 new.vcl</span><br><span class="line"><span class="number">200</span>        </span><br><span class="line">VCL compiled.</span><br><span class="line">vcl.use test2</span><br><span class="line"><span class="number">200</span>        </span><br><span class="line">VCL <span class="string">&#x27;test2&#x27;</span> now active</span><br><span class="line">vcl.<span class="built_in">list</span></span><br><span class="line"><span class="number">200</span>        </span><br><span class="line">available       <span class="number">0</span> boot</span><br><span class="line">available       <span class="number">0</span> test1</span><br><span class="line">active          <span class="number">0</span> test2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来我们来使用curl进行模拟请求, 现在后台Web服务器上新建一些客户端没有访问过的新页面:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node0 html]# for n in &#123;1..10&#125;; do echo &quot;&lt;h1&gt;Web Page $n on WebServer1&lt;/h1&gt;&quot; &gt; test$n.html; done</span><br><span class="line">[root@VM-node0 html]# ls</span><br><span class="line">forum  index.html  index.php  test10.html  test1.html  test2.html  test3.html  test4.html  test5.html  test6.html  test7.html  test8.html  test9.html  wordpress</span><br></pre></td></tr></table></figure>

<p>接下来就来使用curl进行请求,请求的效果如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 ~]# curl -I 192.168.16.100:6081/index.html </span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 01:25:26 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Fri, 20 Oct 2017 16:27:33 GMT</span><br><span class="line">ETag: &quot;19-55bfcf32d89d7&quot;</span><br><span class="line">Content-Length: 25</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 32770 3</span><br><span class="line">Age: 6</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: HIT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@VM-node1 ~]# curl -I 192.168.16.100:6081/test1.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 01:25:39 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 7</span><br><span class="line">Age: 0</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: MISS</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@VM-node1 ~]# curl -I 192.168.16.100:6081/test1.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 01:25:39 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 32772 8</span><br><span class="line">Age: 1</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: HIT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以很清晰的看到我们自定义的头部被添加到了响应头中, 并且第一次访问<code>test1.html</code>的时候, 我们的状态是没有命中的, 但是在第二次访问的时候我们就是命中缓存了. </p>
<h2 id="VCL参考"><a href="#VCL参考" class="headerlink" title="VCL参考"></a>VCL参考</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>来说明一下上面添加的<code>obj.hit</code>是什么意思呢, 很简单. 这个参数记录着请求的对象命中缓存的次数. 更多的对象和参数解释可以在下面的网站得到参考:</p>
<p><a target="_blank" rel="noopener" href="https://varnish-cache.org/docs/4.1/reference/vcl.html#variables">Varnish参考-变量</a></p>
<p>我们接下来整理一下这些变量的类型有哪些, 以及这些变量都是如何抽象的:</p>
<ul>
<li>req: 就是用户发送过来的请求</li>
<li>bereq: 对后端服务器发送过去的请求</li>
<li>resp: 向用户发送的响应对象</li>
<li>bresp: 后端服务器发送过来的响应对象</li>
<li>storage: 对于我们从缓存存储空间的抽象</li>
<li>obj: 请求的对象</li>
<li>client: 用户和客户端</li>
<li>server: 就是varnish自己</li>
</ul>
<p>更多的信息还是直接在官方站点上进行参考. 这里我们就列举一些比较常用的属性在这里:</p>
<h4 id="bereq"><a href="#bereq" class="headerlink" title="bereq"></a>bereq</h4><p>bereq.http.HEADERS: 由Varnish发往backend server的请求报文的指定首部.</p>
<p>bereq.request: 请求方法</p>
<p>bereq.url: 所请求的目标URL</p>
<p>bereq.proto: 向后端服务器请求的协议版本</p>
<p>bereq.backend: 请求的后端主机</p>
<h4 id="beresp"><a href="#beresp" class="headerlink" title="beresp"></a>beresp</h4><p>beresp.proto: 后端服务器返回的协议版本</p>
<p>beresp.status: 响应状态吗</p>
<p>beresp.reason: 原因短语, 就是跟在我们的状态码之后的那个字符串</p>
<p>beresp.backend.ip: </p>
<p>beresp.backend.name:</p>
<p>beresp.http.HEADER: 从后端服务器所响应的报文的首部</p>
<p>beresp.ttl: 后端服务器响应的内容的剩余时间</p>
<h4 id="obj"><a href="#obj" class="headerlink" title="obj"></a>obj</h4><p>obj.hits: 对象的命中次数</p>
<p>obj.ttl:  对象的ttl值.</p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><p>server.ip: </p>
<p>server.hostname:</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ban(expression)</span><br><span class="line"></span><br><span class="line">Invalidates all objects in cache that match the expression with the ban mechanism.</span><br><span class="line"></span><br><span class="line">hash_data(input)</span><br><span class="line"></span><br><span class="line">Adds an input to the hash input. In the built-in VCL hash_data() is called on the host and URL of the request. Available in vcl_hash.</span><br><span class="line"></span><br><span class="line">rollback()</span><br><span class="line"></span><br><span class="line">Restore req HTTP headers to their original state. This function is deprecated. Use std.rollback() instead.</span><br><span class="line"></span><br><span class="line">synthetic(STRING)</span><br><span class="line"></span><br><span class="line">Prepare a synthetic response body containing the STRING. Available in vcl_synth and vcl_backend_error.</span><br><span class="line"></span><br><span class="line">regsub(str, regex, sub)</span><br><span class="line"></span><br><span class="line">Returns a copy of str with the first occurrence of the regular expression regex replaced with sub. Within sub, \0 (which can also be spelled \&amp;) is replaced with the entire matched string, and \n is replaced with the contents of subgroup n in the matched string.</span><br><span class="line"></span><br><span class="line">regsuball(str, regex, sub)</span><br><span class="line"></span><br><span class="line">As regsub() but this replaces all occurrences.</span><br></pre></td></tr></table></figure>

<h3 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h3><p>我们可以使用正则表达式进行字符模式的匹配, 例如这样的一个例子, 当用户访问某个特别的页面时, 即使我们存在缓存, 但是我还是不想让他调用缓存, 而是还是从后端服务器取得结果.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (req.url ~ <span class="string">&quot;^/test7.html$&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (pass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如这里, 我们使用一个<code>~</code>来声明下面的字符串是模式匹配, 这样造成的效果就是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-node1 conf]# curl -I 192.168.16.100:6081/test3.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 03:08:45 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 32776</span><br><span class="line">Age: 0</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: MISS of 192.168.16.100</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@VM-node1 conf]# curl -I 192.168.16.100:6081/test3.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 03:08:45 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 13 32777</span><br><span class="line">Age: 1</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: HIT from 192.168.16.100</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@VM-node1 conf]# curl -I 192.168.16.100:6081/test7.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 03:10:14 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 32784</span><br><span class="line">Age: 0</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: MISS of 192.168.16.100</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@VM-node1 conf]# curl -I 192.168.16.100:6081/test7.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 12 Sep 2018 03:10:15 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16</span><br><span class="line">Last-Modified: Wed, 12 Sep 2018 01:23:29 GMT</span><br><span class="line">ETag: &quot;22-575a2701b26a4&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 34</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">X-Varnish: 20</span><br><span class="line">Age: 0</span><br><span class="line">Via: 1.1 varnish-v4</span><br><span class="line">X-Cache: MISS of 192.168.16.100</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到效果了, 访问<code>test3.html</code>的时候一切正常, 但当我们访问到模式匹配的<code>test7</code>的时候, 就会一直pass了. 当然这只是对单文件的, 我们还可以对目录进行模式匹配, 从而达到对一个目录下的全部文件都跳过缓存.</p>
<p>另外, 我们还可以类似的方式取消一些特定资源的私有cookie标识, 例如某些公共的图片资源, 由于后台的应用服务器配置或者是后台程序的设定和代码存在问题导致这些图片的响应头部中被加入了<code>Set-Cookie</code>属性, 我么可以通过模式匹配找到这些文件然后清除掉这些头部, 来看一个示例吧.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (beresp.http.cache-control !~ <span class="string">&quot;s-maxage&quot;</span>) &#123; <span class="comment">//如果这个头部中的cache-control不包含s-max-age</span></span><br><span class="line">    <span class="keyword">if</span> (bereq.url ~ <span class="string">&quot;(?i)\.jpg$&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> beresp.ttl = <span class="number">3600</span>s;</span><br><span class="line">        unset beresp.http.Set-Cookie;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bereq.url ~ <span class="string">&quot;(?i)\.css$&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> beresp.ttl = <span class="number">600</span>s;</span><br><span class="line">        unset beresp.http.Set-Cookie;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// 当然这里如果通过设置flag的方式写会更加优雅一些不过算了</span></span><br></pre></td></tr></table></figure>

<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>我们之前就在说Varnish的时候说过, 这给东西同样支持负载均衡的设定, 这个设定需要一个我们之前没有说过的状态引擎 – <code>vcl_init</code></p>
<p>设定起来的样子就像这样: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vcl <span class="number">4.0</span>;</span><br><span class="line"></span><br><span class="line">backend b1 &#123;</span><br><span class="line">    .host = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    .port = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">backend b2 &#123;</span><br><span class="line">    .host = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    .port = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_init &#123;</span><br><span class="line">    new cluster = directors.round_robin();</span><br><span class="line">    cluster.addbackend(b1, <span class="number">1.0</span>);</span><br><span class="line">    cluster.addbackend(b2, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line">    <span class="built_in">set</span> req.backend_hint = cluster.backend(); 	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们使用轮询的算法来进行调度.</p>
<p>这里我们稍微的扩展一下对后端服务器的设定, 除了我们说过的<code>host</code>和<code>port</code>之外, 还有其他的一些, 官网的介绍在这里可以看到<a target="_blank" rel="noopener" href="https://varnish-cache.org/docs/4.1/reference/vcl.html#backend-definition">Backend-Definition</a>.</p>
<p>其中比较重要的是<code>probo</code>和<code>max_connections</code> 分别是对后端主机进行健康状态检测和并发连接的最大数量. 但是, 如果需要对后端主机进行健康状态检测, 我们是需要再来指定健康状态检测方式的, 通过使用<code>probe</code>块来指定:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">probe name &#123;</span><br><span class="line">    .attribute = <span class="string">&quot;value&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和指定后端服务器的方法十分类似, 这里也需要提供一个名字和它对应的属性有哪些. 至于这些属性, 在上面的介绍链接里就有, 大致包括一些, 阈值, 期待的状态码, 间隔时间, 超时时长, 请求的URL, 发出的请求是什么样子的等等.</p>
<p>现在我们就来小小的试一下, 现在我的后端服务器有两个, 分别是<code>192.168.16.101:8080</code>和<code>192.168.16.101:8888</code>. 这里就通过Apache HTTP服务器开启两个虚拟主机好了, 然后为了模拟第二台服务器挂掉的情况我打算通过修改防火墙规则来实现. 不知道可行不可行, 现在我就先去部署了哈哈.</p>
<p>OK, 现在的状态是, 我在一台主机上部署了web服务, 通过8080和8888两个端口来提供不同的Web服务. 现在我们通过配置Varnish来实现对后台两个服务的轮询访问和健康状态检查.</p>
<blockquote>
<p>稍微提示一下, Varnish4版本对于这些设定和之前的版本差别很大, 这里踩了很多坑才实现这么一个功能.为了能看到负载均衡效果, 你需要暂时跳过查找缓存的步骤, 这是因为如果请求的资源已经被缓存了, 就会等到缓存时间结束了之后才会进行负载均衡.</p>
<p>另外, 关于调度器的实现语法也已经有了很大的不同, 现在我们就来看一下.</p>
</blockquote>
<p>负载均衡和健康状态检测的效果实现配置在下面:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">backend webserver1 &#123;</span><br><span class="line">    .host = <span class="string">&quot;192.168.16.101&quot;</span>;</span><br><span class="line">    .port = <span class="string">&quot;8080&quot;</span>;</span><br><span class="line">    .probe = &#123;</span><br><span class="line">        .url = <span class="string">&quot;/index.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">backend webserver2 &#123;</span><br><span class="line">    .host = <span class="string">&quot;192.168.16.101&quot;</span>;</span><br><span class="line">    .port = <span class="string">&quot;8888&quot;</span>;</span><br><span class="line">    .probe = &#123;</span><br><span class="line">        .url = <span class="string">&quot;/index.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_init &#123;</span><br><span class="line">    new cluster = directors.round_robin();</span><br><span class="line">    cluster.add_backend(webserver1);</span><br><span class="line">    cluster.add_backend(webserver2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line">    <span class="built_in">set</span> req.backend_hint = cluster.backend();</span><br><span class="line">    <span class="keyword">if</span> (req.url ~ <span class="string">&quot;(?i)\.html$&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>(pass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里只是填写了必要的参数, 实现之后的效果就是在访问时候进行轮询切换, 除了<code>round_robin</code>算法, 同样可以使用<code>hash, random</code>等等. </p>
<p>这里访问时需要加上<code>/index.html</code>才可以达到轮询的效果, 这是因为只有这样才会达到if的条件判断, 进行下面的return语句, 才不会读取缓存.</p>
<p>看到这里, 你是不是觉得Varnish这样调度是没有意义的呀, 其实不是, 这里之所以先这样做, 是因为当我们持续访问<strong>同一个资源</strong>的时候, Varnish只会从一个位置的后端服务器去取资源, 但是如果向我们上面这样设定, 我们访问的<strong>同一个资源</strong>对于<code>Varnish</code>来说就是不同的资源了.</p>
<p>那么接下来我们再来做一个测试, 我们分别在两个backend server都生成test1-10页面, 来测试下效果.</p>
<p>测试效果就像这样子:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test1.html</span><br><span class="line">WebPage1 on Web1.</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test2.html</span><br><span class="line">WebPage2 on Web2.</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test3.html</span><br><span class="line">WebPage3 on Web1.</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test4.html</span><br><span class="line">WebPage4 on Web2.</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test3.html</span><br><span class="line">WebPage3 on Web1.</span><br><span class="line"></span><br><span class="line">C:\Users\lenovo\Desktop</span><br><span class="line">λ curl 192.168.16.100:6081/test2.html</span><br><span class="line">WebPage2 on Web2.</span><br></pre></td></tr></table></figure>

<p>如果是同一个资源, 由于命中了缓存, 所以自然得到的结果就会一致. 但是放来回访问不同的资源并且不是被缓存过的资源的话, 就会进行rr轮询了.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">Tags</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">状态引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VCL%E5%8F%82%E8%80%83"><span class="toc-number">2.</span> <span class="toc-text">VCL参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.</span> <span class="toc-text">变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bereq"><span class="toc-number">2.1.1.</span> <span class="toc-text">bereq</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#beresp"><span class="toc-number">2.1.2.</span> <span class="toc-text">beresp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#obj"><span class="toc-number">2.1.3.</span> <span class="toc-text">obj</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server"><span class="toc-number">2.1.4.</span> <span class="toc-text">Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">2.3.</span> <span class="toc-text">模式匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">负载均衡</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&text=Varnish的状态引擎和VCL"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&is_video=false&description=Varnish的状态引擎和VCL"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Varnish的状态引擎和VCL&body=Check out this article: https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&title=Varnish的状态引擎和VCL"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&name=Varnish的状态引擎和VCL&description=&lt;p&gt;接下来我们就来更加深入的来看一下Varnish的相关.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2018/09/10/Varnish%E7%9A%84%E7%8A%B6%E6%80%81%E5%BC%95%E6%93%8E%E5%92%8CVCL/&t=Varnish的状态引擎和VCL"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    Yaoxuan Wei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'yaoxuannn-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
