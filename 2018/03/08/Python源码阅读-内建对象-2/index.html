<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="这是《Python源码剖析 — 深度探索动态语言核心技术》的阅读记录. Python中的整数对象 - IntObject">
<meta property="og:type" content="article">
<meta property="og:title" content="Python源码阅读-内建对象(2)">
<meta property="og:url" content="https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/index.html">
<meta property="og:site_name" content="Yaoxuannn&#39;s Blog">
<meta property="og:description" content="这是《Python源码剖析 — 深度探索动态语言核心技术》的阅读记录. Python中的整数对象 - IntObject">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-03-09T01:34:07.000Z">
<meta property="article:modified_time" content="2020-11-30T01:24:55.000Z">
<meta property="article:author" content="Yaoxuan Wei">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Source Code">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Python源码阅读-内建对象(2)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-09NWQ40K0B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-09NWQ40K0B');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018/03/10/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-3/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2018/03/07/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-1/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&text=Python源码阅读-内建对象(2)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&is_video=false&description=Python源码阅读-内建对象(2)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python源码阅读-内建对象(2)&body=Check out this article: https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&name=Python源码阅读-内建对象(2)&description=&lt;p&gt;这是《Python源码剖析 — 深度探索动态语言核心技术》的阅读记录.&lt;/p&gt;
&lt;p&gt;Python中的整数对象 - &lt;code&gt;IntObject&lt;/code&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&t=Python源码阅读-内建对象(2)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#IntObject%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">IntObject对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAIntObject"><span class="toc-number">2.</span> <span class="toc-text">创建一个IntObject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%95%B4%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">小整数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%95%B4%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">大整数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">创建过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%B1%A0"><span class="toc-number">3.</span> <span class="toc-text">使用对象池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E6%95%B4%E6%95%B0%E5%AF%B9%E8%B1%A1%E6%B1%A0%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">小整数对象池的初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python%E6%95%B4%E6%95%B0%E5%AF%B9%E8%B1%A1%E7%BB%93%E8%AE%BA%E6%B5%8B%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">Python整数对象结论测试</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Python源码阅读-内建对象(2)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Yaoxuan Wei</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-03-09T01:34:07.000Z" class="dt-published" itemprop="datePublished">2018-03-08</time>
        
        (Updated: <time datetime="2020-11-30T01:24:55.000Z" class="dt-updated" itemprop="dateModified">2020-11-29</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Python/" rel="tag">Python</a>, <a class="p-category" href="/tags/Source-Code/" rel="tag">Source Code</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>这是《Python源码剖析 — 深度探索动态语言核心技术》的阅读记录.</p>
<p>Python中的整数对象 - <code>IntObject</code></p>
<span id="more"></span>

<h2 id="IntObject对象"><a href="#IntObject对象" class="headerlink" title="IntObject对象"></a>IntObject对象</h2><p>之前我们说过Python对象分成定长和不定长的两种, 其中不定长对象就是对定长对象的一个扩展. 除了这样划分, 我们还可以划分成可变对象和不可变对象, 本节的<code>IntObject</code>就是不可变对象.</p>
<p>在<code>intobject.h</code>中可以看到:</p>
<blockquote>
<p>PyIntObject represents a (long) integer.  This is an immutable object;<br>an integer cannot change its value after creation.</p>
</blockquote>
<p>一旦创建, 值就是不可变的.</p>
<p>但是我们知道啊, 一个简单的程序都会伴随的大量的整数的创建, 改变, 消灭. 要是这样看的话, 根据Python的引用计数的垃圾回收机制, 那系统的堆访问岂不是会访问炸了? 虽然你可能曾经了解过了, 对于这个, Python所使用的机制是使用一个整数对象池, 这个对象池其实就是用做缓冲之用. 这种缓冲池的应用, 除了<code>IntObject</code>, 在其他的不可变对象, 也是存在的.</p>
<p>还是来看代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PyTypeObject PyInt_Type = &#123;</span><br><span class="line">	PyObject_HEAD_INIT(&amp;PyType_Type)</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="string">&quot;int&quot;</span>,</span><br><span class="line">	<span class="keyword">sizeof</span>(PyIntObject),</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	(destructor)int_dealloc,		<span class="comment">/* tp_dealloc */</span></span><br><span class="line">	(printfunc)int_print,			<span class="comment">/* tp_print */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_getattr */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_setattr */</span></span><br><span class="line">	(cmpfunc)int_compare,			<span class="comment">/* tp_compare */</span></span><br><span class="line">	(reprfunc)int_repr,			<span class="comment">/* tp_repr */</span></span><br><span class="line">	&amp;int_as_number,				<span class="comment">/* tp_as_number */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_as_sequence */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_as_mapping */</span></span><br><span class="line">	(hashfunc)int_hash,			<span class="comment">/* tp_hash */</span></span><br><span class="line">        <span class="number">0</span>,					<span class="comment">/* tp_call */</span></span><br><span class="line">        (reprfunc)int_repr,			<span class="comment">/* tp_str */</span></span><br><span class="line">	PyObject_GenericGetAttr,		<span class="comment">/* tp_getattro */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_setattro */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_as_buffer */</span></span><br><span class="line">	Py_TPFLAGS_DEFAULT | Py_TPFLAGS_CHECKTYPES |</span><br><span class="line">		Py_TPFLAGS_BASETYPE,		<span class="comment">/* tp_flags */</span></span><br><span class="line">	int_doc,				<span class="comment">/* tp_doc */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_traverse */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_clear */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_richcompare */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_weaklistoffset */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_iter */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_iternext */</span></span><br><span class="line">	int_methods,				<span class="comment">/* tp_methods */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_members */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_getset */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_base */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_dict */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_descr_get */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_descr_set */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_dictoffset */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_init */</span></span><br><span class="line">	<span class="number">0</span>,					<span class="comment">/* tp_alloc */</span></span><br><span class="line">	int_new,				<span class="comment">/* tp_new */</span></span><br><span class="line">	(freefunc)int_free,           		<span class="comment">/* tp_free */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当我们把所有没有定义的属性移走之后, 剩下的就是:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PyTypeObject PyInt_Type = &#123;</span><br><span class="line">	...</span><br><span class="line">	(destructor)int_dealloc,		<span class="comment">/* tp_dealloc */</span></span><br><span class="line">	(printfunc)int_print,			<span class="comment">/* tp_print */</span></span><br><span class="line">	...</span><br><span class="line">	(cmpfunc)int_compare,			<span class="comment">/* tp_compare */</span></span><br><span class="line">	(reprfunc)int_repr,			<span class="comment">/* tp_repr */</span></span><br><span class="line">	&amp;int_as_number,				<span class="comment">/* tp_as_number */</span></span><br><span class="line">	...</span><br><span class="line">	(hashfunc)int_hash,			<span class="comment">/* tp_hash */</span></span><br><span class="line">	...</span><br><span class="line">    (reprfunc)int_repr,			<span class="comment">/* tp_str */</span></span><br><span class="line">	PyObject_GenericGetAttr,		<span class="comment">/* tp_getattro */</span></span><br><span class="line">	...</span><br><span class="line">	Py_TPFLAGS_DEFAULT | Py_TPFLAGS_CHECKTYPES |</span><br><span class="line">		Py_TPFLAGS_BASETYPE,		<span class="comment">/* tp_flags */</span></span><br><span class="line">	int_doc,				<span class="comment">/* tp_doc */</span></span><br><span class="line">	...</span><br><span class="line">	int_methods,				<span class="comment">/* tp_methods */</span></span><br><span class="line">	...</span><br><span class="line">	int_new,				<span class="comment">/* tp_new */</span></span><br><span class="line">	(freefunc)int_free,           		<span class="comment">/* tp_free */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们先来看看是怎么比较两个<code>IntObject</code>的大小的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">int_compare</span><span class="params">(PyIntObject *v, PyIntObject *w)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">long</span> i = v-&gt;ob_ival;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">long</span> j = w-&gt;ob_ival;</span><br><span class="line">	<span class="keyword">return</span> (i &lt; j) ? <span class="number">-1</span> : (i &gt; j) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是简单的比较两个long数值. 是吧, 其实也没那么难.</p>
<p>但是我们要关注的其实是这个: <code>&amp;int_as_number</code>. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyNumberMethods int_as_number = &#123;</span><br><span class="line">	(binaryfunc)int_add,	<span class="comment">/*nb_add*/</span></span><br><span class="line">	(binaryfunc)int_sub,	<span class="comment">/*nb_subtract*/</span></span><br><span class="line">	(binaryfunc)int_mul,	<span class="comment">/*nb_multiply*/</span></span><br><span class="line">	(binaryfunc)int_classic_div, <span class="comment">/*nb_divide*/</span></span><br><span class="line">	(binaryfunc)int_mod,	<span class="comment">/*nb_remainder*/</span></span><br><span class="line">	(binaryfunc)int_divmod,	<span class="comment">/*nb_divmod*/</span></span><br><span class="line">	(ternaryfunc)int_pow,	<span class="comment">/*nb_power*/</span></span><br><span class="line">    ....(omitted)</span><br></pre></td></tr></table></figure>

<p>这些就是函数指针就是整数对象所支持的函数方法, 其实也没有把所有的函数都实现, 但大部分都实现的了, 我们还是随便挑一个来看:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject *</span><br><span class="line"><span class="title function_">int_add</span><span class="params">(PyIntObject *v, PyIntObject *w)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">long</span> a, b, x;</span><br><span class="line">	CONVERT_TO_LONG(v, a);</span><br><span class="line">	CONVERT_TO_LONG(w, b);</span><br><span class="line">	x = a + b;</span><br><span class="line">	<span class="keyword">if</span> ((x^a) &gt;= <span class="number">0</span> || (x^b) &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> PyInt_FromLong(x);</span><br><span class="line">	<span class="keyword">return</span> PyLong_Type.tp_as_number-&gt;nb_add((PyObject *)v, (PyObject *)w);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先就是先规范类型接着进行关键的加法运算, 接着判断是否出现加法溢出, 如果没有直接返回新的IntObject, 如果溢出就使用LongObject了, 这个就先不考虑了.  有趣的是这个<code>CONVERT_TO_LONG</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONVERT_TO_LONG(obj, lng)		\</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (PyInt_Check(obj)) &#123;			\</span></span><br><span class="line"><span class="meta">		lng = PyInt_AS_LONG(obj);	\</span></span><br><span class="line"><span class="meta">	&#125;					\</span></span><br><span class="line"><span class="meta">	<span class="keyword">else</span> &#123;					\</span></span><br><span class="line"><span class="meta">		Py_INCREF(Py_NotImplemented);	\</span></span><br><span class="line"><span class="meta">		return Py_NotImplemented;	\</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br></pre></td></tr></table></figure>

<p>这是一个宏, 其中又使用了一个宏:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Macro, trading safety for speed */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyInt_AS_LONG(op) (((PyIntObject *)(op))-&gt;ob_ival)</span></span><br></pre></td></tr></table></figure>

<p>这个宏上面的注释说用安全交换速度. 安全指的就是类型安全啦, 而在<code>intobject.c</code>中, 还有一个函数版本的转换函数: <code>PyInt_AsLong</code>. 这个函数就考虑的较多了, 更加安全. 当然了 这样的代价就是速度.</p>
<p>稍微向<code>int_as_number</code>的上面看看:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PyDoc_STRVAR(int_doc,</span><br><span class="line"><span class="string">&quot;int(x[, base]) -&gt; integer\n\</span></span><br><span class="line"><span class="string">\n\</span></span><br><span class="line"><span class="string">Convert a string or number to an integer, if possible.  A floating point\n\</span></span><br><span class="line"><span class="string">argument will be truncated towards zero (this does not include a string\n\</span></span><br><span class="line"><span class="string">representation of a floating point number!)  When converting a string, use\n\</span></span><br><span class="line"><span class="string">the optional base.  It is an error to supply a base when converting a\n\</span></span><br><span class="line"><span class="string">non-string. If the argument is outside the integer range a long object\n\</span></span><br><span class="line"><span class="string">will be returned instead.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>嚯, 这不就是我们在Python Shell中看的文档吗! 所以现在我们就知道了, Python直接将她的文档集成在语言的实现中 关于这个宏的定义, 出现在整个Python实现的元头文件(Python.h):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Define macros for inline documentation. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyDoc_VAR(name) static char name[]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyDoc_STRVAR(name,str) PyDoc_VAR(name) = PyDoc_STR(str)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WITH_DOC_STRINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyDoc_STR(str) str</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyDoc_STR(str) <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="创建一个IntObject"><a href="#创建一个IntObject" class="headerlink" title="创建一个IntObject"></a>创建一个IntObject</h2><p>现在就让我们来了解下Python对整数对象设计的缓冲池是怎样的. 我们已经知道Python对小整数对象设计了一个对象池. 现在提出三个问题:</p>
<ul>
<li>什么样的整数属于小整数?</li>
<li>对象池怎么实现的?</li>
<li>大整数怎么办?</li>
</ul>
<p>接下来我们就来回答这些, 在正式开启之前, 我们还是先来了解下一个IntObject创建方式有哪些.</p>
<p>在头文件中, 我们可以找到函数声明:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PyAPI_FUNC(PyObject *) PyInt_FromString(<span class="type">char</span>*, <span class="type">char</span>**, <span class="type">int</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Py_USING_UNICODE</span></span><br><span class="line">PyAPI_FUNC(PyObject *) PyInt_FromUnicode(Py_UNICODE*, Py_ssize_t, <span class="type">int</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">PyAPI_FUNC(PyObject *) PyInt_FromLong(<span class="type">long</span>);</span><br><span class="line">PyAPI_FUNC(PyObject *) PyInt_FromSize_t(<span class="type">size_t</span>);</span><br><span class="line">PyAPI_FUNC(PyObject *) PyInt_FromSsize_t(Py_ssize_t);</span><br></pre></td></tr></table></figure>

<p>至于具体他们的实现 当然是可以在c文件中找到, 但是 只有了解到Python的整数对象在内存中的表现形式, 才可以去理解.</p>
<p>现在就来回答上面的三个问题, 首先第1问.</p>
<h3 id="小整数"><a href="#小整数" class="headerlink" title="小整数"></a>小整数</h3><p>什么样的整数才算小的? 这个当然是取决于使用场景. 在Python的世界中, 默认的小整数范围是从**<code>[-5, 257)</code>**的. 由于使用场景不同, 这个值是可以进行更改的, 在这里(intobject.c):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NSMALLPOSINTS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NSMALLPOSINTS		257</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NSMALLNEGINTS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NSMALLNEGINTS		5</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> NSMALLNEGINTS + NSMALLPOSINTS &gt; 0</span></span><br><span class="line"><span class="comment">/* References to small integers are saved in this array so that they</span></span><br><span class="line"><span class="comment">   can be shared.</span></span><br><span class="line"><span class="comment">   The integers that are saved are those in the range</span></span><br><span class="line"><span class="comment">   -NSMALLNEGINTS (inclusive) to NSMALLPOSINTS (not inclusive).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> PyIntObject *small_ints[NSMALLNEGINTS + NSMALLPOSINTS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>也就是说, 你只要修改这两个宏所对应的值, 就可以实现自己定义小整数范围.  只要判断条件通过就会激活这个对象池, 也就是这个静态的<code>PyIntObject</code>数组.</p>
<h3 id="大整数"><a href="#大整数" class="headerlink" title="大整数"></a>大整数</h3><p>小整数的范围就这样了, 但是大整数不是说就不怎么使用了啊? 那怎么办? Python官方在空间和时间上做了平衡之后得到的解决方法是 - 提供一个单独的内存空间用来除了上面定义的小整数之外的整数使用. 这个内存空间就是一个新的结构, <code>_intblock</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE	1000	<span class="comment">/* 1K less typical malloc overhead */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BHEAD_SIZE	8	<span class="comment">/* Enough for a 64-bit pointer */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_INTOBJECTS	((BLOCK_SIZE - BHEAD_SIZE) / sizeof(PyIntObject))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">intblock</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">intblock</span> *<span class="title">next</span>;</span></span><br><span class="line">	PyIntObject objects[N_INTOBJECTS];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">intblock</span> <span class="title">PyIntBlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyIntBlock *block_list = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> PyIntObject *free_list = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><em>一个小疑问, 这里为啥不写在一起? 直接typedef不就行了? 可能只是代码风格问题吧</em></p>
<p>当然, 这么一个空间也是可以动态调整的, 只要修改之后重新编译一下就好了.</p>
<p>这就是装着整数对象的单向链表, 而<code>free_list</code>就是一开始指向这个链表表头的指针, 随着程序移动. 到了这里, 我们的这个小标题其实可以做个更改了, 它更应该叫做<strong>通用整数</strong>.</p>
<h3 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h3><p>行了, 我们现在就开始看创建函数吧:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PyObject *</span><br><span class="line"><span class="title function_">PyInt_FromLong</span><span class="params">(<span class="type">long</span> ival)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> PyIntObject *v;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> NSMALLNEGINTS + NSMALLPOSINTS &gt; 0</span></span><br><span class="line">	<span class="keyword">if</span> (-NSMALLNEGINTS &lt;= ival &amp;&amp; ival &lt; NSMALLPOSINTS) &#123;</span><br><span class="line">		v = small_ints[ival + NSMALLNEGINTS];</span><br><span class="line">		Py_INCREF(v);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> COUNT_ALLOCS</span></span><br><span class="line">		<span class="keyword">if</span> (ival &gt;= <span class="number">0</span>)</span><br><span class="line">			quick_int_allocs++;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			quick_neg_int_allocs++;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span> (PyObject *) v;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">#################我自己的分割线#####################<span class="meta">#</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (free_list == NULL) &#123;</span></span><br><span class="line">		<span class="keyword">if</span> ((free_list = fill_free_list()) == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Inline PyObject_New */</span></span><br><span class="line">	v = free_list;</span><br><span class="line">	free_list = (PyIntObject *)v-&gt;ob_type;</span><br><span class="line">	PyObject_INIT(v, &amp;PyInt_Type);</span><br><span class="line">	v-&gt;ob_ival = ival;</span><br><span class="line">	<span class="keyword">return</span> (PyObject *) v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出来, 如果小整数的对象池被激活并且需要创建的整数对象就在对象池里面, 那么就会直接从那里面取出来用. 这就很简单了, 但是如果不是在里面或者对象池没有被激活, 那么就会走下面的函数过程了. 来分析下:</p>
<p>如果当前还没有分配, 就先创建我们的int block. 这个行为不仅出现在最一开始的<code>fill_free_list</code>调用上, 在所有的空闲内存(for intblock)没有的时候, free_list会重新变成NULL, 那个时候调用<code>fill_free_list</code>就又会进行分配了.</p>
<p>这个创建的过程是这样的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyIntObject *</span><br><span class="line"><span class="title function_">fill_free_list</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	PyIntObject *p, *q;</span><br><span class="line">	<span class="comment">/* Python&#x27;s object allocator isn&#x27;t appropriate for large blocks. */</span></span><br><span class="line">	p = (PyIntObject *) PyMem_MALLOC(<span class="keyword">sizeof</span>(PyIntBlock));</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> (PyIntObject *) PyErr_NoMemory();</span><br><span class="line">	((PyIntBlock *)p)-&gt;next = block_list;</span><br><span class="line">	block_list = (PyIntBlock *)p;</span><br><span class="line">	<span class="comment">/* Link the int objects together, from rear to front, then return</span></span><br><span class="line"><span class="comment">	   the address of the last int object in the block. */</span></span><br><span class="line">	p = &amp;((PyIntBlock *)p)-&gt;objects[<span class="number">0</span>];</span><br><span class="line">	q = p + N_INTOBJECTS;</span><br><span class="line">	<span class="keyword">while</span> (--q &gt; p)</span><br><span class="line">		q-&gt;ob_type = (<span class="keyword">struct</span> _typeobject *)(q<span class="number">-1</span>);</span><br><span class="line">	q-&gt;ob_type = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> p + N_INTOBJECTS - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先分配整个通用整数对象池的内存空间, 如果malloc失败, 报错处理. 如果malloc成功就可以继续了, 先忽略掉后面的那两行 我们来看注释下面的. 接下来, 我们把IntObject数组的第一个元素贴到这个内存区域的头部, 把另一个指针q调整到这个对象池的最末尾+1的位置, 此时p指针指向头部第一个元素(也就是objects[0]). Then, 开始从后向前的移动q指针, 每一次移动都把对象池后面的那个整数对象的ob_type指向它前一个整数对象的ob_type直到q指针和p指针碰面, 也就是同时指向首位. 接着将第一个整数对象的ob_type设置成NULL. 这样就算是完成了, 最后返回这个对象池的最后一个元素的内存地址.</p>
<p>看到这里, 你可能会觉得有点疑惑, 尤其是ob_type那里, 为什么要这么做呢? 别急, 让我们继续往下看, 你会发现这一段代码的巧妙之处.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Inline PyObject_New */</span></span><br><span class="line">v = free_list;</span><br><span class="line">free_list = (PyIntObject *)v-&gt;ob_type;</span><br><span class="line">PyObject_INIT(v, &amp;PyInt_Type);</span><br><span class="line">v-&gt;ob_ival = ival;</span><br><span class="line"><span class="keyword">return</span> (PyObject *) v;</span><br></pre></td></tr></table></figure>

<p>之前在说对象池的时候就介绍过了, free_list相当于是对象池的对象指针, 那么每一次返回一个整数, 我们都需要把这个指针进行移动. 那么如何进行移动呢? 看上面的代码就可以知道了: <strong>我们只需要把ob_type传递给free_list就行了.</strong> </p>
<p>怎么样 是不是十分巧妙 数组中的每一个元素通过这个ob_type属性就这样巧妙的串起来了!</p>
<p>接着我们想象一下, 这个对象池一直在被填充直到free_list指针指向了最前面 也就是刚刚的<code>object[0]</code>的位置. 这个地方的ob_type是NULL! 没错, 此时就认为是对象池满了, 那怎么办? 当然是重新激活一个新的通用整数对象池了.</p>
<p>那原来的对象池怎么处理呢? 这就是之前我们忽略过去的那两行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">((PyIntBlock *)p)-&gt;next = block_list;</span><br><span class="line">block_list = (PyIntBlock *)p;</span><br></pre></td></tr></table></figure>

<p>这就是在把原来的整数对象池连接到了新的对象池的后面.</p>
<h2 id="使用对象池"><a href="#使用对象池" class="headerlink" title="使用对象池"></a>使用对象池</h2><p>好了, 现在我们已经清楚整数对象是怎么被创造出来的. 接下来来考虑这么一个问题: 如果说现在有两个对象池, 第一个已经被填满了, 第二个尚有空间. 在这个时候第一个对象池有IntObject被删掉了, 也就是流出了一个空闲内存. 那么我该怎么知道并且在下一次创建的时候使用到这个空间呢? 我们来看看析构函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">int_dealloc</span><span class="params">(PyIntObject *v)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (PyInt_CheckExact(v)) &#123;</span><br><span class="line">		v-&gt;ob_type = (<span class="keyword">struct</span> _typeobject *)free_list;</span><br><span class="line">		free_list = v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		v-&gt;ob_type-&gt;tp_free((PyObject *)v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的判断宏其实就是在看传入的Object的ob_type是不是PyInt_Type, 先不管他. 来看后面, Python将这个被删除的对象连接到了由ob_type作为指针所连接的链表上.接着再把这个表示下一个空闲内存的指针移动到了这里. 就是十分的自然!</p>
<p>如果不是整数类型, 就会调用那个对象所指向的tp_free方法了.</p>
<h2 id="小整数对象池的初始化"><a href="#小整数对象池的初始化" class="headerlink" title="小整数对象池的初始化"></a>小整数对象池的初始化</h2><p>小整数对象池又是怎么被初始化的呢, 答案就在初始化函数中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_PyInt_Init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	PyIntObject *v;</span><br><span class="line">	<span class="type">int</span> ival;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> NSMALLNEGINTS + NSMALLPOSINTS &gt; 0</span></span><br><span class="line">	<span class="keyword">for</span> (ival = -NSMALLNEGINTS; ival &lt; NSMALLPOSINTS; ival++) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!free_list &amp;&amp; (free_list = fill_free_list()) == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">/* PyObject_New is inlined */</span></span><br><span class="line">		v = free_list;</span><br><span class="line">		free_list = (PyIntObject *)v-&gt;ob_type;</span><br><span class="line">		PyObject_INIT(v, &amp;PyInt_Type);</span><br><span class="line">		v-&gt;ob_ival = ival;</span><br><span class="line">		small_ints[ival + NSMALLNEGINTS] = v;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到基本过程和上面的创建通用整数对象池十分相像. 只不过这里是具体的数值了.</p>
<h2 id="Python整数对象结论测试"><a href="#Python整数对象结论测试" class="headerlink" title="Python整数对象结论测试"></a>Python整数对象结论测试</h2><p>学完了这一节, 到底是不是这样呢? 我们来实际上做个测试: 修改源代码重新编译, 看看到底是怎样的.</p>
<p>主要的修改目标就是打印函数, 输出更多信息来使得我们了解到底层:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a = <span class="type">int</span>(<span class="number">-1234</span>)</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">Address of <span class="number">-1234</span>: <span class="number">0x14f1408</span></span><br><span class="line">Address of free_list: <span class="number">0x14f1438</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; b = <span class="type">int</span>(<span class="number">-123</span>)</span><br><span class="line">&gt;&gt;&gt; b</span><br><span class="line">Address of <span class="number">-123</span>: <span class="number">0x14f1438</span></span><br><span class="line">Address of free_list: <span class="number">0x14f1420</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; del b</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">Address of <span class="number">-1234</span>: <span class="number">0x14f1408</span></span><br><span class="line">Address of free_list: <span class="number">0x14f1438</span></span><br></pre></td></tr></table></figure>

<p>这就是我们修改源码编译之后的效果, 可以看到事实就是如此, b的内存位置就是a的free_list的位置, 而当我们删除b了之后, 空闲指针又重新指向了b缺失的位置.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/tags/">Tags</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#IntObject%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">IntObject对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAIntObject"><span class="toc-number">2.</span> <span class="toc-text">创建一个IntObject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%95%B4%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">小整数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%95%B4%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">大整数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">创建过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%B1%A0"><span class="toc-number">3.</span> <span class="toc-text">使用对象池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E6%95%B4%E6%95%B0%E5%AF%B9%E8%B1%A1%E6%B1%A0%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">小整数对象池的初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python%E6%95%B4%E6%95%B0%E5%AF%B9%E8%B1%A1%E7%BB%93%E8%AE%BA%E6%B5%8B%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">Python整数对象结论测试</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&text=Python源码阅读-内建对象(2)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&is_video=false&description=Python源码阅读-内建对象(2)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python源码阅读-内建对象(2)&body=Check out this article: https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&title=Python源码阅读-内建对象(2)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&name=Python源码阅读-内建对象(2)&description=&lt;p&gt;这是《Python源码剖析 — 深度探索动态语言核心技术》的阅读记录.&lt;/p&gt;
&lt;p&gt;Python中的整数对象 - &lt;code&gt;IntObject&lt;/code&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://19971122.xyz/2018/03/08/Python%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%86%85%E5%BB%BA%E5%AF%B9%E8%B1%A1-2/&t=Python源码阅读-内建对象(2)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    Yaoxuan Wei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'yaoxuannn-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
